<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Storage con Autenticación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .button {
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .status-card.connected {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .status-card.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #D4AF37;
            background: #fafafa;
        }
        
        .upload-area.dragover {
            border-color: #D4AF37;
            background: #fff8dc;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .success { color: #155724; background: #d4edda; padding: 3px 6px; border-radius: 3px; }
        .error { color: #721c24; background: #f8d7da; padding: 3px 6px; border-radius: 3px; }
        .warning { color: #856404; background: #fff3cd; padding: 3px 6px; border-radius: 3px; }
        .info { color: #0c5460; background: #d1ecf1; padding: 3px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Test Storage con Autenticación</h1>
            <p>Prueba del sistema de almacenamiento autenticado</p>
        </div>

        <!-- Estado de autenticación -->
        <div class="section">
            <h2><i class="fas fa-user-check"></i> Estado de Autenticación</h2>
            <div id="authStatus" class="status-card">
                <i class="fas fa-spinner fa-spin"></i> Verificando autenticación...
            </div>
            
            <div id="loginForm" style="display: none;">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="admin@example.com" value="admin@artesan.com">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" placeholder="Tu contraseña" value="admin123">
                </div>
                <button class="button" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </div>
            
            <button class="button success" onclick="checkAuth()" id="checkAuthBtn">
                <i class="fas fa-refresh"></i> Verificar Estado
            </button>
            <button class="button danger" onclick="logout()" id="logoutBtn" style="display: none;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>

        <!-- Test de subida -->
        <div class="section">
            <h2><i class="fas fa-cloud-upload-alt"></i> Test de Subida</h2>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                <h3>Haz click aquí o arrastra archivos</h3>
                <p>Formatos soportados: JPG, PNG, WebP, GIF (máx. 5MB)</p>
                <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileSelect(this.files)">
            </div>
            
            <div style="margin: 20px 0;">
                <button class="button" onclick="uploadTestImage()">
                    <i class="fas fa-vial"></i> Subir Imagen de Prueba
                </button>
                <button class="button" onclick="listStorageFiles()">
                    <i class="fas fa-list"></i> Listar Archivos
                </button>
                <button class="button danger" onclick="cleanupTestFiles()">
                    <i class="fas fa-trash"></i> Limpiar Archivos de Prueba
                </button>
            </div>
            
            <div id="uploadLog" class="log"></div>
        </div>

        <!-- Archivos subidos -->
        <div class="section">
            <h2><i class="fas fa-images"></i> Archivos en Storage</h2>
            <div id="filesList" class="log" style="height: 300px;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script>
        let supabase;
        let currentUser = null;
        
        // Inicializar Supabase
        function initSupabase() {
            if (window.SUPABASE_CONFIG) {
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );
                return true;
            }
            return false;
        }
        
        // Función de logging
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Verificar autenticación
        async function checkAuth() {
            if (!supabase) {
                if (!initSupabase()) {
                    updateAuthStatus('Error: No se pudo conectar a Supabase', 'error');
                    return false;
                }
            }
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    updateAuthStatus('Error de autenticación: ' + error.message, 'error');
                    showLoginForm(true);
                    return false;
                }
                
                if (user) {
                    currentUser = user;
                    updateAuthStatus(`✅ Autenticado como: ${user.email}`, 'connected');
                    showLoginForm(false);
                    return true;
                } else {
                    updateAuthStatus('❌ No autenticado', 'error');
                    showLoginForm(true);
                    return false;
                }
            } catch (error) {
                updateAuthStatus('Error inesperado: ' + error.message, 'error');
                return false;
            }
        }
        
        // Actualizar estado de autenticación
        function updateAuthStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.className = `status-card ${type}`;
            
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.display = type === 'connected' ? 'inline-block' : 'none';
        }
        
        // Mostrar/ocultar formulario de login
        function showLoginForm(show) {
            document.getElementById('loginForm').style.display = show ? 'block' : 'none';
        }
        
        // Iniciar sesión
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                updateAuthStatus('Por favor ingresa email y contraseña', 'error');
                return;
            }
            
            updateAuthStatus('Iniciando sesión...', 'info');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    updateAuthStatus('Error al iniciar sesión: ' + error.message, 'error');
                } else {
                    currentUser = data.user;
                    updateAuthStatus(`✅ Sesión iniciada como: ${data.user.email}`, 'connected');
                    showLoginForm(false);
                }
            } catch (error) {
                updateAuthStatus('Error inesperado en login: ' + error.message, 'error');
            }
        }
        
        // Cerrar sesión
        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                updateAuthStatus('❌ Sesión cerrada', 'error');
                showLoginForm(true);
            } catch (error) {
                updateAuthStatus('Error al cerrar sesión: ' + error.message, 'error');
            }
        }
        
        // Subir imagen de prueba
        async function uploadTestImage() {
            const logId = 'uploadLog';
            
            if (!currentUser) {
                log(logId, 'Error: Debes estar autenticado para subir archivos', 'error');
                return;
            }
            
            log(logId, 'Creando imagen de prueba...', 'info');
            
            try {
                // Crear imagen de prueba más grande y visible
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Crear gradiente
                const gradient = ctx.createLinearGradient(0, 0, 200, 200);
                gradient.addColorStop(0, '#D4AF37');
                gradient.addColorStop(1, '#B8941F');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 200, 200);
                
                // Agregar texto
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('TEST', 100, 80);
                ctx.fillText(new Date().toLocaleTimeString(), 100, 120);
                ctx.fillText('Estudio Artesana', 100, 160);
                
                // Convertir a blob
                canvas.toBlob(async (blob) => {
                    const fileName = `test/test-${Date.now()}.png`;
                    
                    log(logId, `Subiendo ${fileName}...`, 'info');
                    
                    const { data, error } = await supabase.storage
                        .from('product-images')
                        .upload(fileName, blob, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        log(logId, `❌ Error subiendo: ${error.message}`, 'error');
                        log(logId, `Detalles del error: ${JSON.stringify(error)}`, 'error');
                    } else {
                        log(logId, `✅ Archivo subido: ${data.path}`, 'success');
                        
                        // Obtener URL pública
                        const { data: { publicUrl } } = supabase.storage
                            .from('product-images')
                            .getPublicUrl(data.path);
                        
                        log(logId, `🔗 URL pública: ${publicUrl}`, 'info');
                        
                        // Actualizar lista de archivos
                        setTimeout(() => listStorageFiles(), 1000);
                    }
                }, 'image/png');
                
            } catch (error) {
                log(logId, `Error creando imagen: ${error.message}`, 'error');
            }
        }
        
        // Manejar selección de archivos
        async function handleFileSelect(files) {
            const logId = 'uploadLog';
            
            if (!currentUser) {
                log(logId, 'Error: Debes estar autenticado para subir archivos', 'error');
                return;
            }
            
            if (!files || files.length === 0) return;
            
            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    log(logId, `❌ ${file.name} no es una imagen válida`, 'error');
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    log(logId, `❌ ${file.name} es demasiado grande (máx. 5MB)`, 'error');
                    continue;
                }
                
                log(logId, `📤 Subiendo ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)...`, 'info');
                
                const fileName = `uploads/${Date.now()}-${file.name}`;
                
                const { data, error } = await supabase.storage
                    .from('product-images')
                    .upload(fileName, file);
                
                if (error) {
                    log(logId, `❌ Error subiendo ${file.name}: ${error.message}`, 'error');
                } else {
                    log(logId, `✅ ${file.name} subido exitosamente`, 'success');
                    
                    const { data: { publicUrl } } = supabase.storage
                        .from('product-images')
                        .getPublicUrl(data.path);
                    
                    log(logId, `🔗 URL: ${publicUrl}`, 'info');
                }
            }
            
            // Actualizar lista
            setTimeout(() => listStorageFiles(), 1000);
        }
        
        // Listar archivos en storage
        async function listStorageFiles() {
            const logId = 'filesList';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'Listando archivos en storage...', 'info');
            
            try {
                const { data, error } = await supabase.storage
                    .from('product-images')
                    .list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
                
                if (error) {
                    log(logId, `Error listando archivos: ${error.message}`, 'error');
                    return;
                }
                
                if (!data || data.length === 0) {
                    log(logId, 'No hay archivos en el storage', 'info');
                    return;
                }
                
                log(logId, `Encontrados ${data.length} archivos:`, 'success');
                
                for (let file of data) {
                    const { data: { publicUrl } } = supabase.storage
                        .from('product-images')
                        .getPublicUrl(file.name);
                    
                    const sizeKB = (file.metadata?.size / 1024).toFixed(2) || 'N/A';
                    log(logId, `📁 ${file.name} (${sizeKB}KB) - ${publicUrl}`, 'info');
                }
                
                // Listar también subcarpetas
                const folders = ['test', 'uploads', 'products'];
                for (let folder of folders) {
                    const { data: folderData } = await supabase.storage
                        .from('product-images')
                        .list(folder, { limit: 50 });
                    
                    if (folderData && folderData.length > 0) {
                        log(logId, `📂 Carpeta ${folder}: ${folderData.length} archivos`, 'info');
                        for (let file of folderData) {
                            const { data: { publicUrl } } = supabase.storage
                                .from('product-images')
                                .getPublicUrl(`${folder}/${file.name}`);
                            log(logId, `  📄 ${file.name} - ${publicUrl}`, 'info');
                        }
                    }
                }
                
            } catch (error) {
                log(logId, `Error inesperado: ${error.message}`, 'error');
            }
        }
        
        // Limpiar archivos de prueba
        async function cleanupTestFiles() {
            const logId = 'uploadLog';
            
            if (!currentUser) {
                log(logId, 'Error: Debes estar autenticado', 'error');
                return;
            }
            
            log(logId, 'Limpiando archivos de prueba...', 'info');
            
            try {
                // Limpiar carpeta test
                const { data: testFiles } = await supabase.storage
                    .from('product-images')
                    .list('test', { limit: 100 });
                
                if (testFiles && testFiles.length > 0) {
                    const filesToDelete = testFiles.map(file => `test/${file.name}`);
                    const { error } = await supabase.storage
                        .from('product-images')
                        .remove(filesToDelete);
                    
                    if (error) {
                        log(logId, `Error eliminando archivos de prueba: ${error.message}`, 'error');
                    } else {
                        log(logId, `✅ ${filesToDelete.length} archivos de prueba eliminados`, 'success');
                    }
                }
                
                // Limpiar carpeta uploads
                const { data: uploadFiles } = await supabase.storage
                    .from('product-images')
                    .list('uploads', { limit: 100 });
                
                if (uploadFiles && uploadFiles.length > 0) {
                    const filesToDelete = uploadFiles.map(file => `uploads/${file.name}`);
                    const { error } = await supabase.storage
                        .from('product-images')
                        .remove(filesToDelete);
                    
                    if (error) {
                        log(logId, `Error eliminando uploads: ${error.message}`, 'error');
                    } else {
                        log(logId, `✅ ${filesToDelete.length} uploads eliminados`, 'success');
                    }
                }
                
                // Actualizar lista
                setTimeout(() => listStorageFiles(), 1000);
                
            } catch (error) {
                log(logId, `Error en limpieza: ${error.message}`, 'error');
            }
        }
        
        // Configurar drag & drop
        function setupDragDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });
        }
        
        // Inicializar al cargar
        window.addEventListener('load', async function() {
            if (initSupabase()) {
                await checkAuth();
                setupDragDrop();
                
                // Verificar estado de autenticación cada 30 segundos
                setInterval(checkAuth, 30000);
            }
        });
    </script>
</body>
</html>
