<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Inventario Completo - Estudio Artesana</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .panel-header {
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }

        .panel-title {
            font-size: 2rem;
            font-weight: 300;
        }

        .panel-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 600;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Action Buttons */
        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: #000;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Search and Filters */
        .filters-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 200px;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-weight: 500;
            color: #555;
        }

        .filter-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #C0C0C0;
            box-shadow: 0 0 0 3px rgba(192, 192, 192, 0.1);
        }

        /* Products Table */
        .products-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .products-header {
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .products-title {
            font-size: 1.4rem;
            font-weight: 500;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table th,
        .products-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .product-row {
            transition: background-color 0.3s ease;
        }

        .product-row:hover {
            background: #f8f9fa;
        }

        .product-main {
            font-weight: 500;
            color: #2c3e50;
        }

        .product-price {
            font-weight: 500;
            color: #28a745;
        }

        .stock-total {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .stock-high { background: #d4edda; color: #155724; }
        .stock-medium { background: #fff3cd; color: #856404; }
        .stock-low { background: #f8d7da; color: #721c24; }
        .stock-out { background: #f8d7da; color: #721c24; }

        /* Product Image */
        .product-image {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Variants */
        .variants-container {
            margin-top: 10px;
        }

        .variant-row {
            padding: 8px 0;
            padding-left: 20px;
            border-left: 3px solid #C0C0C0;
            margin-left: 10px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .variant-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .variant-name {
            font-weight: 500;
            color: #495057;
        }

        .variant-sku {
            color: #6c757d;
            font-size: 0.85rem;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .variant-stock-input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .variant-actions {
            display: flex;
            gap: 5px;
        }

        /* Toggle Button */
        .toggle-variants {
            background: none;
            border: none;
            color: #C0C0C0;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .toggle-variants:hover {
            background: #f0f0f0;
        }

        /* Removed rotation - now using proper up/down arrow icons */

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #C0C0C0;
            box-shadow: 0 0 0 3px rgba(192, 192, 192, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #C0C0C0;
            background: #fefefe;
        }

        .image-upload-area.drag-over {
            border-color: #C0C0C0;
            background: #f8f9fa;
        }

        .current-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .modal-actions {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal.btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-modal.btn-save {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: #000;
        }

        .btn-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #C0C0C0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error/Success Messages */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        /* Quick Edit Stock */
        .quick-edit {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .quick-edit input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
        }

        .quick-edit button {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Mobile Card View */
        .mobile-view {
            display: none;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .product-card-header {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .product-card-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .product-card-info {
            flex: 1;
        }

        .product-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 5px 0;
        }

        .product-card-category {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .product-card-price {
            font-size: 18px;
            font-weight: 600;
            color: #28a745;
        }

        .product-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .card-detail-item {
            text-align: center;
        }

        .card-detail-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-stock-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .product-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .product-card-actions .btn {
            flex: 1;
            min-width: 100px;
            justify-content: center;
            font-size: 12px;
            padding: 8px 12px;
        }

        .mobile-variants {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .mobile-variants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mobile-variants-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .mobile-variant-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #C0C0C0;
        }

        .mobile-variant-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .mobile-variant-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .mobile-variant-stock {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-variant-actions {
            display: flex;
            gap: 5px;
        }

        /* Mobile Toggle Button */
        .mobile-toggle {
            display: none;
            background: var(--gradient-silver, #C0C0C0);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .mobile-toggle i {
            margin-right: 8px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-btn.active {
            background: var(--gradient-silver, #C0C0C0);
            color: #000;
            border-color: #C0C0C0;
        }

        /* Responsive Breakpoints */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .filters-row {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .panel-stats {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .products-table th,
            .products-table td {
                padding: 10px 8px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .panel-title {
                font-size: 1.5rem;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .view-toggle {
                display: flex;
            }
            
            /* Hide table on mobile by default */
            .desktop-view {
                display: none;
            }
            
            .mobile-view {
                display: block;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .product-card {
                padding: 15px;
            }
            
            .product-card-header {
                flex-direction: column;
                text-align: center;
            }
            
            .product-card-image {
                width: 100px;
                height: 100px;
                margin: 0 auto;
            }
            
            .product-card-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .product-card-actions {
                flex-direction: column;
            }
            
            .product-card-actions .btn {
                min-width: auto;
                width: 100%;
            }
        }

        /* Hide mobile elements on desktop */
        @media (min-width: 769px) {
            .mobile-toggle,
            .view-toggle {
                display: none;
            }
            
            .desktop-view {
                display: block;
            }
            
            .mobile-view {
                display: none;
            }
        }

        /* Categories section */
        .categories-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .category-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .category-count {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }
        
        /* CSV Upload Styles */
        .csv-upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .csv-upload-area:hover {
            border-color: #17a2b8;
            background: #e9f7ff;
        }
        
        .csv-upload-area.drag-over {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .csv-data-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .csv-preview-table th,
        .csv-preview-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .csv-preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .csv-preview-table td {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>

    <!-- Image Format Detection -->
    <script src="../assets/js/image-format-detector.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="panel-header">
            <h1 class="panel-title">
                <i class="fas fa-boxes"></i>
                Panel de Inventario Completo
            </h1>
            <div class="panel-stats" id="panelStats">
                <div class="stat-item">
                    <span class="stat-number" id="totalProducts">-</span>
                    <span class="stat-label">Productos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalStock">-</span>
                    <span class="stat-label">Stock Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="lowStockCount">-</span>
                    <span class="stat-label">Bajo Stock</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalCategories">-</span>
                    <span class="stat-label">Categor√≠as</span>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn btn-success" onclick="showAddProductModal()">
                <i class="fas fa-plus"></i> Nuevo Producto
            </button>
            <button class="btn btn-info" onclick="showAddVariantModal()">
                <i class="fas fa-palette"></i> Nueva Variante
            </button>
            <button class="btn btn-warning" onclick="showCategoriesModal()">
                <i class="fas fa-tags"></i> Gestionar Categor√≠as
            </button>
            <button class="btn btn-primary" onclick="reloadData()">
                <i class="fas fa-refresh"></i> Recargar
            </button>
            <div style="margin-left: auto;">
                <button class="btn btn-danger" onclick="showBulkActions()" id="bulkActionsBtn" style="display: none;">
                    <i class="fas fa-tasks"></i> Acciones Masivas (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Buscar Producto</label>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Nombre, SKU o descripci√≥n...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Categor√≠a</label>
                    <select class="filter-input" id="categoryFilter">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Estado de Stock</label>
                    <select class="filter-input" id="stockFilter">
                        <option value="">Todos</option>
                        <option value="high">Stock Alto</option>
                        <option value="medium">Stock Medio</option>
                        <option value="low">Stock Bajo</option>
                        <option value="out">Sin Stock</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">&nbsp;</label>
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="products-section">
            <div class="products-header">
                <h2 class="products-title">Inventario de Productos</h2>
                <div class="action-buttons">
                    <!-- View Toggle for Mobile -->
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="table" onclick="toggleView('table')">
                            <i class="fas fa-table"></i> Tabla
                        </button>
                        <button class="view-btn" data-view="cards" onclick="toggleView('cards')">
                            <i class="fas fa-th-large"></i> Tarjetas
                        </button>
                    </div>
                    
                    <button class="btn btn-small btn-info" onclick="exportInventory()">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    <button class="btn btn-small btn-success" onclick="showImportCSVModal()">
                        <i class="fas fa-upload"></i> Importar CSV
                    </button>
                </div>
            </div>

            <div id="productsLoading" class="loading">
                <div class="spinner"></div>
                <p>Cargando productos...</p>
            </div>

            <div id="errorContainer"></div>

            <!-- Desktop Table View -->
            <div class="desktop-view" id="desktopView">
                <table class="products-table" id="productsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th></th>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Precio</th>
                            <th>Stock Total</th>
                            <th>Imagen</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards View -->
            <div class="mobile-view" id="mobileView" style="display: none;">
                <div id="productsCardsContainer">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <!-- Modal content will be dynamically generated -->
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://yrmfrfpyqctvwyhrhivl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlybWZyZnB5cWN0dnd5aHJoaXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NTg5MzUsImV4cCI6MjA3MzUzNDkzNX0.qEijwK3FlnqXP2qw0gl438Tt-Rd1vrfts1cXslUuteU';

        // Crear cliente de Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Session restoration for authenticated operations
        async function restoreSupabaseSession() {
            try {
                console.log('üîÑ Restoring Supabase session for authenticated operations...');

                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) {
                    console.log('‚ùå No admin session found in localStorage');
                    return false;
                }

                const sessionData = JSON.parse(adminSession);

                // Check if this was a Supabase authenticated login
                if (sessionData.source === 'supabase_auth' && sessionData.supabaseSession) {
                    console.log('üîë Restoring Supabase Auth session...');

                    // Set the session in the Supabase client
                    const { data, error } = await supabase.auth.setSession({
                        access_token: sessionData.supabaseSession.access_token,
                        refresh_token: sessionData.supabaseSession.refresh_token
                    });

                    if (error) {
                        console.error('‚ùå Error restoring Supabase session:', error);

                        // If session is invalid, clear it and redirect to login
                        if (error.message.includes('expired') || error.message.includes('invalid')) {
                            localStorage.removeItem('adminSession');
                            showError('Su sesi√≥n ha expirado. Redirigiendo al login...');
                            setTimeout(() => {
                                window.location.replace('../index.html');
                            }, 2000);
                            return false;
                        }
                    } else if (data.session) {
                        console.log('‚úÖ Supabase session restored successfully');
                        console.log('üë§ Authenticated user:', data.session.user.email);
                        return true;
                    }
                } else if (sessionData.source === 'local' || sessionData.source === 'local_fallback') {
                    console.log('‚ö†Ô∏è Local session detected - database operations may be limited');
                    return false;
                }

                return false;
            } catch (error) {
                console.error('‚ùå Error during session restoration:', error);
                return false;
            }
        }

        // Session monitoring for authenticated operations
        function setupSessionMonitoring() {
            // Monitor auth state changes
            if (supabase.auth.onAuthStateChange) {
                supabase.auth.onAuthStateChange((event, session) => {
                    console.log('üîÑ Auth state changed:', event, session ? session.user.email : 'No session');

                    if (event === 'SIGNED_OUT' || (event === 'TOKEN_REFRESHED' && !session)) {
                        console.warn('‚ö†Ô∏è Session lost - redirecting to homepage');
                        showError('Sesi√≥n expirada. Redirigiendo...');
                        setTimeout(() => {
                            localStorage.removeItem('adminSession');
                            window.location.replace('../index.html');
                        }, 2000);
                    } else if (event === 'TOKEN_REFRESHED' && session) {
                        console.log('‚úÖ Session token refreshed successfully');
                        // Update localStorage with new session data
                        const adminSession = localStorage.getItem('adminSession');
                        if (adminSession) {
                            try {
                                const sessionData = JSON.parse(adminSession);
                                sessionData.supabaseSession = session;
                                localStorage.setItem('adminSession', JSON.stringify(sessionData));
                            } catch (error) {
                                console.error('Error updating session data:', error);
                            }
                        }
                    }
                });
            }
        }

        // Enhanced error handler for authentication-related errors
        function handleAuthError(error, context = '') {
            console.error(`‚ùå Auth error in ${context}:`, error);

            if (error.message.includes('JWT') ||
                error.message.includes('expired') ||
                error.message.includes('invalid_token') ||
                error.message.includes('not_authenticated')) {

                showError('Su sesi√≥n ha expirado. Redirigiendo al login...');
                localStorage.removeItem('adminSession');
                setTimeout(() => {
                    window.location.replace('../index.html');
                }, 2000);
                return true; // Handled
            }
            return false; // Not handled
        }

        // Variables globales
        let currentProducts = [];
        let currentCategories = [];
        let selectedProducts = new Set();
        let filteredProducts = [];
        // Track which product variants are expanded to preserve state during reloads
        let expandedVariants = [];
        let currentEditingProduct = null;
        let currentEditingVariant = null;
        let isImageUploading = false;
        let selectedImageFile = null;

        // Test function to verify Supabase connection
        async function testSupabaseConnection() {
            try {
                console.log('üîç Testing Supabase connection...');
                const { data, error } = await supabase
                    .from('products')
                    .select('id, name, total_stock')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Supabase connection test failed:', error);
                    return false;
                }

                console.log('‚úÖ Supabase connection test successful:', data);
                return true;
            } catch (error) {
                console.error('‚ùå Supabase connection test error:', error);
                return false;
            }
        }

        // Debug function to check variant IDs in database
        async function checkVariantIds(productId = 1) {
            try {
                console.log(`üîç Checking variant IDs for product ${productId}...`);
                const { data, error } = await supabase
                    .from('product_variants')
                    .select('id, product_id, name, variant_name, sku, stock')
                    .eq('product_id', productId);

                if (error) {
                    console.error('‚ùå Error fetching variants:', error);
                    return;
                }

                console.log('üìã Variants in database:', data);
                return data;
            } catch (error) {
                console.error('‚ùå Error checking variant IDs:', error);
            }
        }

        // Multi-format image loading helper
        function loadVariantImageWithFormats(imgElement, category, product, variant) {
            if (!window.imageDetector) {
                // Fallback if detector not loaded
                imgElement.src = '../assets/images/placeholder-product.jpg';
                return;
            }

            const basePath = `${category}/${product}/${variant}`;

            // Check if imageDetector is available
            if (window.imageDetector && typeof window.imageDetector.loadImage === 'function') {
                window.imageDetector.loadImage(
                    basePath,
                    (url) => {
                        imgElement.src = url;
                    },
                    () => {
                        imgElement.src = '../assets/images/placeholder-product.jpg';
                    }
                );
            } else {
                // Fallback when imageDetector is not available
                imgElement.src = '../assets/images/placeholder-product.jpg';
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando panel de inventario completo...');

            // First, try to restore Supabase session for authenticated operations
            const sessionRestored = await restoreSupabaseSession();

            if (sessionRestored) {
                console.log('‚úÖ Authenticated session active - full functionality available');
            } else {
                console.log('‚ö†Ô∏è No authenticated session - some operations may be limited');
            }

            // Setup session monitoring for real-time auth state changes
            setupSessionMonitoring();

            loadDashboardData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filtros en tiempo real
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('stockFilter').addEventListener('change', applyFilters);

            // Cerrar modal al hacer clic fuera
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        async function loadDashboardData() {
            try {
                showLoading(true);
                clearErrors();

                console.log('üìä Cargando productos y categor√≠as...');
                await Promise.all([
                    loadProducts(),
                    loadCategories()
                ]);

                console.log('‚úÖ Datos cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showError('Error cargando el panel de inventario: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadProducts() {
            try {
                console.log('üîç Consultando productos...');
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select(`
                        id, name, price, total_stock, has_variants, main_image_url, status,
                        description, short_description, slug
                    `)
                    .order('id');

                if (productsError) {
                    throw new Error(`Error cargando productos: ${productsError.message}`);
                }

                console.log(`üì¶ ${products.length} productos encontrados`);

                // Cargar categor√≠as para cada producto
                for (let product of products) {
                    const { data: productCategories } = await supabase
                        .from('product_categories')
                        .select(`
                            categories (
                                id, name, slug
                            )
                        `)
                        .eq('product_id', product.id);

                    product.categories = productCategories?.map(pc => pc.categories) || [];
                    
                    // Cargar variantes si tiene
                    if (product.has_variants) {
                        const { data: variants } = await supabase
                            .from('product_variants')
                            .select('*')
                            .eq('product_id', product.id)
                            .eq('is_active', true)
                            .order('sort_order', { nullsFirst: false });

                        product.variants = variants || [];
                    } else {
                        product.variants = [];
                    }
                }

                currentProducts = products;
                filteredProducts = products;
                renderProductsTable();
                updateDashboardStats();

                // Restore expanded variants state after table rebuild
                restoreExpandedVariants();

            } catch (error) {
                console.error('‚ùå Error en loadProducts:', error);
                throw error;
            }
        }

        async function loadCategories() {
            try {
                const { data: categories, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');

                if (error) {
                    throw new Error(`Error cargando categor√≠as: ${error.message}`);
                }

                currentCategories = categories || [];
                updateCategoryFilter();

            } catch (error) {
                console.error('‚ùå Error en loadCategories:', error);
                throw error;
            }
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
            
            currentCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No hay productos que coincidan con los filtros</td></tr>';
                return;
            }

            filteredProducts.forEach(product => {
                const rows = createProductRow(product);
                if (Array.isArray(rows)) {
                    rows.forEach(row => tbody.appendChild(row));
                } else {
                    tbody.appendChild(rows);
                }
            });

            document.getElementById('productsTable').style.display = 'table';
        }

        function createProductRow(product) {
            const row = document.createElement('tr');
            row.className = 'product-row';
            row.setAttribute('data-product-id', product.id);

            const hasVariants = product.variants && product.variants.length > 0;
            const stockStatus = getStockStatus(product.total_stock || 0);
            const categories = product.categories.map(c => c.name).join(', ') || 'Sin categor√≠a';

            // Obtener URL de imagen
            let imageUrl = '../assets/images/placeholder-product.jpg';
            if (product.main_image_url) {
                imageUrl = product.main_image_url;
            }

            row.innerHTML = `
                <td>
                    <input type="checkbox" class="product-checkbox" value="${product.id}" 
                           onchange="toggleProductSelection(${product.id})">
                </td>
                <td>
                    ${hasVariants ? `<button class="toggle-variants" onclick="toggleVariants(${product.id})">
                        <i class="fas fa-chevron-right"></i>
                    </button>` : ''}
                </td>
                <td>
                    <div class="product-main">${product.name}</div>
                    ${hasVariants ? `<small style="color: #6c757d;">${product.variants.length} variante(s)</small>` : ''}
                    ${product.slug ? `<small style="color: #6c757d; display: block;">/${product.slug}</small>` : ''}
                </td>
                <td><span style="color: #6c757d;">${categories}</span></td>
                <td>
                    <span class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</span>
                </td>
                <td>
                    ${hasVariants ? 
                        `<span class="stock-total stock-${stockStatus.class}">${product.total_stock || 0}</span>` :
                        `<div class="quick-edit">
                            <input type="number" value="${product.total_stock || 0}" min="0" 
                                   onchange="updateProductStock(${product.id}, this.value)">
                            <button onclick="updateProductStock(${product.id}, this.previousElementSibling.value)"
                                    title="Guardar cambios de stock">
                                <i class="fas fa-check"></i>
                            </button>
                         </div>`
                    }
                </td>
                <td>
                    <div class="product-image">
                        <img src="${imageUrl}" alt="${product.name}" class="product-thumb" 
                             onerror="this.src='../assets/images/placeholder-product.jpg'">
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-small btn-primary" onclick="showEditProductModal(${product.id})" 
                                title="Editar Producto">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${hasVariants ? 
                            `<button class="btn btn-small btn-info" onclick="showAddVariantModal(${product.id})" 
                                     title="Agregar Variante">
                                <i class="fas fa-plus"></i>
                            </button>` : 
                            `<button class="btn btn-small btn-info" onclick="showAddVariantModal(${product.id})" 
                                     title="Convertir a Variante">
                                <i class="fas fa-palette"></i>
                            </button>`
                        }
                        <button class="btn btn-small btn-warning" onclick="duplicateProduct(${product.id})" 
                                title="Duplicar">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})" 
                                title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            // Agregar variantes si existen
            if (hasVariants) {
                const variantsContainer = document.createElement('tr');
                variantsContainer.className = 'variants-container';
                variantsContainer.setAttribute('data-product-id', product.id);
                variantsContainer.style.display = 'none';

                const variantsCell = document.createElement('td');
                variantsCell.colSpan = 8;
                
                const variantsHtml = product.variants.map(variant => {
                    // Debug: Log variant data structure
                    console.log('üîç Variant data for product', product.id, ':', variant);

                    // Generar URL de imagen para la variante usando estructura anidada
                    let variantImageUrl = variant.image_url;

                    // Declare variables outside the conditional to make them available in the template
                    const categoryName = product.categories.length > 0 ? product.categories[0].name : 'unknown';
                    const productSlug = product.slug || 'unknown';
                    const variantName = variant.name || variant.variant_name || variant.id;

                    if (!variantImageUrl && product.categories.length > 0) {
                        // Try multiple formats instead of just .jpg
                        variantImageUrl = `https://yrmfrfpyqctvwyhrhivl.supabase.co/storage/v1/object/public/product-images/${categoryName}/${productSlug}/${variantName}.jpg`;
                    }
                    
                    // Fallback si no hay imagen espec√≠fica de variante
                    if (!variantImageUrl) {
                        variantImageUrl = '../assets/images/placeholder-product.jpg';
                    }
                    
                    return `
                        <div class="variant-row">
                            <div class="variant-image">
                                <img src="${variantImageUrl}" alt="${variant.name || 'Variante'}" class="variant-thumb"
                                     onerror="loadVariantImageWithFormats(this, '${categoryName}', '${productSlug}', '${variantName}')"
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                            </div>
                            <div class="variant-info">
                                <span class="variant-name">${variant.name || variant.variant_name || 'Sin nombre'}</span>
                                ${variant.sku ? `<span class="variant-sku">${variant.sku}</span>` : ''}
                            </div>
                            <div class="quick-edit">
                                <input type="number" class="variant-stock-input" value="${variant.stock || 0}" min="0"
                                       onchange="updateVariantStock(${product.id}, '${variant.id}', this.value)">
                                <button onclick="updateVariantStock(${product.id}, '${variant.id}', this.previousElementSibling.value)"
                                        title="Guardar cambios de stock de variante">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                            <div class="variant-actions">
                                <button class="btn btn-small btn-info" onclick="showVariantImageModal(${product.id}, '${variant.id}')" 
                                        title="Cambiar Imagen">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="btn btn-small btn-warning" onclick="showEditVariantModal(${product.id}, '${variant.id}')" 
                                        title="Editar Variante">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="deleteVariant(${product.id}, '${variant.id}')" 
                                        title="Eliminar Variante">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                variantsCell.innerHTML = variantsHtml;
                variantsContainer.appendChild(variantsCell);

                return [row, variantsContainer];
            }

            return row;
        }

        function getStockStatus(stock) {
            if (stock === 0) return { class: 'out', text: 'Sin Stock' };
            if (stock < 5) return { class: 'low', text: 'Bajo' };
            if (stock < 20) return { class: 'medium', text: 'Medio' };
            return { class: 'high', text: 'Alto' };
        }

        function toggleVariants(productId) {
            const variantsRow = document.querySelector(`tr.variants-container[data-product-id="${productId}"]`);
            const toggleBtn = document.querySelector(`tr[data-product-id="${productId}"] .toggle-variants`);
            const chevronIcon = toggleBtn.querySelector('i');

            if (variantsRow.style.display === 'none') {
                // Expanding - show variants
                variantsRow.style.display = 'table-row';
                toggleBtn.classList.add('variants-expanded');
                // Change to up arrow when expanded
                chevronIcon.className = 'fas fa-chevron-up';
                // Track expansion state
                if (!expandedVariants.includes(productId)) {
                    expandedVariants.push(productId);
                }
            } else {
                // Collapsing - hide variants
                variantsRow.style.display = 'none';
                toggleBtn.classList.remove('variants-expanded');
                // Change to right arrow when collapsed
                chevronIcon.className = 'fas fa-chevron-right';
                // Remove from expansion state
                expandedVariants = expandedVariants.filter(id => id !== productId);
            }
        }

        function restoreExpandedVariants() {
            // Restore expansion state for all previously expanded variants
            expandedVariants.forEach(productId => {
                const variantsRow = document.querySelector(`tr.variants-container[data-product-id="${productId}"]`);
                const toggleBtn = document.querySelector(`tr[data-product-id="${productId}"] .toggle-variants`);
                const chevronIcon = toggleBtn ? toggleBtn.querySelector('i') : null;

                if (variantsRow && toggleBtn && chevronIcon) {
                    // Restore expanded state
                    variantsRow.style.display = 'table-row';
                    toggleBtn.classList.add('variants-expanded');
                    chevronIcon.className = 'fas fa-chevron-up';

                    console.log(`üîÑ Restored expanded state for product ${productId}`);
                }
            });
        }

        function updateDashboardStats() {
            const totalProducts = currentProducts.length;
            const totalStock = currentProducts.reduce((sum, product) => sum + (product.total_stock || 0), 0);
            const lowStockCount = currentProducts.filter(product => (product.total_stock || 0) < 5).length;
            const totalCategories = currentCategories.length;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('totalCategories').textContent = totalCategories;
        }

        // Contin√∫a en la siguiente parte...
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showLoading(show) {
            const loading = document.getElementById('productsLoading');
            const table = document.getElementById('productsTable');
            
            if (show) {
                loading.style.display = 'block';
                table.style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function clearErrors() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showSuccess(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <strong>√âxito:</strong> ${message}
                </div>
            `;
            
            // Remover mensaje despu√©s de 5 segundos
            setTimeout(() => clearErrors(), 5000);
        }

        function reloadData() {
            loadDashboardData();
        }

        // ===============================================
        // MODAL MANAGEMENT
        // ===============================================

        function showModal(content) {
            document.getElementById('modal').innerHTML = content;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            currentEditingProduct = null;
            currentEditingVariant = null;
            selectedImageFile = null;
        }

        // ===============================================
        // PRODUCT MANAGEMENT
        // ===============================================

        function showAddProductModal() {
            currentEditingProduct = null;
            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-plus"></i> Agregar Nuevo Producto</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="productForm" onsubmit="saveProduct(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-input" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio *</label>
                                <input type="number" class="form-input" id="productPrice" step="0.01" min="0" required>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n Corta</label>
                                <input type="text" class="form-input" id="productShortDesc" placeholder="Descripci√≥n breve para listados">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n Completa</label>
                                <textarea class="form-input form-textarea" id="productDescription" placeholder="Descripci√≥n detallada del producto"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Categor√≠as</label>
                                <select class="form-input" id="productCategories" multiple>
                                    ${currentCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                                </select>
                                <small style="color: #6c757d;">Mant√©n Ctrl presionado para seleccionar m√∫ltiples categor√≠as</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock Inicial</label>
                                <input type="number" class="form-input" id="productStock" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SKU/C√≥digo</label>
                                <input type="text" class="form-input" id="productSku" placeholder="C√≥digo √∫nico del producto">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso (gramos)</label>
                                <input type="number" class="form-input" id="productWeight" min="0" placeholder="Peso en gramos">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Medidas</label>
                                <input type="text" class="form-input" id="productDimensions" placeholder="Ej: 20cm x 15cm x 5cm">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Imagen del Producto</label>
                                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                                    <div id="imagePreview">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6c757d; margin-bottom: 10px;"></i>
                                        <p>Haz clic para seleccionar una imagen o arr√°strala aqu√≠</p>
                                        <small style="color: #6c757d;">Formatos: JPG, PNG, WebP (m√°x. 5MB)</small>
                                    </div>
                                </div>
                                <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleImageSelect(event)">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="productForm" class="btn-modal btn-save" id="saveProductBtn">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                </div>
            `;
            
            showModal(modalContent);
            setupImageDragAndDrop();
        }

        function showEditProductModal(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) {
                showError('Producto no encontrado');
                return;
            }

            currentEditingProduct = product;
            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-edit"></i> Editar Producto</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="productForm" onsubmit="saveProduct(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-input" id="productName" value="${product.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio *</label>
                                <input type="number" class="form-input" id="productPrice" step="0.01" min="0" value="${product.price || 0}" required>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n Corta</label>
                                <input type="text" class="form-input" id="productShortDesc" value="${product.short_description || ''}" placeholder="Descripci√≥n breve para listados">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n Completa</label>
                                <textarea class="form-input form-textarea" id="productDescription" placeholder="Descripci√≥n detallada del producto">${product.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Categor√≠as</label>
                                <select class="form-input" id="productCategories" multiple>
                                    ${currentCategories.map(cat => {
                                        const isSelected = product.categories.some(pc => pc.id === cat.id);
                                        return `<option value="${cat.id}" ${isSelected ? 'selected' : ''}>${cat.name}</option>`;
                                    }).join('')}
                                </select>
                                <small style="color: #6c757d;">Mant√©n Ctrl presionado para seleccionar m√∫ltiples categor√≠as</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock Total</label>
                                <input type="number" class="form-input" id="productStock" min="0" value="${product.total_stock || 0}" ${product.has_variants ? 'readonly' : ''}>
                                ${product.has_variants ? '<small style="color: #6c757d;">Este producto tiene variantes. El stock se calcula autom√°ticamente.</small>' : ''}
                            </div>
                            <div class="form-group">
                                <label class="form-label">SKU/C√≥digo</label>
                                <input type="text" class="form-input" id="productSku" value="${product.sku || ''}" placeholder="C√≥digo √∫nico del producto">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso (gramos)</label>
                                <input type="number" class="form-input" id="productWeight" min="0" value="${product.weight || ''}" placeholder="Peso en gramos">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Medidas</label>
                                <input type="text" class="form-input" id="productDimensions" value="${product.dimensions || ''}" placeholder="Ej: 20cm x 15cm x 5cm">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Imagen del Producto</label>
                                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                                    <div id="imagePreview">
                                        ${product.main_image_url ? 
                                            `<div style="position: relative; display: inline-block;">
                                                <img src="${product.main_image_url}" alt="Imagen actual" class="current-image">
                                                <button type="button" onclick="clearImageSelection()" style="position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;">&times;</button>
                                            </div>
                                            <div style="margin-top: 10px;"><small style="color: #28a745;">Imagen actual cargada</small></div>` :
                                            `<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6c757d; margin-bottom: 10px;"></i>
                                            <p>Haz clic para seleccionar una imagen o arr√°strala aqu√≠</p>
                                            <small style="color: #6c757d;">Formatos: JPG, PNG, WebP (m√°x. 5MB)</small>`
                                        }
                                    </div>
                                </div>
                                <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleImageSelect(event)">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="productForm" class="btn-modal btn-save" id="saveProductBtn">
                        <i class="fas fa-save"></i> Actualizar Producto
                    </button>
                </div>
            `;
            
            showModal(modalContent);
            setupImageDragAndDrop();
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveProductBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                
                // Recopilar datos del formulario
                const productData = {
                    name: document.getElementById('productName').value.trim(),
                    price: parseFloat(document.getElementById('productPrice').value),
                    short_description: document.getElementById('productShortDesc').value.trim(),
                    description: document.getElementById('productDescription').value.trim(),
                    sku: document.getElementById('productSku').value.trim(),
                    weight: document.getElementById('productWeight').value ? parseInt(document.getElementById('productWeight').value) : null,
                    dimensions: document.getElementById('productDimensions').value.trim()
                };

                // Generar slug desde el nombre
                productData.slug = productData.name.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim('-');

                // Subir imagen si se seleccion√≥ una nueva
                if (selectedImageFile) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo imagen...';
                    const imageUrl = await uploadImageToSupabase(selectedImageFile, productData.name);
                    productData.main_image_url = imageUrl;
                }

                let result;
                if (currentEditingProduct) {
                    // Actualizar producto existente
                    const { data, error } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', currentEditingProduct.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    // Actualizar stock si no tiene variantes
                    if (!currentEditingProduct.has_variants) {
                        const newStock = parseInt(document.getElementById('productStock').value);
                        await supabase
                            .from('products')
                            .update({ total_stock: newStock })
                            .eq('id', currentEditingProduct.id);
                    }
                    
                } else {
                    // Crear nuevo producto
                    const newStock = parseInt(document.getElementById('productStock').value) || 0;
                    productData.total_stock = newStock;
                    productData.status = 'active';
                    
                    const { data, error } = await supabase
                        .from('products')
                        .insert([productData])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                }

                // Actualizar categor√≠as
                await updateProductCategories(result.id);
                
                showSuccess(currentEditingProduct ? 'Producto actualizado correctamente' : 'Producto creado correctamente');
                closeModal();
                await loadProducts();
                
            } catch (error) {
                console.error('Error saving product:', error);
                showError('Error guardando producto: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function updateProductCategories(productId) {
            try {
                // Eliminar categor√≠as existentes
                await supabase
                    .from('product_categories')
                    .delete()
                    .eq('product_id', productId);
                
                // Agregar nuevas categor√≠as
                const categorySelect = document.getElementById('productCategories');
                const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => parseInt(option.value));
                
                if (selectedCategories.length > 0) {
                    const categoryInserts = selectedCategories.map(categoryId => ({
                        product_id: productId,
                        category_id: categoryId
                    }));
                    
                    await supabase
                        .from('product_categories')
                        .insert(categoryInserts);
                }
            } catch (error) {
                console.error('Error updating product categories:', error);
                throw error;
            }
        }

        async function deleteProduct(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;
            
            const hasVariants = product.variants && product.variants.length > 0;
            let confirmMessage = `¬øEst√°s seguro de que quieres eliminar el producto "${product.name}"?`;
            
            if (hasVariants) {
                confirmMessage += `\n\nEste producto tiene ${product.variants.length} variante(s) que tambi√©n ser√°n eliminadas.`;
            }
            
            if (confirm(confirmMessage)) {
                try {
                    // Eliminar imagen si existe
                    if (product.main_image_url && product.main_image_url.includes('supabase')) {
                        await deleteImageFromSupabase(product.main_image_url);
                    }
                    
                    // Eliminar producto (las variantes se eliminan autom√°ticamente por CASCADE)
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    showSuccess('Producto eliminado correctamente');
                    await loadProducts();
                    
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showError('Error eliminando producto: ' + error.message);
                }
            }
        }

        async function duplicateProduct(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`¬øEst√°s seguro de que quieres duplicar el producto "${product.name}"?`)) {
                try {
                    const duplicatedProduct = {
                        name: `${product.name} (Copia)`,
                        slug: `${product.slug}-copia-${Date.now()}`,
                        price: product.price,
                        description: product.description,
                        short_description: product.short_description,
                        main_image_url: product.main_image_url,
                        total_stock: 0, // Empezar con stock 0
                        status: 'active',
                        weight: product.weight,
                        dimensions: product.dimensions
                    };
                    
                    const { data: newProduct, error } = await supabase
                        .from('products')
                        .insert([duplicatedProduct])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Duplicar categor√≠as
                    if (product.categories && product.categories.length > 0) {
                        const categoryInserts = product.categories.map(cat => ({
                            product_id: newProduct.id,
                            category_id: cat.id
                        }));
                        
                        await supabase
                            .from('product_categories')
                            .insert(categoryInserts);
                    }
                    
                    showSuccess('Producto duplicado correctamente');
                    await loadProducts();
                    
                } catch (error) {
                    console.error('Error duplicating product:', error);
                    showError('Error duplicando producto: ' + error.message);
                }
            }
        }

        async function updateProductStock(productId, newStock) {
            try {
                console.log(`üîÑ Actualizando stock del producto ${productId} a ${newStock}`);

                // Verify Supabase client is available
                if (!supabase) {
                    throw new Error('Cliente de Supabase no disponible');
                }

                const parsedStock = parseInt(newStock);
                if (isNaN(parsedStock) || parsedStock < 0) {
                    throw new Error('Stock debe ser un n√∫mero v√°lido mayor o igual a 0');
                }

                const { data, error } = await supabase
                    .from('products')
                    .update({ total_stock: parsedStock })
                    .eq('id', productId)
                    .select();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }

                console.log('‚úÖ Stock actualizado en Supabase:', data);
                showSuccess(`Stock actualizado correctamente a ${parsedStock} unidades`);
                await loadProducts();

            } catch (error) {
                console.error('‚ùå Error updating stock:', error);
                showError('Error actualizando stock: ' + error.message);
            }
        }

        async function updateVariantStock(productId, variantId, newStock) {
            try {
                console.log(`üîÑ [AUTH ENABLED v3] Actualizando stock de variante ${variantId} del producto ${productId} a ${newStock}`);

                // Verify Supabase client is available
                if (!supabase) {
                    throw new Error('Cliente de Supabase no disponible');
                }

                // Check if we have an authenticated session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();

                if (!session) {
                    console.warn('‚ö†Ô∏è No authenticated session found, attempting to restore...');
                    const sessionRestored = await restoreSupabaseSession();

                    if (!sessionRestored) {
                        throw new Error('No hay una sesi√≥n autenticada. Las operaciones de actualizaci√≥n requieren autenticaci√≥n.');
                    }

                    // Verify session was restored
                    const { data: { session: newSession } } = await supabase.auth.getSession();
                    if (!newSession) {
                        throw new Error('No se pudo establecer la sesi√≥n autenticada');
                    }

                    console.log('‚úÖ Session restored successfully for update operation');
                } else {
                    console.log('‚úÖ Authenticated session confirmed:', session.user.email);
                }

                const parsedStock = parseInt(newStock);
                if (isNaN(parsedStock) || parsedStock < 0) {
                    throw new Error('Stock debe ser un n√∫mero v√°lido mayor o igual a 0');
                }

                // First, try to find the variant by checking if it exists
                console.log(`üîç Verificando si existe la variante ${variantId} para producto ${productId}`);

                const { data: checkData, error: checkError } = await supabase
                    .from('product_variants')
                    .select('id, stock, product_id')
                    .eq('id', variantId)
                    .single();

                if (checkError || !checkData) {
                    // If variant doesn't exist with this ID, try alternative matching
                    console.log('‚ö†Ô∏è Variante no encontrada con ID directo, intentando con product_id y SKU/nombre');

                    // Try to match by product_id and other criteria
                    const { data: altCheckData, error: altCheckError } = await supabase
                        .from('product_variants')
                        .select('id, stock, product_id, sku, variant_name')
                        .eq('product_id', productId);

                    if (altCheckError) {
                        throw new Error(`Error buscando variantes del producto: ${altCheckError.message}`);
                    }

                    console.log('üîç Variantes encontradas para el producto:', altCheckData);

                    // If we have variants but couldn't match by variantId, show detailed error
                    if (altCheckData && altCheckData.length > 0) {
                        console.error(`‚ùå Variante ${variantId} no existe. Variantes disponibles:`, altCheckData.map(v => ({ id: v.id, sku: v.sku, name: v.variant_name })));
                        throw new Error(`Variante ${variantId} no encontrada. Revisar ID de variante.`);
                    } else {
                        throw new Error(`No hay variantes para el producto ${productId}`);
                    }
                }

                console.log(`‚úÖ Variante encontrada:`, checkData);

                // Update the variant stock (completely remove SELECT to avoid RLS issues)
                const { error } = await supabase
                    .from('product_variants')
                    .update({ stock: parsedStock })
                    .eq('id', variantId);

                if (error) {
                    console.error('‚ùå Error de Supabase al actualizar variante:', error);

                    // Handle authentication errors specially
                    const authHandled = handleAuthError(error, 'updateVariantStock');
                    if (!authHandled) {
                        throw error;
                    }
                    return; // Exit if auth error was handled
                }

                console.log(`‚úÖ Update completed successfully`);

                // Verify the update by checking the database again
                const { data: verifyData, error: verifyError } = await supabase
                    .from('product_variants')
                    .select('id, stock')
                    .eq('id', variantId)
                    .single();

                if (verifyError) {
                    console.warn('‚ö†Ô∏è Could not verify update:', verifyError);
                    // If we can't verify, assume the update worked since we didn't get an error
                } else {
                    console.log(`üîç Verification: Variant ${variantId} now has stock: ${verifyData.stock}`);

                    // Check if the update actually took effect
                    if (verifyData.stock !== parsedStock) {
                        throw new Error(`Update failed - expected stock ${parsedStock} but database shows ${verifyData.stock}`);
                    }
                }

                console.log(`‚úÖ Stock de variante ${variantId} actualizado exitosamente a ${parsedStock} unidades`);
                showSuccess(`Stock de variante actualizado correctamente a ${parsedStock} unidades`);

                await loadProducts(); // Esto recalcular√° el total autom√°ticamente

            } catch (error) {
                console.error('‚ùå Error updating variant stock:', error);

                // Try to handle authentication errors
                const authHandled = handleAuthError(error, 'updateVariantStock');
                if (!authHandled) {
                    showError('Error actualizando stock de variante: ' + error.message);
                }
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            filteredProducts = currentProducts.filter(product => {
                // Filtro de b√∫squeda
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description || '').toLowerCase().includes(searchTerm) ||
                    (product.slug || '').toLowerCase().includes(searchTerm);

                // Filtro de categor√≠a
                const matchesCategory = !categoryFilter || 
                    product.categories.some(cat => cat.id.toString() === categoryFilter);

                // Filtro de stock
                let matchesStock = true;
                if (stockFilter) {
                    const stock = product.total_stock || 0;
                    switch (stockFilter) {
                        case 'high': matchesStock = stock >= 20; break;
                        case 'medium': matchesStock = stock >= 5 && stock < 20; break;
                        case 'low': matchesStock = stock > 0 && stock < 5; break;
                        case 'out': matchesStock = stock === 0; break;
                    }
                }

                return matchesSearch && matchesCategory && matchesStock;
            });

            renderProductsTable();
        }

        function toggleProductSelection(productId) {
            const checkbox = document.querySelector(`input[value="${productId}"]`);
            if (checkbox.checked) {
                selectedProducts.add(productId);
            } else {
                selectedProducts.delete(productId);
            }
            updateBulkActionsButton();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const productId = parseInt(checkbox.value);
                if (selectAll.checked) {
                    selectedProducts.add(productId);
                } else {
                    selectedProducts.delete(productId);
                }
            });
            
            updateBulkActionsButton();
        }

        function updateBulkActionsButton() {
            const bulkBtn = document.getElementById('bulkActionsBtn');
            const countSpan = document.getElementById('selectedCount');
            
            if (selectedProducts.size > 0) {
                bulkBtn.style.display = 'block';
                countSpan.textContent = selectedProducts.size;
            } else {
                bulkBtn.style.display = 'none';
            }
        }

        function showBulkActions() {
            alert(`Funci√≥n en desarrollo: Acciones masivas para ${selectedProducts.size} productos seleccionados`);
        }

        function exportInventory() {
            if (filteredProducts.length === 0) {
                showError('No hay productos para exportar');
                return;
            }
            
            try {
                // Crear cabeceras CSV
                const headers = [
                    'ID', 'Nombre', 'Precio', 'Descripci√≥n Corta', 'Descripci√≥n', 
                    'SKU', 'Stock Total', 'Categor√≠as', 'Peso', 'Dimensiones', 'Estado'
                ];
                
                // Crear filas de datos
                const rows = filteredProducts.map(product => [
                    product.id,
                    `"${(product.name || '').replace(/"/g, '""')}"`,
                    product.price || 0,
                    `"${(product.short_description || '').replace(/"/g, '""')}"`,
                    `"${(product.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    product.sku || '',
                    product.total_stock || 0,
                    `"${product.categories.map(c => c.name).join(', ')}"`,
                    product.weight || '',
                    product.dimensions || '',
                    product.status || 'active'
                ]);
                
                // Combinar cabeceras y datos
                const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                
                // Descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `inventario_estudio_artesana_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSuccess(`Inventario exportado exitosamente (${filteredProducts.length} productos)`);
                
            } catch (error) {
                console.error('Error exportando inventario:', error);
                showError('Error exportando inventario: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // ===============================================
        // IMAGE MANAGEMENT
        // ===============================================

        function setupImageDragAndDrop() {
            const uploadArea = document.getElementById('imageUploadArea');
            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageSelect({ target: { files: [files[0]] } });
                }
            });
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar archivo
            if (!file.type.startsWith('image/')) {
                showError('Por favor selecciona un archivo de imagen v√°lido.');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showError('La imagen es demasiado grande. El tama√±o m√°ximo es 5MB.');
                return;
            }

            selectedImageFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="${e.target.result}" alt="Preview" class="current-image">
                        <button type="button" onclick="clearImageSelection()" style="position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                    <div style="margin-top: 10px;"><small style="color: #17a2b8;">Nueva imagen seleccionada</small></div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function clearImageSelection() {
            selectedImageFile = null;
            const preview = document.getElementById('imagePreview');
            
            if (currentEditingProduct && currentEditingProduct.main_image_url) {
                // Restaurar imagen actual
                preview.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="${currentEditingProduct.main_image_url}" alt="Imagen actual" class="current-image">
                        <button type="button" onclick="clearImageSelection()" style="position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                    <div style="margin-top: 10px;"><small style="color: #28a745;">Imagen actual cargada</small></div>
                `;
            } else {
                // Mostrar placeholder
                preview.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6c757d; margin-bottom: 10px;"></i>
                    <p>Haz clic para seleccionar una imagen o arr√°strala aqu√≠</p>
                    <small style="color: #6c757d;">Formatos: JPG, PNG, WebP (m√°x. 5MB)</small>
                `;
            }
        }

        async function uploadImageToSupabase(file, productName) {
            try {
                // Generar nombre √∫nico para el archivo
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileName = `${productName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}.${fileExtension}`;
                const filePath = `productos/${fileName}`;

                // Subir archivo
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('product-images')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    throw new Error(`Error subiendo imagen: ${uploadError.message}`);
                }

                // Obtener URL p√∫blica
                const { data: publicUrlData } = supabase.storage
                    .from('product-images')
                    .getPublicUrl(uploadData.path);

                if (!publicUrlData.publicUrl) {
                    throw new Error('No se pudo obtener la URL p√∫blica de la imagen');
                }

                return publicUrlData.publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        async function deleteImageFromSupabase(imageUrl) {
            try {
                if (!imageUrl || !imageUrl.includes('supabase')) return;
                
                // Extraer el path del archivo desde la URL
                const urlParts = imageUrl.split('/');
                const fileName = urlParts[urlParts.length - 1];
                const filePath = `productos/${fileName}`;

                const { error } = await supabase.storage
                    .from('product-images')
                    .remove([filePath]);

                if (error) {
                    console.warn('Warning deleting image:', error.message);
                    // No lanzamos error porque la imagen podr√≠a no existir
                }
            } catch (error) {
                console.warn('Warning deleting image:', error);
            }
        }

        // ===============================================
        // VARIANT MANAGEMENT
        // ===============================================

        function showAddVariantModal(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) {
                showError('Producto no encontrado');
                return;
            }

            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-palette"></i> ${product.has_variants ? 'Agregar Variante' : 'Convertir a Producto con Variantes'}</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Producto: ${product.name}</h4>
                        <small style="color: #6c757d;">${!product.has_variants ? 'Esto convertir√° el producto en un sistema de variantes' : 'Agrega una nueva variante a este producto'}</small>
                    </div>
                    <form id="variantForm" onsubmit="saveVariant(event, ${productId})">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre de la Variante *</label>
                                <input type="text" class="form-input" id="variantName" required placeholder="Ej: Talla M, Color Rojo, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SKU/C√≥digo</label>
                                <input type="text" class="form-input" id="variantSku" placeholder="C√≥digo √∫nico de la variante">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock Inicial</label>
                                <input type="number" class="form-input" id="variantStock" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio Extra</label>
                                <input type="number" class="form-input" id="variantPriceExtra" step="0.01" value="0" placeholder="Precio adicional al producto base">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-input" id="variantDescription" placeholder="Descripci√≥n espec√≠fica de esta variante"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="variantForm" class="btn-modal btn-save" id="saveVariantBtn">
                        <i class="fas fa-save"></i> ${product.has_variants ? 'Agregar Variante' : 'Crear Primera Variante'}
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }

        function showEditVariantModal(productId, variantId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) {
                showError('Producto no encontrado');
                return;
            }

            const variant = product.variants.find(v => v.id === variantId);
            if (!variant) {
                showError('Variante no encontrada');
                return;
            }

            currentEditingVariant = variant;

            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-edit"></i> Editar Variante</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Producto: ${product.name}</h4>
                        <small style="color: #6c757d;">Editando variante: ${variant.name || variant.variant_name}</small>
                    </div>
                    <form id="variantForm" onsubmit="saveVariant(event, ${productId})">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre de la Variante *</label>
                                <input type="text" class="form-input" id="variantName" value="${variant.name || variant.variant_name || ''}" required placeholder="Ej: Talla M, Color Rojo, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SKU/C√≥digo</label>
                                <input type="text" class="form-input" id="variantSku" value="${variant.sku || ''}" placeholder="C√≥digo √∫nico de la variante">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock</label>
                                <input type="number" class="form-input" id="variantStock" min="0" value="${variant.stock || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio Extra</label>
                                <input type="number" class="form-input" id="variantPriceExtra" step="0.01" value="${variant.price_extra || 0}" placeholder="Precio adicional al producto base">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-input" id="variantDescription" placeholder="Descripci√≥n espec√≠fica de esta variante">${variant.description || ''}</textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="variantForm" class="btn-modal btn-save" id="saveVariantBtn">
                        <i class="fas fa-save"></i> Actualizar Variante
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }

        async function saveVariant(event, productId) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveVariantBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                
                const variantData = {
                    product_id: productId,
                    name: document.getElementById('variantName').value.trim(),
                    variant_name: document.getElementById('variantName').value.trim(), // Para compatibilidad
                    sku: document.getElementById('variantSku').value.trim(),
                    stock: parseInt(document.getElementById('variantStock').value) || 0,
                    price_extra: parseFloat(document.getElementById('variantPriceExtra').value) || 0,
                    description: document.getElementById('variantDescription').value.trim(),
                    is_active: true,
                    sort_order: 0
                };

                let result;
                if (currentEditingVariant) {
                    // Actualizar variante existente
                    const { data, error } = await supabase
                        .from('product_variants')
                        .update(variantData)
                        .eq('id', currentEditingVariant.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                } else {
                    // Crear nueva variante
                    const { data, error } = await supabase
                        .from('product_variants')
                        .insert([variantData])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    // Actualizar el producto para marcar que tiene variantes
                    await supabase
                        .from('products')
                        .update({ has_variants: true })
                        .eq('id', productId);
                }

                showSuccess(currentEditingVariant ? 'Variante actualizada correctamente' : 'Variante creada correctamente');
                closeModal();
                await loadProducts(); // Esto recalcular√° autom√°ticamente el stock total
                
            } catch (error) {
                console.error('Error saving variant:', error);
                showError('Error guardando variante: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function deleteVariant(productId, variantId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;
            
            const variant = product.variants.find(v => v.id === variantId);
            if (!variant) return;
            
            const isLastVariant = product.variants.length === 1;
            let confirmMessage = `¬øEst√°s seguro de que quieres eliminar la variante "${variant.name || variant.variant_name}"?`;
            
            if (isLastVariant) {
                confirmMessage += '\n\nEsta es la √∫nica variante. Al eliminarla, el producto volver√° a ser un producto simple.';
            }
            
            if (confirm(confirmMessage)) {
                try {
                    // Eliminar la variante
                    const { error } = await supabase
                        .from('product_variants')
                        .delete()
                        .eq('id', variantId);
                    
                    if (error) throw error;
                    
                    // Si era la √∫ltima variante, actualizar el producto
                    if (isLastVariant) {
                        await supabase
                            .from('products')
                            .update({ 
                                has_variants: false,
                                total_stock: 0 // Resetear stock cuando se convierte a producto simple
                            })
                            .eq('id', productId);
                    }
                    
                    showSuccess('Variante eliminada correctamente');
                    await loadProducts();
                    
                } catch (error) {
                    console.error('Error deleting variant:', error);
                    showError('Error eliminando variante: ' + error.message);
                }
            }
        }

        // ===============================================
        // CATEGORIES MANAGEMENT
        // ===============================================

        function showCategoriesModal() {
            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-tags"></i> Gestionar Categor√≠as</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <h4>Agregar Nueva Categor√≠a</h4>
                        <form id="categoryForm" onsubmit="addCategory(event)" style="display: flex; gap: 10px; align-items: end;">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-input" id="categoryName" placeholder="Nombre de la categor√≠a" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </form>
                    </div>
                    
                    <div id="categoriesList">
                        <h4>Categor√≠as Existentes</h4>
                        <div class="categories-section">
                            ${currentCategories.length === 0 ? '<p style="text-align: center; padding: 20px; color: #6c757d;">No hay categor√≠as creadas</p>' :
                                currentCategories.map(category => `
                                    <div class="category-item">
                                        <div class="category-info">
                                            <div class="category-name">${category.name}</div>
                                            <div class="category-count">${getProductCountByCategory(category.id)} productos</div>
                                        </div>
                                        <div class="category-actions">
                                            <button class="btn btn-small btn-warning" onclick="editCategory(${category.id}, '${category.name}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-small btn-danger" onclick="deleteCategory(${category.id}, '${category.name}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }

        async function addCategory(event) {
            event.preventDefault();
            
            const categoryName = document.getElementById('categoryName').value.trim();
            if (!categoryName) return;
            
            try {
                const categoryData = {
                    name: categoryName,
                    slug: categoryName.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim('-')
                };
                
                const { data, error } = await supabase
                    .from('categories')
                    .insert([categoryData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showSuccess('Categor√≠a creada correctamente');
                await loadCategories();
                showCategoriesModal(); // Refrescar el modal
                
            } catch (error) {
                console.error('Error creating category:', error);
                showError('Error creando categor√≠a: ' + error.message);
            }
        }

        async function editCategory(categoryId, currentName) {
            const newName = prompt('Nuevo nombre para la categor√≠a:', currentName);
            if (!newName || newName.trim() === currentName) return;
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .update({ 
                        name: newName.trim(),
                        slug: newName.trim().toLowerCase()
                            .replace(/[^a-z0-9\s-]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-')
                            .trim('-')
                    })
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                showSuccess('Categor√≠a actualizada correctamente');
                await loadCategories();
                showCategoriesModal(); // Refrescar el modal
                
            } catch (error) {
                console.error('Error updating category:', error);
                showError('Error actualizando categor√≠a: ' + error.message);
            }
        }

        async function deleteCategory(categoryId, categoryName) {
            const productCount = getProductCountByCategory(categoryId);
            let confirmMessage = `¬øEst√°s seguro de que quieres eliminar la categor√≠a "${categoryName}"?`;
            
            if (productCount > 0) {
                confirmMessage += `\n\nEsta categor√≠a est√° asociada a ${productCount} producto(s). La asociaci√≥n se eliminar√° pero los productos no se ver√°n afectados.`;
            }
            
            if (confirm(confirmMessage)) {
                try {
                    // Eliminar asociaciones primero
                    await supabase
                        .from('product_categories')
                        .delete()
                        .eq('category_id', categoryId);
                    
                    // Eliminar categor√≠a
                    const { error } = await supabase
                        .from('categories')
                        .delete()
                        .eq('id', categoryId);
                    
                    if (error) throw error;
                    
                    showSuccess('Categor√≠a eliminada correctamente');
                    await loadCategories();
                    await loadProducts(); // Recargar productos para actualizar las categor√≠as
                    showCategoriesModal(); // Refrescar el modal
                    
                } catch (error) {
                    console.error('Error deleting category:', error);
                    showError('Error eliminando categor√≠a: ' + error.message);
                }
            }
        }

        function getProductCountByCategory(categoryId) {
            return currentProducts.filter(product => 
                product.categories.some(cat => cat.id === categoryId)
            ).length;
        }
        
        // ===============================================
        // CSV IMPORT/EXPORT MANAGEMENT
        // ===============================================
        
        let csvData = [];
        let selectedCSVFile = null;
        
        function showImportCSVModal() {
            const modalContent = `
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-upload"></i> Importar Productos desde CSV</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group full-width">
                        <label class="form-label">Seleccionar archivo CSV</label>
                        <div class="csv-upload-area" id="csvUploadArea" onclick="document.getElementById('csvInput').click()">
                            <div id="csvPreview">
                                <i class="fas fa-file-csv" style="font-size: 2rem; color: #17a2b8; margin-bottom: 10px;"></i>
                                <p>Haz clic para seleccionar un archivo CSV o arr√°stralo aqu√≠</p>
                                <small style="color: #6c757d;">Formato CSV: Nombre, Precio, Stock, Descripci√≥n (m√°x. 10MB)</small>
                            </div>
                        </div>
                        <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="handleCSVSelect(event)">
                    </div>
                    
                    <div class="form-group full-width" id="csvDataPreview" style="display: none;">
                        <label class="form-label">Vista previa de datos (primeras 5 filas)</label>
                        <div class="csv-data-container">
                            <table class="csv-preview-table" id="csvPreviewTable">
                                <thead id="csvPreviewHeader"></thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="form-group full-width" id="importOptions" style="display: none;">
                        <label class="form-label">Opciones de importaci√≥n</label>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="skipDuplicates" checked>
                                <span>Omitir productos duplicados (por nombre)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="updateExisting">
                                <span>Actualizar productos existentes</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn-modal btn-save" id="importCSVBtn" onclick="importCSVData()" style="display: none;">
                        <i class="fas fa-upload"></i> Importar Productos
                    </button>
                </div>
            `;
            
            showModal(modalContent);
            setupCSVDragAndDrop();
        }
        
        function setupCSVDragAndDrop() {
            const uploadArea = document.getElementById('csvUploadArea');
            if (!uploadArea) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('drag-over');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('drag-over');
                }, false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCSVSelect({ target: { files: files } });
                }
            }, false);
        }
        
        function handleCSVSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar archivo
            if (!file.name.toLowerCase().endsWith('.csv') && file.type !== 'text/csv') {
                showError('Por favor selecciona un archivo CSV v√°lido');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('El archivo CSV es demasiado grande. Tama√±o m√°ximo: 10MB');
                return;
            }
            
            selectedCSVFile = file;
            
            // Mostrar preview del archivo
            document.getElementById('csvPreview').innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-file-csv" style="font-size: 2rem; color: #28a745; margin-bottom: 10px;"></i>
                    <p><strong>${file.name}</strong></p>
                    <small style="color: #6c757d;">Tama√±o: ${(file.size/1024/1024).toFixed(2)}MB</small>
                    <div style="margin-top: 10px;">
                        <small style="color: #17a2b8;">üìä Procesando archivo...</small>
                    </div>
                </div>
            `;
            
            // Procesar archivo CSV
            parseCSVFile(file);
        }
        
        function parseCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    csvData = parseCSV(csvText);
                    
                    if (csvData.length === 0) {
                        throw new Error('El archivo CSV est√° vac√≠o o no tiene datos v√°lidos');
                    }
                    
                    showCSVPreview();
                    
                } catch (error) {
                    console.error('Error parseando CSV:', error);
                    showError('Error procesando archivo CSV: ' + error.message);
                    
                    // Mostrar error en preview
                    document.getElementById('csvPreview').innerHTML = `
                        <div style="text-align: center; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p><strong>Error procesando archivo</strong></p>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            };
            
            reader.onerror = function() {
                showError('Error leyendo el archivo CSV');
            };
            
            reader.readAsText(file, 'utf-8');
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('El archivo debe tener al menos una cabecera y una fila de datos');
            }
            
            // Parsear cabecera
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            // Parsear datos
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Saltar l√≠neas vac√≠as
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header.toLowerCase().trim()] = values[index] || '';
                });
                
                data.push(row);
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        function showCSVPreview() {
            const previewContainer = document.getElementById('csvDataPreview');
            const headerElement = document.getElementById('csvPreviewHeader');
            const bodyElement = document.getElementById('csvPreviewBody');
            const importBtn = document.getElementById('importCSVBtn');
            const importOptions = document.getElementById('importOptions');
            
            // Limpiar contenido anterior
            headerElement.innerHTML = '';
            bodyElement.innerHTML = '';
            
            if (csvData.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            // Obtener columnas
            const columns = Object.keys(csvData[0]);
            
            // Crear cabecera
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            headerElement.appendChild(headerRow);
            
            // Mostrar primeras 5 filas
            const rowsToShow = Math.min(5, csvData.length);
            for (let i = 0; i < rowsToShow; i++) {
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = csvData[i][col] || '';
                    td.textContent = value.length > 30 ? value.substring(0, 30) + '...' : value;
                    td.title = value; // Tooltip con valor completo
                    row.appendChild(td);
                });
                
                bodyElement.appendChild(row);
            }
            
            // Mostrar elementos
            previewContainer.style.display = 'block';
            importOptions.style.display = 'block';
            importBtn.style.display = 'block';
            
            // Actualizar preview del archivo
            document.getElementById('csvPreview').innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745; margin-bottom: 10px;"></i>
                    <p><strong>${selectedCSVFile.name}</strong></p>
                    <small style="color: #28a745;">‚úÖ ${csvData.length} filas le√≠das correctamente</small>
                </div>
            `;
        }
        
        async function importCSVData() {
            if (!csvData || csvData.length === 0) {
                showError('No hay datos para importar');
                return;
            }
            
            const importBtn = document.getElementById('importCSVBtn');
            const originalText = importBtn.innerHTML;
            
            try {
                importBtn.disabled = true;
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
                
                const skipDuplicates = document.getElementById('skipDuplicates').checked;
                const updateExisting = document.getElementById('updateExisting').checked;
                
                let importedCount = 0;
                let skippedCount = 0;
                let updatedCount = 0;
                let errorCount = 0;
                
                for (const row of csvData) {
                    try {
                        // Validar datos m√≠nimos
                        if (!row.nombre || !row.precio) {
                            console.warn('Saltando fila sin nombre o precio:', row);
                            skippedCount++;
                            continue;
                        }
                        
                        const productData = {
                            name: row.nombre.trim(),
                            price: parseFloat(row.precio) || 0,
                            description: row.descripci√≥n || row.descripcion || '',
                            short_description: row['descripci√≥n corta'] || row['descripcion corta'] || '',
                            total_stock: parseInt(row.stock) || 0,
                            sku: row.sku || '',
                            status: 'active'
                        };
                        
                        // Generar slug
                        productData.slug = productData.name.toLowerCase()
                            .replace(/[^a-z0-9\s-]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-')
                            .trim('-');
                        
                        // Verificar si ya existe
                        const existingProduct = currentProducts.find(p => 
                            p.name.toLowerCase() === productData.name.toLowerCase()
                        );
                        
                        if (existingProduct) {
                            if (skipDuplicates && !updateExisting) {
                                skippedCount++;
                                continue;
                            }
                            
                            if (updateExisting) {
                                // Actualizar producto existente
                                const { error } = await supabase
                                    .from('products')
                                    .update(productData)
                                    .eq('id', existingProduct.id);
                                
                                if (error) throw error;
                                updatedCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            // Crear nuevo producto
                            const { error } = await supabase
                                .from('products')
                                .insert([productData]);
                            
                            if (error) throw error;
                            importedCount++;
                        }
                        
                    } catch (error) {
                        console.error('Error procesando fila:', row, error);
                        errorCount++;
                    }
                }
                
                // Mostrar resultados
                let message = `Importaci√≥n completada:\n`;
                if (importedCount > 0) message += `‚Ä¢ ${importedCount} productos nuevos\n`;
                if (updatedCount > 0) message += `‚Ä¢ ${updatedCount} productos actualizados\n`;
                if (skippedCount > 0) message += `‚Ä¢ ${skippedCount} productos omitidos\n`;
                if (errorCount > 0) message += `‚Ä¢ ${errorCount} errores encontrados`;
                
                showSuccess(message.trim());
                closeModal();
                await loadProducts();
                
            } catch (error) {
                console.error('Error en importaci√≥n CSV:', error);
                showError('Error durante la importaci√≥n: ' + error.message);
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = originalText;
            }
        }

        // ===============================================
        // MOBILE VIEW MANAGEMENT
        // ===============================================
        
        function toggleView(viewType) {
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const tableBtn = document.querySelector('[data-view="table"]');
            const cardsBtn = document.querySelector('[data-view="cards"]');
            
            if (viewType === 'table') {
                // Mostrar vista de tabla
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                tableBtn.classList.add('active');
                cardsBtn.classList.remove('active');
            } else {
                // Mostrar vista de tarjetas
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                cardsBtn.classList.add('active');
                tableBtn.classList.remove('active');
                
                // Renderizar tarjetas si a√∫n no se han renderizado
                renderProductCards();
            }
        }
        
        function renderProductCards() {
            const container = document.getElementById('productsCardsContainer');
            container.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No hay productos que coincidan con los filtros</p>
                    </div>
                `;
                return;
            }
            
            filteredProducts.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
        }
        
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const hasVariants = product.variants && product.variants.length > 0;
            const stockStatus = getStockStatus(product.total_stock || 0);
            const categories = product.categories.map(c => c.name).join(', ') || 'Sin categor√≠a';
            
            // Obtener URL de imagen
            let imageUrl = '../assets/images/placeholder-product.jpg';
            if (product.main_image_url) {
                imageUrl = product.main_image_url;
            }
            
            card.innerHTML = `
                <div class="product-card-header">
                    <div class="product-card-image">
                        <img src="${imageUrl}" alt="${product.name}" class="product-thumb" 
                             onerror="this.src='../assets/images/placeholder-product.jpg'">
                    </div>
                    <div class="product-card-info">
                        <h3 class="product-card-title">${product.name}</h3>
                        <p class="product-card-category">${categories}</p>
                        <div class="product-card-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="product-card-details">
                    <div class="card-detail-item">
                        <div class="card-detail-label">Stock Total</div>
                        <div class="card-detail-value">
                            <span class="card-stock-badge stock-${stockStatus.class}">${product.total_stock || 0}</span>
                        </div>
                    </div>
                    <div class="card-detail-item">
                        <div class="card-detail-label">Variantes</div>
                        <div class="card-detail-value">${hasVariants ? product.variants.length : 'Sin variantes'}</div>
                    </div>
                </div>
                
                <div class="product-card-actions">
                    <button class="btn btn-small btn-primary" onclick="showEditProductModal(${product.id})" 
                            title="Editar Producto">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    ${hasVariants ? 
                        `<button class="btn btn-small btn-info" onclick="showAddVariantModal(${product.id})" 
                                 title="Agregar Variante">
                            <i class="fas fa-plus"></i> Variante
                        </button>` : 
                        `<button class="btn btn-small btn-info" onclick="showAddVariantModal(${product.id})" 
                                 title="Convertir a Variante">
                            <i class="fas fa-palette"></i> Variante
                        </button>`
                    }
                    <button class="btn btn-small btn-warning" onclick="duplicateProduct(${product.id})" 
                            title="Duplicar">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})" 
                            title="Eliminar">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
                
                ${hasVariants ? `
                <div class="mobile-variants" id="mobileVariants-${product.id}" style="display: none;">
                    <div class="mobile-variants-header">
                        <div class="mobile-variants-title">Variantes (${product.variants.length})</div>
                        <button class="btn btn-small btn-primary" onclick="toggleMobileVariants(${product.id})">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="mobile-variants-list">
                        ${product.variants.map(variant => `
                            <div class="mobile-variant-item">
                                <div class="mobile-variant-name">${variant.name || variant.variant_name || 'Sin nombre'}</div>
                                <div class="mobile-variant-details">
                                    <div class="mobile-variant-info">
                                        ${variant.sku ? `<span class="variant-sku">${variant.sku}</span>` : ''}
                                    </div>
                                    <div class="mobile-variant-stock">
                                        <input type="number" class="variant-stock-input" value="${variant.stock || 0}" min="0"
                                               onchange="updateVariantStock(${product.id}, '${variant.id}', this.value)">
                                        <div class="mobile-variant-actions">
                                            <button class="btn btn-small btn-warning" onclick="showEditVariantModal(${product.id}, '${variant.id}')" 
                                                    title="Editar Variante">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-small btn-danger" onclick="deleteVariant(${product.id}, '${variant.id}')" 
                                                    title="Eliminar Variante">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Agregar bot√≥n para mostrar/ocultar variantes si las tiene -->
                ${hasVariants ? `
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-small" onclick="toggleMobileVariants(${product.id})" 
                            style="background: #f8f9fa; border: 1px solid #dee2e6; width: 100%;">
                        <i class="fas fa-chevron-down" id="chevron-${product.id}"></i> 
                        Ver Variantes (${product.variants.length})
                    </button>
                </div>
                ` : ''}
            `;
            
            return card;
        }
        
        function toggleMobileVariants(productId) {
            const variantsSection = document.getElementById(`mobileVariants-${productId}`);
            const chevron = document.getElementById(`chevron-${productId}`);
            const button = chevron.parentElement;
            
            if (variantsSection.style.display === 'none' || variantsSection.style.display === '') {
                variantsSection.style.display = 'block';
                chevron.className = 'fas fa-chevron-up';
                button.innerHTML = chevron.outerHTML + ` Ocultar Variantes`;
            } else {
                variantsSection.style.display = 'none';
                chevron.className = 'fas fa-chevron-down';
                const product = currentProducts.find(p => p.id === productId);
                const variantCount = product ? product.variants.length : 0;
                button.innerHTML = chevron.outerHTML + ` Ver Variantes (${variantCount})`;
            }
        }
        
        // Modificar renderProductsTable para tambi√©n actualizar cards
        const originalRenderProductsTable = renderProductsTable;
        renderProductsTable = function() {
            originalRenderProductsTable();

            // Si estamos en vista m√≥vil de cards, tambi√©n actualizar las cards
            const mobileView = document.getElementById('mobileView');
            if (mobileView && mobileView.style.display !== 'none') {
                renderProductCards();
            }

            // Always restore expanded variants state after table render
            // (This is called when filters change, not just loadProducts)
            setTimeout(() => restoreExpandedVariants(), 50);
        };
        
        // Detectar cambio de tama√±o de ventana para ajustar vista autom√°ticamente
        window.addEventListener('resize', function() {
            const width = window.innerWidth;
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const viewToggle = document.querySelector('.view-toggle');
            
            if (width <= 768) {
                // Modo m√≥vil - mostrar toggle y cards por defecto
                if (viewToggle) viewToggle.style.display = 'flex';
                if (desktopView.style.display !== 'none') {
                    toggleView('cards');
                }
            } else {
                // Modo desktop - ocultar toggle y mostrar tabla
                if (viewToggle) viewToggle.style.display = 'none';
                if (mobileView.style.display !== 'none') {
                    toggleView('table');
                }
            }
        });
        
        // Disparar resize al cargar para establecer vista inicial correcta
        window.addEventListener('load', function() {
            window.dispatchEvent(new Event('resize'));
        });

        // Logging para debug
        console.log('üîß Panel de inventario completo cargado');
        console.log('üì° Supabase URL:', SUPABASE_URL);
        console.log('üì± Sistema de vistas m√≥viles habilitado');
    </script>

    <!-- Admin Authentication Guard -->
    <script src="admin-auth-guard.js"></script>
</body>
</html>
