<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Sistema de Pagos - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        .subtitle { color: #7f8c8d; margin-bottom: 30px; }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .sql-box {
            background: #2c3e50;
            color: #fff;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 15px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #2980b9; }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #3498db;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Configurar Sistema de Pagos</h1>
        <p class="subtitle">Ejecuta estos SQLs en Supabase para configurar c√≥digos de referencia y datos bancarios</p>

        <div class="step">
            <h3><i class="fas fa-database"></i> Paso 1: Agregar campo de c√≥digo de referencia</h3>
            <p>Este campo se usar√° para identificar pagos por transferencia</p>

            <div class="sql-box">-- Agregar campo payment_reference a la tabla orders
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS payment_reference VARCHAR(20) UNIQUE;

-- Crear √≠ndice para b√∫squedas r√°pidas
CREATE INDEX IF NOT EXISTS idx_orders_payment_reference
ON public.orders(payment_reference);</div>

            <button class="btn" onclick="copySQL(1)"><i class="fas fa-copy"></i> Copiar SQL Paso 1</button>
        </div>

        <div class="step">
            <h3><i class="fas fa-university"></i> Paso 2: Crear tabla de configuraci√≥n bancaria</h3>
            <p>Guarda los datos bancarios para mostrar en el checkout de mayoristas</p>

            <div class="sql-box">-- Crear tabla para configuraci√≥n bancaria
CREATE TABLE IF NOT EXISTS public.payment_config (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Insertar configuraci√≥n bancaria por defecto
INSERT INTO public.payment_config (config_key, config_value)
VALUES ('bank_info', '{
    "bank_name": "BBVA Bancomer",
    "account_holder": "Estudio Artesana S.A. de C.V.",
    "account_number": "0123456789",
    "clabe": "012345678901234567",
    "swift": "BCMRMXMM",
    "currency": "MXN",
    "reference_instructions": "Usa el c√≥digo de referencia que aparece en tu pedido"
}'::jsonb)
ON CONFLICT (config_key) DO NOTHING;

-- Habilitar RLS
ALTER TABLE public.payment_config ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica: Todos pueden leer
CREATE POLICY "Anyone can read payment config"
ON public.payment_config FOR SELECT
USING (true);

-- Pol√≠tica: Solo admins pueden actualizar (ajusta seg√∫n tu auth)
CREATE POLICY "Admins can update payment config"
ON public.payment_config FOR UPDATE
USING (true);

CREATE POLICY "Admins can insert payment config"
ON public.payment_config FOR INSERT
WITH CHECK (true);</div>

            <button class="btn" onclick="copySQL(2)"><i class="fas fa-copy"></i> Copiar SQL Paso 2</button>
        </div>

        <div class="step">
            <h3><i class="fas fa-code"></i> Paso 3: Funci√≥n para generar c√≥digos de referencia</h3>
            <p>Crea c√≥digos √∫nicos como "ESTUD-0001", "ESTUD-0002", etc.</p>

            <div class="sql-box">-- Funci√≥n para generar c√≥digos de referencia
CREATE OR REPLACE FUNCTION generate_payment_reference()
RETURNS VARCHAR AS $$
DECLARE
    new_code VARCHAR(20);
    code_exists BOOLEAN;
    counter INT := 1;
BEGIN
    LOOP
        -- Generar c√≥digo con formato ESTUD-XXXX
        new_code := 'ESTUD-' || LPAD(counter::TEXT, 4, '0');

        -- Verificar si existe
        SELECT EXISTS(
            SELECT 1 FROM orders WHERE payment_reference = new_code
        ) INTO code_exists;

        -- Si no existe, retornar
        IF NOT code_exists THEN
            RETURN new_code;
        END IF;

        -- Incrementar contador
        counter := counter + 1;

        -- Prevenir loop infinito
        IF counter > 9999 THEN
            RAISE EXCEPTION 'No se pudo generar c√≥digo de referencia √∫nico';
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- Trigger para auto-generar payment_reference en INSERT
CREATE OR REPLACE FUNCTION auto_generate_payment_reference()
RETURNS TRIGGER AS $$
BEGIN
    -- Solo generar si es pedido mayorista y m√©todo de pago es transferencia
    IF NEW.order_type = 'wholesale' AND
       NEW.payment_method = 'transferencia' AND
       NEW.payment_reference IS NULL THEN
        NEW.payment_reference := generate_payment_reference();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_auto_payment_reference ON orders;
CREATE TRIGGER trigger_auto_payment_reference
    BEFORE INSERT ON orders
    FOR EACH ROW
    EXECUTE FUNCTION auto_generate_payment_reference();</div>

            <button class="btn" onclick="copySQL(3)"><i class="fas fa-copy"></i> Copiar SQL Paso 3</button>
        </div>

        <div class="info-box">
            <h3><i class="fas fa-check-circle"></i> Pr√≥ximos Pasos</h3>
            <ol>
                <li>Copia y ejecuta los 3 SQLs en orden en Supabase SQL Editor</li>
                <li>Ve a <a href="config-bancaria.html">config-bancaria.html</a> para editar los datos bancarios</li>
                <li>Los nuevos pedidos mayoristas generar√°n autom√°ticamente c√≥digos de referencia</li>
                <li>Los mayoristas ver√°n el c√≥digo y datos bancarios despu√©s de hacer su pedido</li>
            </ol>
        </div>
    </div>

    <script>
        const sqls = {
            1: `-- Agregar campo payment_reference a la tabla orders
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS payment_reference VARCHAR(20) UNIQUE;

-- Crear √≠ndice para b√∫squedas r√°pidas
CREATE INDEX IF NOT EXISTS idx_orders_payment_reference
ON public.orders(payment_reference);`,

            2: `-- Crear tabla para configuraci√≥n bancaria
CREATE TABLE IF NOT EXISTS public.payment_config (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Insertar configuraci√≥n bancaria por defecto
INSERT INTO public.payment_config (config_key, config_value)
VALUES ('bank_info', '{
    "bank_name": "BBVA Bancomer",
    "account_holder": "Estudio Artesana S.A. de C.V.",
    "account_number": "0123456789",
    "clabe": "012345678901234567",
    "swift": "BCMRMXMM",
    "currency": "MXN",
    "reference_instructions": "Usa el c√≥digo de referencia que aparece en tu pedido"
}'::jsonb)
ON CONFLICT (config_key) DO NOTHING;

-- Habilitar RLS
ALTER TABLE public.payment_config ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica: Todos pueden leer
CREATE POLICY "Anyone can read payment config"
ON public.payment_config FOR SELECT
USING (true);

-- Pol√≠tica: Solo admins pueden actualizar
CREATE POLICY "Admins can update payment config"
ON public.payment_config FOR UPDATE
USING (true);

CREATE POLICY "Admins can insert payment config"
ON public.payment_config FOR INSERT
WITH CHECK (true);`,

            3: `-- Funci√≥n para generar c√≥digos de referencia
CREATE OR REPLACE FUNCTION generate_payment_reference()
RETURNS VARCHAR AS $$
DECLARE
    new_code VARCHAR(20);
    code_exists BOOLEAN;
    counter INT := 1;
BEGIN
    LOOP
        new_code := 'ESTUD-' || LPAD(counter::TEXT, 4, '0');

        SELECT EXISTS(
            SELECT 1 FROM orders WHERE payment_reference = new_code
        ) INTO code_exists;

        IF NOT code_exists THEN
            RETURN new_code;
        END IF;

        counter := counter + 1;

        IF counter > 9999 THEN
            RAISE EXCEPTION 'No se pudo generar c√≥digo de referencia √∫nico';
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- Trigger para auto-generar payment_reference
CREATE OR REPLACE FUNCTION auto_generate_payment_reference()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.order_type = 'wholesale' AND
       NEW.payment_method = 'transferencia' AND
       NEW.payment_reference IS NULL THEN
        NEW.payment_reference := generate_payment_reference();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_auto_payment_reference ON orders;
CREATE TRIGGER trigger_auto_payment_reference
    BEFORE INSERT ON orders
    FOR EACH ROW
    EXECUTE FUNCTION auto_generate_payment_reference();`
        };

        function copySQL(step) {
            navigator.clipboard.writeText(sqls[step]).then(() => {
                alert(`‚úÖ SQL Paso ${step} copiado!\n\nP√©galo en Supabase Dashboard > SQL Editor y ejec√∫talo.`);
            }).catch(() => {
                alert('‚ùå Error copiando. Copia manualmente el SQL.');
            });
        }
    </script>
</body>
</html>
