<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Subida de Imágenes - Artesana</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        
        .upload-progress {
            transition: width 0.3s ease;
        }

        .product-card {
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .image-preview {
            transition: all 0.3s ease;
        }

        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-image text-blue-600 mr-3"></i>
                        Asistente de Subida de Imágenes
                    </h1>
                    <p class="text-gray-600 mt-2">Gestiona las imágenes de productos que necesitan actualización</p>
                </div>
                <button onclick="loadProducts()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Actualizar
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Sin Imagen</p>
                        <p class="text-2xl font-bold text-gray-900" id="placeholderCount">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Con Imagen</p>
                        <p class="text-2xl font-bold text-gray-900" id="imageCount">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-percentage text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completado</p>
                        <p class="text-2xl font-bold text-gray-900" id="completionRate">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading-spinner border-4 border-gray-200 rounded-full w-12 h-12 mx-auto mb-4"></div>
            <p class="text-gray-600">Cargando productos...</p>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6" style="display: none;">
            <!-- Products will be loaded here -->
        </div>

        <!-- No Products Message -->
        <div id="noProductsMessage" class="text-center py-12 bg-white rounded-lg shadow" style="display: none;">
            <div class="text-6xl text-green-500 mb-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">¡Excelente!</h3>
            <p class="text-gray-600">Todos los productos tienen imágenes asignadas.</p>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800" id="modalProductName">Subir Imagen</h3>
                        <p class="text-sm text-gray-600" id="modalProductCategory">Categoría</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Upload Area -->
                <div class="mb-6">
                    <div id="dropZone" 
                         class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                        <div id="dropContent">
                            <div class="text-4xl text-gray-400 mb-4">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-700 mb-2">Arrastra tu imagen aquí</p>
                            <p class="text-sm text-gray-500 mb-4">o haz clic para seleccionar</p>
                            <div class="text-xs text-gray-400">
                                Formatos soportados: JPG, PNG, WebP (máx. 5MB)
                            </div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div id="previewArea" class="hidden">
                            <img id="imagePreview" class="max-w-full max-h-64 mx-auto rounded-lg shadow">
                            <div class="mt-4">
                                <p id="fileName" class="text-sm font-medium text-gray-700"></p>
                                <p id="fileSize" class="text-xs text-gray-500"></p>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div id="uploadProgress" class="hidden mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full upload-progress" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="text-sm text-gray-600 mt-2">Subiendo...</p>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="closeModal()" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button id="uploadBtn" onclick="uploadImage()" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-upload mr-2"></i>
                        Subir Imagen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://yrmfrfpyqctvwyhrhivl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlybWZyZnB5cWN0dnd5aHJoaXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NTg5MzUsImV4cCI6MjA3MzUzNDkzNX0.A5NDgNI91FvMhFxF19tLpUZnCwGrKwwUwYKCjdSDTqA';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlybWZyZnB5cWN0dnd5aHJoaXZsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzk1ODkzNSwiZXhwIjoyMDczNTM0OTM1fQ.2Mz8WaiP-I3MWFjt1VxbbK2Kg2AlMqZaMpmrd9XZO8s';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

        let currentProduct = null;
        let selectedFile = null;

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupDropZone();
        });

        // Cargar productos que usan placeholder
        async function loadProducts() {
            try {
                showLoading();
                
                const { data: products, error } = await supabaseClient
                    .from('products')
                    .select(`
                        id,
                        name,
                        slug,
                        main_image_url,
                        categories!inner(name, slug)
                    `)
                    .not('main_image_url', 'is', null);

                if (error) {
                    throw error;
                }

                // Separar productos con placeholder y con imagen
                const placeholderProducts = products.filter(p => 
                    p.main_image_url.includes('placeholder')
                );
                
                const imageProducts = products.filter(p => 
                    !p.main_image_url.includes('placeholder')
                );

                // Actualizar estadísticas
                updateStats(placeholderProducts.length, imageProducts.length);

                // Mostrar productos
                if (placeholderProducts.length === 0) {
                    showNoProducts();
                } else {
                    displayProducts(placeholderProducts);
                }

            } catch (error) {
                console.error('Error cargando productos:', error);
                showToast('Error cargando productos', 'error');
                hideLoading();
            }
        }

        // Mostrar productos en la grilla
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            products.forEach(product => {
                const productCard = createProductCard(product);
                grid.appendChild(productCard);
            });

            hideLoading();
            grid.style.display = 'grid';
        }

        // Crear tarjeta de producto
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow product-card';
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-1">${product.name}</h3>
                            <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">
                                ${product.categories.name}
                            </span>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-image text-gray-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
                            Sin imagen asignada
                        </div>
                        <button onclick="openUploadModal('${product.id}', '${product.name}', '${product.categories.name}', '${product.categories.slug}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-upload mr-1"></i>
                            Subir Imagen
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Actualizar estadísticas
        function updateStats(placeholderCount, imageCount) {
            const total = placeholderCount + imageCount;
            const completionRate = total > 0 ? Math.round((imageCount / total) * 100) : 0;

            document.getElementById('placeholderCount').textContent = placeholderCount;
            document.getElementById('imageCount').textContent = imageCount;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }

        // Mostrar estados de carga
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('productsGrid').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        function showNoProducts() {
            hideLoading();
            document.getElementById('noProductsMessage').style.display = 'block';
        }

        // Modal de subida
        function openUploadModal(productId, productName, categoryName, categorySlug) {
            currentProduct = {
                id: productId,
                name: productName,
                category: categoryName,
                categorySlug: categorySlug
            };

            document.getElementById('modalProductName').textContent = productName;
            document.getElementById('modalProductCategory').textContent = categoryName;
            document.getElementById('uploadModal').classList.remove('hidden');
            
            // Reset modal state
            resetModalState();
        }

        function closeModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            resetModalState();
            currentProduct = null;
            selectedFile = null;
        }

        function resetModalState() {
            document.getElementById('dropContent').style.display = 'block';
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('progressBar').style.width = '0%';
        }

        // Setup drag and drop
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // Click to select file
            dropZone.addEventListener('click', () => fileInput.click());
            
            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validar archivo
            if (!file.type.startsWith('image/')) {
                showToast('Por favor selecciona un archivo de imagen', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('El archivo es muy grande. Máximo 5MB', 'error');
                return;
            }

            selectedFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                
                document.getElementById('dropContent').style.display = 'none';
                document.getElementById('previewArea').classList.remove('hidden');
                document.getElementById('uploadBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Subir imagen
        async function uploadImage() {
            if (!selectedFile || !currentProduct) {
                return;
            }

            try {
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('uploadBtn').disabled = true;

                // Generar nombre de archivo
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `principal.${fileExt}`;
                const filePath = `${currentProduct.category}/${currentProduct.name}/${fileName}`;

                // Subir archivo al bucket
                const { data, error } = await supabaseClient.storage
                    .from('product-images')
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) {
                    throw error;
                }

                // Construir nueva URL
                const newImageUrl = `${SUPABASE_URL}/storage/v1/object/public/product-images/${filePath}`;

                // Actualizar producto en la base de datos
                const { error: updateError } = await supabaseClient
                    .from('products')
                    .update({ main_image_url: newImageUrl })
                    .eq('id', currentProduct.id);

                if (updateError) {
                    throw updateError;
                }

                // Éxito
                showToast('Imagen subida exitosamente', 'success');
                closeModal();
                loadProducts(); // Recargar productos

            } catch (error) {
                console.error('Error subiendo imagen:', error);
                showToast('Error subiendo la imagen: ' + error.message, 'error');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        }

        // Utilidades
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            
            // Mostrar toast
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            
            // Ocultar toast
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    <!-- Admin Authentication Guard -->
    <script src="admin-auth-guard.js"></script>
</body>
</html>
