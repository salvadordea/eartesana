<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>Diagn√≥stico WordPress Auth - Estudio Artesana</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #D4AF37;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .test-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .test-result {
            font-family: monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        button {
            background: #D4AF37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #B8941F;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico WordPress Authentication</h1>
        
        <div class="form-group">
            <label for="wpUrl">WordPress Base URL:</label>
            <input type="url" id="wpUrl" value="https://estudioartesana.com" />
        </div>

        <div class="form-group">
            <label for="testUser">Usuario de prueba:</label>
            <input type="text" id="testUser" placeholder="admin" />
        </div>

        <div class="form-group">
            <label for="testPass">Contrase√±a de prueba:</label>
            <input type="password" id="testPass" />
        </div>

        <button onclick="runAllTests()">üöÄ Ejecutar Todos los Tests</button>
        <button onclick="clearResults()">üßπ Limpiar Resultados</button>
        
        <div class="test-section">
            <div class="test-title">1. WordPress REST API Status</div>
            <button onclick="testWordPressAPI()">Test API Base</button>
            <div id="wp-api-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. Authentication Methods Available</div>
            <button onclick="testAuthMethods()">Detectar M√©todos</button>
            <div id="auth-methods-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. Basic Authentication Test</div>
            <button onclick="testBasicAuth()">Test Basic Auth</button>
            <div id="basic-auth-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. Application Passwords Test</div>
            <button onclick="testApplicationPasswords()">Test App Passwords</button>
            <div id="app-pass-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. JWT Authentication Test</div>
            <button onclick="testJWTAuth()">Test JWT</button>
            <div id="jwt-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">6. Cookie Authentication Test</div>
            <button onclick="testCookieAuth()">Test Cookies</button>
            <div id="cookie-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">7. CORS Configuration</div>
            <button onclick="testCORS()">Test CORS</button>
            <div id="cors-result" class="test-result"></div>
        </div>
    </div>

    <script>
        let wpBaseURL = 'https://estudioartesana.com';

        function updateBaseURL() {
            wpBaseURL = document.getElementById('wpUrl').value.replace(/\/$/, '');
        }

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : 
                             type === 'error' ? 'error' : 
                             type === 'warning' ? 'warning' : 'info';
            
            element.innerHTML += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            const results = document.querySelectorAll('.test-result');
            results.forEach(result => result.innerHTML = '');
        }

        async function runAllTests() {
            updateBaseURL();
            clearResults();
            
            log('wp-api-result', 'üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            await testWordPressAPI();
            await testAuthMethods();
            await testBasicAuth();
            await testApplicationPasswords();
            await testJWTAuth();
            await testCookieAuth();
            await testCORS();
            
            log('wp-api-result', '‚úÖ Diagn√≥stico completado', 'success');
        }

        async function testWordPressAPI() {
            updateBaseURL();
            log('wp-api-result', 'Verificando WordPress REST API...', 'info');
            
            try {
                const response = await fetch(`${wpBaseURL}/wp-json/wp/v2/`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (response.ok) {
                    const data = await response.json();
                    log('wp-api-result', '‚úÖ WordPress REST API activo', 'success');
                    log('wp-api-result', `üìã Namespace: ${data.namespaces?.join(', ')}`, 'info');
                    log('wp-api-result', `üîó URL: ${wpBaseURL}/wp-json/wp/v2/`, 'info');
                } else {
                    log('wp-api-result', `‚ùå Error ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('wp-api-result', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testAuthMethods() {
            updateBaseURL();
            log('auth-methods-result', 'Detectando m√©todos de autenticaci√≥n...', 'info');
            
            // Test users/me endpoint without auth
            try {
                const response = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                    method: 'GET',
                    mode: 'cors'
                });

                const responseText = await response.text();
                log('auth-methods-result', `üì° Response Status: ${response.status}`, 'info');
                
                if (response.status === 401) {
                    log('auth-methods-result', '‚úÖ Endpoint /users/me requiere autenticaci√≥n (correcto)', 'success');
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        log('auth-methods-result', `üìã Error Code: ${errorData.code}`, 'info');
                        log('auth-methods-result', `üí¨ Message: ${errorData.message}`, 'info');
                    } catch (e) {
                        log('auth-methods-result', 'üìã Respuesta no es JSON v√°lido', 'warning');
                    }
                } else {
                    log('auth-methods-result', '‚ö†Ô∏è Endpoint accesible sin auth (posible configuraci√≥n insegura)', 'warning');
                }
            } catch (error) {
                log('auth-methods-result', `‚ùå Error: ${error.message}`, 'error');
            }

            // Check for JWT endpoint
            try {
                const jwtResponse = await fetch(`${wpBaseURL}/wp-json/jwt-auth/v1/token/validate`, {
                    method: 'POST',
                    mode: 'cors'
                });
                
                log('auth-methods-result', `üîê JWT endpoint status: ${jwtResponse.status}`, 'info');
                
                if (jwtResponse.status !== 404) {
                    log('auth-methods-result', '‚úÖ JWT Authentication plugin detectado', 'success');
                } else {
                    log('auth-methods-result', '‚ùå JWT Authentication plugin no encontrado', 'warning');
                }
            } catch (error) {
                log('auth-methods-result', '‚ùå JWT plugin no disponible', 'warning');
            }
        }

        async function testBasicAuth() {
            const username = document.getElementById('testUser').value;
            const password = document.getElementById('testPass').value;
            
            if (!username || !password) {
                log('basic-auth-result', '‚ö†Ô∏è Introduce usuario y contrase√±a para probar', 'warning');
                return;
            }
            
            updateBaseURL();
            log('basic-auth-result', 'Probando Basic Authentication...', 'info');
            
            const basicAuth = btoa(username + ':' + password);
            
            try {
                const response = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${basicAuth}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });

                const responseText = await response.text();
                log('basic-auth-result', `üì° Status: ${response.status}`, 'info');

                if (response.ok) {
                    const userData = JSON.parse(responseText);
                    log('basic-auth-result', '‚úÖ Basic Auth EXITOSO', 'success');
                    log('basic-auth-result', `üë§ Usuario: ${userData.name}`, 'success');
                    log('basic-auth-result', `üîë Roles: ${userData.roles?.join(', ')}`, 'success');
                    log('basic-auth-result', `üìß Email: ${userData.email}`, 'info');
                } else {
                    log('basic-auth-result', '‚ùå Basic Auth FALL√ì', 'error');
                    try {
                        const errorData = JSON.parse(responseText);
                        log('basic-auth-result', `üìã Error: ${errorData.message}`, 'error');
                        log('basic-auth-result', `üîç Code: ${errorData.code}`, 'error');
                    } catch (e) {
                        log('basic-auth-result', `üìã Response: ${responseText}`, 'error');
                    }
                }
            } catch (error) {
                log('basic-auth-result', `‚ùå Error: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log('basic-auth-result', 'üö® Posible problema de CORS', 'warning');
                }
            }
        }

        async function testApplicationPasswords() {
            const username = document.getElementById('testUser').value;
            const password = document.getElementById('testPass').value;
            
            if (!username || !password) {
                log('app-pass-result', '‚ö†Ô∏è Introduce usuario y contrase√±a para probar', 'warning');
                return;
            }
            
            updateBaseURL();
            log('app-pass-result', 'Probando Application Passwords...', 'info');
            
            const appAuth = btoa(username + ':' + password);
            
            try {
                const response = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${appAuth}`,
                        'Content-Type': 'application/json',
                        'X-WP-Application-Password': 'true'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });

                const responseText = await response.text();
                log('app-pass-result', `üì° Status: ${response.status}`, 'info');

                if (response.ok) {
                    const userData = JSON.parse(responseText);
                    log('app-pass-result', '‚úÖ Application Password EXITOSO', 'success');
                    log('app-pass-result', `üë§ Usuario: ${userData.name}`, 'success');
                    log('app-pass-result', `üîë Roles: ${userData.roles?.join(', ')}`, 'success');
                } else {
                    log('app-pass-result', '‚ùå Application Password FALL√ì', 'error');
                    try {
                        const errorData = JSON.parse(responseText);
                        log('app-pass-result', `üìã Error: ${errorData.message}`, 'error');
                    } catch (e) {
                        log('app-pass-result', `üìã Response: ${responseText}`, 'error');
                    }
                }
            } catch (error) {
                log('app-pass-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testJWTAuth() {
            const username = document.getElementById('testUser').value;
            const password = document.getElementById('testPass').value;
            
            if (!username || !password) {
                log('jwt-result', '‚ö†Ô∏è Introduce usuario y contrase√±a para probar', 'warning');
                return;
            }
            
            updateBaseURL();
            log('jwt-result', 'Probando JWT Authentication...', 'info');
            
            try {
                // Step 1: Get JWT token
                const tokenResponse = await fetch(`${wpBaseURL}/wp-json/jwt-auth/v1/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    }),
                    mode: 'cors'
                });

                const tokenText = await tokenResponse.text();
                log('jwt-result', `üì° Token request status: ${tokenResponse.status}`, 'info');

                if (tokenResponse.ok) {
                    const tokenData = JSON.parse(tokenText);
                    log('jwt-result', '‚úÖ JWT Token obtenido', 'success');
                    
                    // Step 2: Use token to access protected endpoint
                    const userResponse = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${tokenData.token}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        log('jwt-result', '‚úÖ JWT Auth EXITOSO', 'success');
                        log('jwt-result', `üë§ Usuario: ${userData.name}`, 'success');
                    } else {
                        log('jwt-result', '‚ùå JWT token v√°lido pero acceso fall√≥', 'error');
                    }
                } else {
                    log('jwt-result', '‚ùå JWT plugin no disponible o credenciales incorrectas', 'error');
                    log('jwt-result', `üìã Response: ${tokenText}`, 'error');
                }
            } catch (error) {
                log('jwt-result', `‚ùå Error: ${error.message}`, 'error');
                log('jwt-result', 'üí° Probablemente JWT plugin no est√° instalado', 'warning');
            }
        }

        async function testCookieAuth() {
            const username = document.getElementById('testUser').value;
            const password = document.getElementById('testPass').value;
            
            if (!username || !password) {
                log('cookie-result', '‚ö†Ô∏è Introduce usuario y contrase√±a para probar', 'warning');
                return;
            }
            
            updateBaseURL();
            log('cookie-result', 'Probando Cookie Authentication...', 'info');
            
            try {
                // Step 1: Login via wp-login.php
                const loginResponse = await fetch(`${wpBaseURL}/wp-login.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `log=${encodeURIComponent(username)}&pwd=${encodeURIComponent(password)}&wp-submit=Log+In&redirect_to=${encodeURIComponent(wpBaseURL)}/wp-admin/`,
                    mode: 'cors',
                    credentials: 'include',
                    redirect: 'manual'
                });

                log('cookie-result', `üì° Login status: ${loginResponse.status}`, 'info');

                if (loginResponse.status === 0 || loginResponse.type === 'opaqueredirect') {
                    // CORS blocked the response, but might have set cookies
                    log('cookie-result', '‚ö†Ô∏è Login response bloqueado por CORS', 'warning');
                } else if (loginResponse.redirected || loginResponse.status === 302) {
                    log('cookie-result', '‚úÖ Login redirect detectado', 'success');
                }

                // Step 2: Try to access protected endpoint with cookies
                const userResponse = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    log('cookie-result', '‚úÖ Cookie Auth EXITOSO', 'success');
                    log('cookie-result', `üë§ Usuario: ${userData.name}`, 'success');
                } else {
                    log('cookie-result', '‚ùå Cookie Auth fall√≥ o CORS bloque√≥ cookies', 'error');
                    const errorText = await userResponse.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        log('cookie-result', `üìã Error: ${errorData.message}`, 'error');
                    } catch (e) {
                        log('cookie-result', `üìã Response: ${errorText}`, 'error');
                    }
                }
            } catch (error) {
                log('cookie-result', `‚ùå Error: ${error.message}`, 'error');
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    log('cookie-result', 'üö® CORS est√° bloqueando la autenticaci√≥n por cookies', 'warning');
                }
            }
        }

        async function testCORS() {
            updateBaseURL();
            log('cors-result', 'Analizando configuraci√≥n CORS...', 'info');
            
            try {
                const response = await fetch(`${wpBaseURL}/wp-json/wp/v2/`, {
                    method: 'GET',
                    mode: 'cors'
                });

                const headers = response.headers;
                log('cors-result', 'üìã Headers CORS encontrados:', 'info');
                
                const corsHeaders = [
                    'Access-Control-Allow-Origin',
                    'Access-Control-Allow-Methods',
                    'Access-Control-Allow-Headers',
                    'Access-Control-Allow-Credentials',
                    'Access-Control-Max-Age'
                ];

                let corsFound = false;
                corsHeaders.forEach(header => {
                    const value = headers.get(header);
                    if (value) {
                        corsFound = true;
                        log('cors-result', `‚úÖ ${header}: ${value}`, 'success');
                    } else {
                        log('cors-result', `‚ùå ${header}: No presente`, 'error');
                    }
                });

                if (!corsFound) {
                    log('cors-result', 'üö® PROBLEMA: No se detectaron headers CORS', 'error');
                    log('cors-result', 'üí° Soluci√≥n: Instalar plugin de CORS en WordPress', 'warning');
                    log('cors-result', 'üîß Plugin recomendado: "CORS" by WP CORS', 'info');
                } else {
                    log('cors-result', '‚úÖ CORS configurado', 'success');
                }

                // Test preflight request
                try {
                    const preflightResponse = await fetch(`${wpBaseURL}/wp-json/wp/v2/users/me`, {
                        method: 'OPTIONS',
                        headers: {
                            'Access-Control-Request-Method': 'GET',
                            'Access-Control-Request-Headers': 'authorization,content-type'
                        },
                        mode: 'cors'
                    });

                    log('cors-result', `üì° Preflight status: ${preflightResponse.status}`, 'info');
                    
                    if (preflightResponse.ok) {
                        log('cors-result', '‚úÖ Preflight request exitoso', 'success');
                    } else {
                        log('cors-result', '‚ùå Preflight request fall√≥', 'error');
                    }
                } catch (preflightError) {
                    log('cors-result', `‚ùå Preflight error: ${preflightError.message}`, 'error');
                }

            } catch (error) {
                log('cors-result', `‚ùå Error CORS: ${error.message}`, 'error');
                log('cors-result', 'üö® WordPress est√° bloqueando todas las requests desde este origen', 'error');
            }
        }
    </script>
</body>
</html>
