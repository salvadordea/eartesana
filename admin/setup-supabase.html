<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Supabase - Usuarios y RLS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c2c2c;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .button {
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s ease;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }

        .user-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .credentials {
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cog"></i> Setup Supabase</h1>
            <p>Configuraci√≥n de usuarios y tablas para Estudio Artesana</p>
        </div>

        <!-- Status de conexi√≥n -->
        <div class="section">
            <h2><i class="fas fa-wifi"></i> Estado de Conexi√≥n</h2>
            <button class="button" onclick="testConnection()">
                <i class="fas fa-plug"></i> Probar Conexi√≥n
            </button>
            <div id="connectionLog" class="log"></div>
        </div>

        <!-- Crear usuarios -->
        <div class="section">
            <h2><i class="fas fa-users"></i> Crear Usuarios de Administraci√≥n</h2>
            
            <div class="user-info">
                <h4>üë®‚Äçüíº Usuario Administrador</h4>
                <div class="credentials">Email: salvadordeaguinaga@gmail.com</div>
                <div class="credentials">Password: ZaqXsw124!</div>
                <div class="credentials">Rol: admin</div>
            </div>

            <div class="user-info">
                <h4>üè™ Usuario Mayorista</h4>
                <div class="credentials">Email: mayorista@artesana.com</div>
                <div class="credentials">Password: mayorista123</div>
                <div class="credentials">Rol: mayorista</div>
            </div>

            <div class="user-info">
                <h4>üë§ Usuario Normal</h4>
                <div class="credentials">Email: user@artesana.com</div>
                <div class="credentials">Password: user123</div>
                <div class="credentials">Rol: user</div>
            </div>

            <button class="button" onclick="createUsers()">
                <i class="fas fa-user-plus"></i> Crear Usuarios
            </button>
            <div id="usersLog" class="log"></div>
        </div>

        <!-- Configurar tablas y RLS -->
        <div class="section">
            <h2><i class="fas fa-table"></i> Configurar Tablas y RLS</h2>
            <p style="margin-bottom: 15px;">Verificar y configurar Row Level Security en las tablas p√∫blicas:</p>
            
            <button class="button" onclick="checkTables()">
                <i class="fas fa-search"></i> Verificar Tablas
            </button>
            <button class="button" onclick="setupRLS()">
                <i class="fas fa-shield-alt"></i> Configurar RLS
            </button>
            <button class="button" onclick="createPolicies()">
                <i class="fas fa-key"></i> Crear Pol√≠ticas
            </button>
            <div id="tablesLog" class="log"></div>
        </div>

        <!-- Test final -->
        <div class="section">
            <h2><i class="fas fa-check-circle"></i> Pruebas Finales</h2>
            <button class="button" onclick="testUserLogin()">
                <i class="fas fa-sign-in-alt"></i> Probar Login Admin
            </button>
            <button class="button" onclick="testDataAccess()">
                <i class="fas fa-database"></i> Probar Acceso a Datos
            </button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script>
        let supabase;
        
        // Inicializar Supabase
        function initSupabase() {
            if (window.SUPABASE_CONFIG) {
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );
                return true;
            }
            return false;
        }

        // Funci√≥n para logging
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Probar conexi√≥n
        async function testConnection() {
            const logId = 'connectionLog';
            document.getElementById(logId).innerHTML = '';
            
            if (!initSupabase()) {
                log(logId, 'Error: Configuraci√≥n de Supabase no encontrada', 'error');
                return false;
            }

            try {
                log(logId, 'Probando conexi√≥n a Supabase...', 'info');
                
                // Test b√°sico de conexi√≥n
                const { data, error } = await supabase.from('products').select('count').limit(1);
                
                if (error) {
                    log(logId, `Error de conexi√≥n: ${error.message}`, 'error');
                    return false;
                } else {
                    log(logId, 'Conexi√≥n exitosa a Supabase ‚úÖ', 'success');
                    log(logId, `URL: ${window.SUPABASE_CONFIG.url}`, 'info');
                    return true;
                }
            } catch (error) {
                log(logId, `Error inesperado: ${error.message}`, 'error');
                return false;
            }
        }

        // Crear usuarios
        async function createUsers() {
            const logId = 'usersLog';
            document.getElementById(logId).innerHTML = '';

            if (!supabase) {
                if (!initSupabase()) {
                    log(logId, 'Error: No se pudo inicializar Supabase', 'error');
                    return;
                }
            }

            const users = [
                { email: 'salvadordeaguinaga@gmail.com', password: 'ZaqXsw124!', role: 'admin' },
                { email: 'mayorista@artesana.com', password: 'mayorista123', role: 'mayorista' },
                { email: 'user@artesana.com', password: 'user123', role: 'user' }
            ];

            log(logId, 'Iniciando creaci√≥n de usuarios...', 'info');

            for (const user of users) {
                try {
                    log(logId, `Creando usuario: ${user.email} (${user.role})`, 'info');
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: user.email,
                        password: user.password,
                        options: {
                            data: {
                                role: user.role,
                                full_name: `Usuario ${user.role}`
                            }
                        }
                    });

                    if (error) {
                        if (error.message.includes('already registered')) {
                            log(logId, `Usuario ${user.email} ya existe ‚úÖ`, 'warning');
                        } else {
                            log(logId, `Error creando ${user.email}: ${error.message}`, 'error');
                        }
                    } else {
                        log(logId, `Usuario ${user.email} creado exitosamente ‚úÖ`, 'success');
                    }

                    // Pausa entre creaciones
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    log(logId, `Error inesperado con ${user.email}: ${error.message}`, 'error');
                }
            }

            log(logId, 'Proceso de creaci√≥n de usuarios completado', 'info');
        }

        // Verificar tablas
        async function checkTables() {
            const logId = 'tablesLog';
            document.getElementById(logId).innerHTML = '';

            if (!supabase) {
                if (!initSupabase()) {
                    log(logId, 'Error: No se pudo inicializar Supabase', 'error');
                    return;
                }
            }

            const tables = ['products', 'categories', 'product_categories', 'product_images', 'product_variants', 'products_full'];
            
            log(logId, 'Verificando tablas en schema p√∫blico...', 'info');

            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    
                    if (error) {
                        if (error.message.includes('relation') && error.message.includes('does not exist')) {
                            log(logId, `‚ùå Tabla '${table}' no existe`, 'error');
                        } else if (error.message.includes('RLS')) {
                            log(logId, `‚ö†Ô∏è Tabla '${table}' existe pero RLS est√° bloqueando acceso`, 'warning');
                        } else {
                            log(logId, `‚ö†Ô∏è Error en tabla '${table}': ${error.message}`, 'warning');
                        }
                    } else {
                        log(logId, `‚úÖ Tabla '${table}' accesible`, 'success');
                    }
                } catch (error) {
                    log(logId, `Error verificando tabla '${table}': ${error.message}`, 'error');
                }
            }
        }

        // Configurar RLS (esto requiere permisos de admin)
        async function setupRLS() {
            const logId = 'tablesLog';
            log(logId, '‚ö†Ô∏è Configuraci√≥n de RLS requiere acceso directo a la base de datos', 'warning');
            log(logId, 'Ve al SQL Editor de Supabase y ejecuta:', 'info');
            log(logId, '', 'info');
            log(logId, '-- Habilitar RLS en tablas principales', 'info');
            log(logId, 'ALTER TABLE products ENABLE ROW LEVEL SECURITY;', 'info');
            log(logId, 'ALTER TABLE categories ENABLE ROW LEVEL SECURITY;', 'info');
            log(logId, 'ALTER TABLE product_categories ENABLE ROW LEVEL SECURITY;', 'info');
            log(logId, 'ALTER TABLE product_images ENABLE ROW LEVEL SECURITY;', 'info');
            log(logId, 'ALTER TABLE product_variants ENABLE ROW LEVEL SECURITY;', 'info');
            log(logId, '', 'info');
            log(logId, '-- Nota: products_full es una vista, no necesita RLS', 'info');
        }

        // Crear pol√≠ticas
        async function createPolicies() {
            const logId = 'tablesLog';
            log(logId, '‚ö†Ô∏è Creaci√≥n de pol√≠ticas requiere acceso directo a la base de datos', 'warning');
            log(logId, 'Ve al SQL Editor de Supabase y ejecuta:', 'info');
            log(logId, '', 'info');
            
            const policies = `
-- Pol√≠ticas para productos (lectura p√∫blica, escritura para admins)
CREATE POLICY "Products p√∫blicos para lectura" ON products FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden modificar products" ON products FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Pol√≠ticas para categor√≠as
CREATE POLICY "Categories p√∫blicas para lectura" ON categories FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden modificar categories" ON categories FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Pol√≠ticas para relaciones producto-categor√≠a
CREATE POLICY "Product_categories p√∫blicas para lectura" ON product_categories FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden modificar product_categories" ON product_categories FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Pol√≠ticas para im√°genes de productos
CREATE POLICY "Product_images p√∫blicas para lectura" ON product_images FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden modificar product_images" ON product_images FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Pol√≠ticas para variaciones de productos
CREATE POLICY "Product_variants p√∫blicas para lectura" ON product_variants FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden modificar product_variants" ON product_variants FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Nota: products_full es una vista, no necesita pol√≠ticas RLS
-- Las vistas heredan las pol√≠ticas de las tablas subyacentes

-- Nota: Los usuarios est√°n en auth.users - no necesitan pol√≠ticas RLS adicionales
-- El acceso a auth.users se maneja autom√°ticamente por Supabase Auth
            `.trim();
            
            log(logId, policies, 'info');
        }

        // Probar login de admin
        async function testUserLogin() {
            const logId = 'testLog';
            document.getElementById(logId).innerHTML = '';

            if (!supabase) {
                if (!initSupabase()) {
                    log(logId, 'Error: No se pudo inicializar Supabase', 'error');
                    return;
                }
            }

            try {
                log(logId, 'Probando login del usuario admin...', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'salvadordeaguinaga@gmail.com',
                    password: 'ZaqXsw124!'
                });

                if (error) {
                    log(logId, `Error en login: ${error.message}`, 'error');
                    return;
                }

                if (data.user) {
                    log(logId, `Login exitoso ‚úÖ`, 'success');
                    log(logId, `Usuario: ${data.user.email}`, 'info');
                    log(logId, `ID: ${data.user.id}`, 'info');
                    log(logId, `Rol: ${data.user.user_metadata?.role || 'no definido'}`, 'info');
                    
                    // Cerrar sesi√≥n
                    await supabase.auth.signOut();
                    log(logId, 'Sesi√≥n cerrada correctamente', 'info');
                }

            } catch (error) {
                log(logId, `Error inesperado: ${error.message}`, 'error');
            }
        }

        // Probar acceso a datos
        async function testDataAccess() {
            const logId = 'testLog';
            log(logId, 'Probando acceso a datos...', 'info');

            const tables = ['products', 'categories'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(3);
                    
                    if (error) {
                        log(logId, `‚ùå Error accediendo a '${table}': ${error.message}`, 'error');
                    } else {
                        log(logId, `‚úÖ Acceso exitoso a '${table}' (${data?.length || 0} registros)`, 'success');
                    }
                } catch (error) {
                    log(logId, `Error inesperado con '${table}': ${error.message}`, 'error');
                }
            }
        }

        // Inicializar al cargar
        window.addEventListener('load', function() {
            setTimeout(() => {
                testConnection();
            }, 1000);
        });
    </script>
</body>
</html>
