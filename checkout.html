<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Estudio Artesana</title>
    <meta name="description" content="Finalizar compra en Estudio Artesana - Productos artesanales √∫nicos">

    <!-- CSS -->
    <link rel="stylesheet" href="./assets/css/styles.css">
    <link rel="stylesheet" href="./assets/css/cart.css">
    <link rel="stylesheet" href="./assets/css/shipping-calculator.css">
    <link rel="stylesheet" href="./assets/css/payment-methods.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Checkout Styles -->
    <style>
        .checkout-container {
            min-height: 100vh;
            background: #f8f9fa;
            padding: 40px 0;
        }

        .checkout-header {
            background: white;
            padding: 20px 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 40px;
        }

        .checkout-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .checkout-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .checkout-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            margin: 0 0 20px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
            color: #333;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .checkout-summary {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .summary-header {
            margin: 0 0 20px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-details {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .item-quantity {
            font-size: 12px;
            color: #6c757d;
        }

        .item-price {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .order-total {
            border-top: 2px solid #e9ecef;
            padding-top: 16px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-row.final {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        /* Coupon Section */
        .coupon-section {
            margin: 20px 0;
            padding: 20px 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .coupon-input-group {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
        }

        .coupon-section input {
            text-transform: uppercase;
        }

        .coupon-section input::placeholder {
            text-transform: none;
        }

        .coupon-applied,
        .coupon-error {
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .checkout-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkout-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
        }

        .checkout-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .back-to-cart {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 30px;
            transition: color 0.2s ease;
        }

        .back-to-cart:hover {
            color: #0056b3;
        }

        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-cart i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .empty-cart h2 {
            margin: 0 0 12px 0;
            color: #333;
        }

        .empty-cart p {
            color: #6c757d;
            margin: 0 0 30px 0;
        }

        .btn-shop {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Login Link and Account Section */
        .account-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .account-link {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .account-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .user-info-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }

        .user-info-badge i {
            color: #28a745;
        }

        .logout-link {
            color: #dc3545;
            text-decoration: none;
            font-size: 13px;
            margin-left: 10px;
        }

        .logout-link:hover {
            text-decoration: underline;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-modal.active {
            display: flex;
        }

        .login-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            padding: 30px;
            position: relative;
        }

        .login-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .login-modal-title {
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            color: #333;
        }

        .login-form-group {
            margin-bottom: 15px;
        }

        .login-form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .login-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .login-btn {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .login-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }

        .login-footer {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #6c757d;
        }

        .login-footer a {
            color: #007bff;
            text-decoration: none;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        /* Create Account Checkbox */
        .create-account-section {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 20px 0;
        }

        .create-account-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .create-account-label input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .create-account-benefits {
            margin-top: 10px;
            padding-left: 28px;
            font-size: 13px;
            color: #6c757d;
            display: none;
        }

        .create-account-benefits.show {
            display: block;
        }

        .create-account-benefits li {
            margin-bottom: 5px;
        }

        /* Password Modal for Account Creation */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .password-modal.active {
            display: flex;
        }

        .password-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            padding: 30px;
        }

        .password-modal-title {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            color: #333;
        }

        .password-modal-subtitle {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .checkout-summary {
                position: static;
                order: -1;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .checkout-container {
                padding: 20px 0;
            }

            .account-section {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Header Universal Container -->
    <div id="universal-header-container">
        <!-- El header se carga din√°micamente aqu√≠ -->
    </div>

    <div class="checkout-container">
        <!-- Checkout Header -->
        <div class="checkout-header">
            <div class="container">
                <h1>
                    <i class="fas fa-credit-card"></i>
                    Finalizar Compra
                </h1>
            </div>
        </div>

        <!-- Checkout Content -->
        <div class="checkout-content" id="checkoutContent">
            <!-- Loading State -->
            <div id="checkoutLoading" class="text-center">
                <div class="loading-spinner"></div>
                <p>Cargando checkout...</p>
            </div>

            <!-- Empty Cart State -->
            <div id="emptyCartState" class="empty-cart" style="display: none; grid-column: 1 / -1;">
                <i class="fas fa-shopping-bag"></i>
                <h2>Tu carrito est√° vac√≠o</h2>
                <p>Agrega algunos productos para continuar con tu compra</p>
                <a href="tienda.html" class="btn-shop">
                    <i class="fas fa-arrow-left"></i>
                    Ir a la Tienda
                </a>
            </div>

            <!-- Checkout Form -->
            <div id="checkoutForm" class="checkout-form" style="display: none;">
                <a href="#" id="backToCart" class="back-to-cart">
                    <i class="fas fa-arrow-left"></i>
                    Volver al carrito
                </a>

                <!-- Account Section (Guest vs Logged In) -->
                <div class="account-section">
                    <!-- Guest Mode: Show login link -->
                    <div id="guestMode" class="account-link-container">
                        <a href="#" id="showLoginLink" class="account-link">
                            <i class="fas fa-user"></i>
                            ¬øYa tienes cuenta? Inicia sesi√≥n
                        </a>
                    </div>

                    <!-- Authenticated Mode: Show user info -->
                    <div id="authenticatedMode" class="user-info-badge" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Continuar como <strong id="userEmailDisplay"></strong></span>
                        <a href="#" id="logoutLink" class="logout-link">Cerrar sesi√≥n</a>
                    </div>
                </div>

                <form id="orderForm">
                    <!-- Customer Information -->
                    <div class="form-section">
                        <h2>
                            <i class="fas fa-user"></i>
                            Informaci√≥n de Contacto
                        </h2>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" class="form-input" required
                                   placeholder="tu@email.com">
                        </div>
                        <div class="form-group">
                            <label for="phone">Tel√©fono *</label>
                            <input type="tel" id="phone" name="phone" class="form-input" required
                                   placeholder="+52 555 123 4567">
                        </div>
                    </div>

                    <!-- Shipping Information -->
                    <div class="form-section">
                        <h2>
                            <i class="fas fa-truck"></i>
                            Informaci√≥n de Env√≠o
                        </h2>

                        <!-- Saved Addresses Selector (only shown if user is logged in) -->
                        <div id="savedAddressesSection" class="form-group" style="display: none;">
                            <label for="savedAddress">
                                <i class="fas fa-map-marker-alt"></i>
                                Direcciones Guardadas
                            </label>
                            <select id="savedAddress" class="form-input" onchange="loadSavedAddress()">
                                <option value="">Nueva direcci√≥n</option>
                                <!-- Saved addresses will be loaded here -->
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">Nombre *</label>
                                <input type="text" id="firstName" name="firstName" class="form-input" required
                                       placeholder="Juan">
                            </div>
                            <div class="form-group">
                                <label for="lastName">Apellido *</label>
                                <input type="text" id="lastName" name="lastName" class="form-input" required
                                       placeholder="P√©rez">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Direcci√≥n *</label>
                            <input type="text" id="address" name="address" class="form-input" required
                                   placeholder="Calle 123, Col. Centro">
                        </div>
                        <div class="form-group">
                            <label for="addressLine2">Direcci√≥n L√≠nea 2 (opcional)</label>
                            <input type="text" id="addressLine2" name="addressLine2" class="form-input"
                                   placeholder="Depto, piso, etc.">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="postalCode">C√≥digo Postal *</label>
                                <input type="text" id="postalCode" name="postalCode" class="form-input" required
                                       placeholder="01000" maxlength="5" pattern="[0-9]{5}">
                                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 4px;">
                                    <i class="fas fa-info-circle"></i> 5 d√≠gitos
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="city">Ciudad *</label>
                                <input type="text" id="city" name="city" class="form-input" required
                                       placeholder="Ciudad de M√©xico">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="state">Estado *</label>
                            <input type="text" id="state" name="state" class="form-input" required
                                   placeholder="CDMX">
                        </div>

                        <!-- Save address checkbox (only for logged in users) -->
                        <div id="saveAddressCheckbox" class="form-group" style="display: none;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="saveAddress" name="saveAddress">
                                <span>Guardar esta direcci√≥n para futuras compras</span>
                            </label>
                        </div>
                    </div>

                    <!-- Shipping Calculator -->
                    <div class="form-section">
                        <h2>
                            <i class="fas fa-calculator"></i>
                            Opciones de Env√≠o
                        </h2>

                        <div class="shipping-calculator-section">
                            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                                Ingresa tu c√≥digo postal para calcular el costo de env√≠o
                            </p>

                            <div class="shipping-zip-input-group">
                                <input
                                    type="text"
                                    id="shippingZipCode"
                                    class="shipping-zip-input"
                                    placeholder="C√≥digo postal (ej: 01000)"
                                    maxlength="5"
                                    pattern="[0-9]{5}"
                                >
                                <button
                                    type="button"
                                    id="calculateShippingBtn"
                                    class="shipping-calculate-btn"
                                    onclick="calculateShipping()"
                                >
                                    <i class="fas fa-calculator"></i> Calcular
                                </button>
                            </div>

                            <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> El c√≥digo postal debe tener 5 d√≠gitos
                            </small>
                        </div>

                        <!-- Shipping Options Container -->
                        <div id="shippingOptionsContainer" class="shipping-options-container"></div>
                    </div>

                    <!-- Order Notes -->
                    <div class="form-section">
                        <h2>
                            <i class="fas fa-comment"></i>
                            Notas del Pedido
                        </h2>
                        <div class="form-group">
                            <label for="orderNotes">Comentarios adicionales (opcional)</label>
                            <textarea id="orderNotes" name="orderNotes" class="form-input" rows="4"
                                      placeholder="Instrucciones especiales para la entrega..."></textarea>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="form-section payment-method-section">
                        <h2 class="section-title">
                            <i class="fas fa-credit-card"></i>
                            M√©todo de Pago
                        </h2>
                        <div class="payment-methods">
                            <label class="payment-method-option">
                                <input type="radio" name="paymentMethod" value="card" checked>
                                <div class="payment-method-card">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <strong>Tarjeta de Cr√©dito/D√©bito</strong>
                                        <small>Visa, Mastercard, American Express</small>
                                    </div>
                                    <div class="payment-method-badges">
                                        <i class="fab fa-cc-visa"></i>
                                        <i class="fab fa-cc-mastercard"></i>
                                        <i class="fab fa-cc-amex"></i>
                                    </div>
                                </div>
                            </label>
                            <label class="payment-method-option">
                                <input type="radio" name="paymentMethod" value="store">
                                <div class="payment-method-card">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <strong>Pago en Tienda</strong>
                                        <small>OXXO, 7-Eleven (v√°lido 3 d√≠as)</small>
                                    </div>
                                    <div class="payment-method-badge-store">
                                        <span class="store-badge">OXXO</span>
                                        <span class="store-badge">7-Eleven</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="payment-method-notice">
                            <i class="fas fa-lock"></i>
                            <span>Tus datos est√°n protegidos con encriptaci√≥n SSL</span>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div id="orderSummary" class="checkout-summary" style="display: none;">
                <h2 class="summary-header">
                    <i class="fas fa-receipt"></i>
                    Resumen del Pedido
                </h2>

                <div id="orderItems" class="order-items">
                    <!-- Order items will be populated here -->
                </div>

                <!-- Cup√≥n de Descuento -->
                <div class="coupon-section">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #2c3e50;">
                        <i class="fas fa-ticket-alt"></i> ¬øTienes un cup√≥n?
                    </h3>

                    <div id="couponInput" class="coupon-input-group">
                        <input type="text" id="couponCode" placeholder="Ingresa el c√≥digo" style="flex: 1; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px 0 0 5px; font-size: 14px; text-transform: uppercase;">
                        <button id="applyCouponBtn" onclick="applyCoupon()" style="padding: 10px 20px; background: #D4AF37; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; font-weight: 600;">
                            Aplicar
                        </button>
                    </div>

                    <div id="couponApplied" class="coupon-applied" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #d4edda; padding: 12px; border-radius: 5px; border: 1px solid #c3e6cb;">
                            <div>
                                <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                <strong id="appliedCouponCode" style="color: #155724;"></strong>
                                <small id="appliedCouponDesc" style="display: block; color: #155724; margin-top: 3px;"></small>
                            </div>
                            <button onclick="removeCoupon()" style="background: none; border: none; color: #155724; cursor: pointer; font-size: 18px;" title="Remover cup√≥n">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div id="couponError" class="coupon-error" style="display: none;">
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb; color: #721c24; font-size: 14px;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="couponErrorMessage"></span>
                        </div>
                    </div>
                </div>

                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">$0.00</span>
                    </div>
                    <div class="total-row" id="discountRow" style="display: none; color: #28a745;">
                        <span>
                            <i class="fas fa-ticket-alt"></i> Descuento:
                        </span>
                        <span id="orderDiscount">-$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Env√≠o:</span>
                        <span id="orderShipping">Gratis</span>
                    </div>
                    <div class="total-row final">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #6c757d; text-align: right;">
                        <i class="fas fa-info-circle"></i> Precios con IVA incluido
                    </div>
                </div>

                <!-- Create Account Option (only for guests) -->
                <div id="createAccountSection" class="create-account-section">
                    <label class="create-account-label">
                        <input type="checkbox" id="createAccountCheckbox">
                        <div>
                            <strong>Crear cuenta para checkout m√°s r√°pido en el futuro</strong>
                            <ul class="create-account-benefits" id="accountBenefits">
                                <li><i class="fas fa-check"></i> Guarda direcciones de env√≠o</li>
                                <li><i class="fas fa-check"></i> Ve tu historial de pedidos</li>
                                <li><i class="fas fa-check"></i> Checkout m√°s r√°pido</li>
                            </ul>
                        </div>
                    </label>
                </div>

                <button id="placeOrderBtn" class="checkout-btn" type="button">
                    <i class="fas fa-credit-card"></i>
                    Realizar Pedido
                </button>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #6c757d;">
                    <i class="fas fa-info-circle"></i>
                    Al realizar tu pedido, recibir√°s un email de confirmaci√≥n con los detalles y opciones de pago.
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <button class="login-modal-close" id="closeLoginModal">&times;</button>
            <h3 class="login-modal-title">Iniciar Sesi√≥n</h3>

            <div id="loginError" class="login-error"></div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label class="login-form-label" for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="login-form-input" required placeholder="tu@email.com">
                </div>

                <div class="login-form-group">
                    <label class="login-form-label" for="loginPassword">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="login-form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" id="loginSubmitBtn" class="login-btn">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div class="login-footer">
                ¬øNo tienes cuenta? <a href="auth.html">Reg√≠strate aqu√≠</a>
            </div>
        </div>
    </div>

    <!-- Password Modal for Account Creation -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <h3 class="password-modal-title">Crear Cuenta</h3>
            <p class="password-modal-subtitle">Establece una contrase√±a para tu nueva cuenta</p>

            <form id="passwordForm">
                <div class="login-form-group">
                    <label class="login-form-label" for="newPassword">Contrase√±a</label>
                    <input type="password" id="newPassword" class="login-form-input" required
                           placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>

                <div class="login-form-group">
                    <label class="login-form-label" for="confirmPassword">Confirmar Contrase√±a</label>
                    <input type="password" id="confirmPassword" class="login-form-input" required
                           placeholder="Confirma tu contrase√±a">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="cancelPasswordBtn" class="login-btn"
                            style="background: #6c757d;">
                        Cancelar
                    </button>
                    <button type="submit" id="submitPasswordBtn" class="login-btn">
                        Crear Cuenta y Realizar Pedido
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer will be loaded dynamically by footer-universal.js -->

    <!-- Scripts -->
    <script src="./assets/js/config.js"></script>
    <script src="./assets/js/cloudinary-config.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Backend Configuration -->
    <script src="assets/js/backend-config.js"></script>

    <!-- Openpay Integration (load after backend-config) -->
    <script src="assets/js/openpay-integration.js"></script>

    <!-- Coupon Service -->
    <script src="assets/js/coupon-service.js"></script>

    <!-- Header Universal (DEBE CARGARSE PRIMERO) -->
    <script src="./assets/js/universal-header.js"></script>

    <!-- Cart System Scripts -->
    <script src="js/cart-manager.js"></script>
    <script src="assets/js/stock-validator.js"></script>
    <script src="assets/js/cart-ui.js"></script>

    <!-- Shipping Calculator -->
    <script src="assets/js/shipping-calculator.js"></script>

    <!-- Checkout Script -->
    <script>
        class CheckoutManager {
            constructor() {
                this.cartData = null;
                this.orderData = {};
                this.supabase = null;
                this.currentUser = null;
                this.savedAddresses = [];
                this.shippingCalculator = null;
                this.selectedShipping = null;

                console.log('üõí CheckoutManager inicializado');
                this.initialize();
            }

            async initialize() {
                // Initialize Supabase
                await this.initSupabase();

                // Check user authentication
                await this.checkAuth();

                // Wait for CartManager
                await this.waitForCartManager();

                // Load cart data
                this.loadCartData();

                // Initialize Shipping Calculator
                this.initShippingCalculator();

                // Setup event listeners
                this.setupEventListeners();
            }

            async initSupabase() {
                // Wait for Supabase library to load
                let attempts = 0;
                while (typeof window.supabase === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (typeof window.supabase === 'undefined') {
                    console.error('‚ùå Supabase library failed to load');
                    return;
                }

                if (window.SUPABASE_CONFIG) {
                    try {
                        this.supabase = window.supabase.createClient(
                            window.SUPABASE_CONFIG.url,
                            window.SUPABASE_CONFIG.anonKey
                        );
                        console.log('‚úÖ Supabase initialized for checkout');
                    } catch (error) {
                        console.error('‚ùå Error initializing Supabase:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è SUPABASE_CONFIG not found');
                }
            }

            async checkAuth() {
                if (!this.supabase) return;

                try {
                    const { data: { user } } = await this.supabase.auth.getUser();

                    if (user) {
                        this.currentUser = user;
                        console.log('üë§ User authenticated:', user.email);

                        // Show authenticated mode UI
                        this.showAuthenticatedMode();

                        // Load saved addresses (but don't populate yet)
                        await this.loadSavedAddresses();
                    } else {
                        console.log('üë§ No user authenticated - Guest mode');
                        // Show guest mode UI
                        this.showGuestMode();
                    }
                } catch (error) {
                    console.error('Error checking auth:', error);
                    this.showGuestMode();
                }
            }

            showGuestMode() {
                // Show guest mode elements
                const guestMode = document.getElementById('guestMode');
                const authenticatedMode = document.getElementById('authenticatedMode');
                const createAccountSection = document.getElementById('createAccountSection');

                if (guestMode) guestMode.style.display = 'block';
                if (authenticatedMode) authenticatedMode.style.display = 'none';
                if (createAccountSection) createAccountSection.style.display = 'block';
            }

            showAuthenticatedMode() {
                // Show authenticated mode elements
                const guestMode = document.getElementById('guestMode');
                const authenticatedMode = document.getElementById('authenticatedMode');
                const createAccountSection = document.getElementById('createAccountSection');
                const userEmailDisplay = document.getElementById('userEmailDisplay');

                if (guestMode) guestMode.style.display = 'none';
                if (authenticatedMode) authenticatedMode.style.display = 'flex';
                if (createAccountSection) createAccountSection.style.display = 'none';

                if (userEmailDisplay && this.currentUser) {
                    userEmailDisplay.textContent = this.currentUser.email;
                }

                // Show saved address elements
                const savedAddressesSection = document.getElementById('savedAddressesSection');
                const saveAddressCheckbox = document.getElementById('saveAddressCheckbox');

                if (savedAddressesSection) savedAddressesSection.style.display = 'block';
                if (saveAddressCheckbox) saveAddressCheckbox.style.display = 'block';
            }

            async loadSavedAddresses() {
                if (!this.supabase || !this.currentUser) return;

                try {
                    const { data, error } = await this.supabase
                        .from('user_addresses')
                        .select('*')
                        .eq('user_id', this.currentUser.id)
                        .order('is_default', { ascending: false })
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.savedAddresses = data || [];
                    console.log(`üìç Loaded ${this.savedAddresses.length} saved addresses`);

                    // Populate address selector
                    this.populateAddressSelector();
                } catch (error) {
                    console.error('Error loading saved addresses:', error);
                }
            }

            populateAddressSelector() {
                if (this.savedAddresses.length === 0) return;

                const selector = document.getElementById('savedAddress');
                const section = document.getElementById('savedAddressesSection');
                const saveCheckbox = document.getElementById('saveAddressCheckbox');

                if (!selector || !section) return;

                // Show the selector and save checkbox
                section.style.display = 'block';
                if (saveCheckbox) saveCheckbox.style.display = 'block';

                // Clear existing options except "Nueva direcci√≥n"
                selector.innerHTML = '<option value="">Nueva direcci√≥n</option>';

                // Add saved addresses
                this.savedAddresses.forEach(address => {
                    const option = document.createElement('option');
                    option.value = address.id;
                    const label = address.address_name ||
                                  `${address.recipient_name} - ${address.city}`;
                    option.textContent = label + (address.is_default ? ' (Predeterminada)' : '');
                    selector.appendChild(option);
                });

                // Auto-select default address
                const defaultAddress = this.savedAddresses.find(addr => addr.is_default);
                if (defaultAddress) {
                    selector.value = defaultAddress.id;
                    this.fillFormWithAddress(defaultAddress);
                }
            }

            async waitForCartManager() {
                return new Promise((resolve) => {
                    const checkCartManager = () => {
                        if (window.cartManager) {
                            resolve();
                        } else {
                            setTimeout(checkCartManager, 100);
                        }
                    };
                    checkCartManager();
                });
            }

            loadCartData() {
                if (window.cartManager) {
                    this.cartData = window.cartManager.getCartSummary();

                    if (this.cartData.items.length === 0) {
                        this.showEmptyCart();
                    } else {
                        this.showCheckout();
                    }
                }
            }

            initShippingCalculator() {
                if (typeof ShippingCalculator !== 'undefined') {
                    this.shippingCalculator = new ShippingCalculator({
                        backendUrl: window.BACKEND_CONFIG?.shippingServiceUrl || 'http://localhost:3001',
                        originZipCode: '01000'
                    });

                    // Listen for shipping option selection
                    document.addEventListener('shippingOptionSelected', (e) => {
                        this.selectedShipping = e.detail;
                        console.log('üì¶ Env√≠o seleccionado:', this.selectedShipping);
                        this.updateTotals();
                    });

                    // Auto-fill shipping zip code from form
                    const postalCodeInput = document.getElementById('postalCode');
                    if (postalCodeInput) {
                        postalCodeInput.addEventListener('blur', () => {
                            const zipCode = postalCodeInput.value.trim();
                            if (zipCode.length === 5) {
                                document.getElementById('shippingZipCode').value = zipCode;
                            }
                        });
                    }

                    console.log('‚úÖ Shipping calculator inicializado');
                } else {
                    console.warn('‚ö†Ô∏è ShippingCalculator no est√° disponible');
                }
            }

            setupEventListeners() {
                // Back to cart
                const backToCart = document.getElementById('backToCart');
                if (backToCart) {
                    backToCart.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (window.cartUI) {
                            window.cartUI.openCart();
                        }
                        window.history.back();
                    });
                }

                // Place order
                const placeOrderBtn = document.getElementById('placeOrderBtn');
                if (placeOrderBtn) {
                    placeOrderBtn.addEventListener('click', () => this.placeOrder());
                }

                // Form validation
                const form = document.getElementById('orderForm');
                if (form) {
                    form.addEventListener('input', () => this.validateForm());
                }

                // Show login modal
                const showLoginLink = document.getElementById('showLoginLink');
                if (showLoginLink) {
                    showLoginLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showLoginModal();
                    });
                }

                // Close login modal
                const closeLoginModal = document.getElementById('closeLoginModal');
                const loginModal = document.getElementById('loginModal');
                if (closeLoginModal) {
                    closeLoginModal.addEventListener('click', () => this.closeLoginModal());
                }
                if (loginModal) {
                    loginModal.addEventListener('click', (e) => {
                        if (e.target === loginModal) this.closeLoginModal();
                    });
                }

                // Login form submit
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleInlineLogin();
                    });
                }

                // Logout link
                const logoutLink = document.getElementById('logoutLink');
                if (logoutLink) {
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleLogout();
                    });
                }

                // Create account checkbox - show benefits
                const createAccountCheckbox = document.getElementById('createAccountCheckbox');
                const accountBenefits = document.getElementById('accountBenefits');
                if (createAccountCheckbox && accountBenefits) {
                    createAccountCheckbox.addEventListener('change', () => {
                        if (createAccountCheckbox.checked) {
                            accountBenefits.classList.add('show');
                        } else {
                            accountBenefits.classList.remove('show');
                        }
                    });
                }

                // Password modal for account creation
                const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
                if (cancelPasswordBtn) {
                    cancelPasswordBtn.addEventListener('click', () => this.closePasswordModal());
                }

                const passwordForm = document.getElementById('passwordForm');
                if (passwordForm) {
                    passwordForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleAccountCreationWithPassword();
                    });
                }

                // Postal code validation and auto-fill
                const postalCodeInput = document.getElementById('postalCode');
                if (postalCodeInput) {
                    postalCodeInput.addEventListener('blur', () => this.validatePostalCode());
                    postalCodeInput.addEventListener('input', (e) => {
                        // Only allow numbers
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
            }

            async validatePostalCode() {
                const postalCodeInput = document.getElementById('postalCode');
                const cityInput = document.getElementById('city');
                const stateInput = document.getElementById('state');
                const postalCode = postalCodeInput.value.trim();

                if (!postalCode || postalCode.length !== 5) {
                    return;
                }

                try {
                    console.log(`üîç Validating postal code: ${postalCode}`);

                    // Using free Mexican Postal Code API
                    const response = await fetch(`https://api.copomex.com/query/info_cp/${postalCode}?token=pruebas`);

                    if (!response.ok) {
                        throw new Error('CP no encontrado');
                    }

                    const data = await response.json();

                    if (data.error === false && data.response && data.response.municipio) {
                        // Auto-fill city and state
                        const municipio = data.response.municipio;
                        const estado = data.response.estado;

                        cityInput.value = municipio;
                        stateInput.value = estado;

                        console.log(`‚úÖ CP v√°lido: ${municipio}, ${estado}`);

                        // Visual feedback
                        postalCodeInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            postalCodeInput.style.borderColor = '';
                        }, 2000);
                    } else {
                        throw new Error('CP no encontrado');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error validating postal code:', error);
                    // Don't show error to user, just don't auto-fill
                    // They can enter city/state manually
                }
            }

            showEmptyCart() {
                document.getElementById('checkoutLoading').style.display = 'none';
                document.getElementById('emptyCartState').style.display = 'block';
            }

            showCheckout() {
                document.getElementById('checkoutLoading').style.display = 'none';
                document.getElementById('checkoutForm').style.display = 'block';
                document.getElementById('orderSummary').style.display = 'block';

                this.populateOrderSummary();

                // Ensure correct mode is displayed based on auth state
                if (this.currentUser) {
                    this.showAuthenticatedMode();
                    // Only populate selector if we have addresses
                    if (this.savedAddresses && this.savedAddresses.length > 0) {
                        this.populateAddressSelector();
                    }
                } else {
                    this.showGuestMode();
                }
            }

            populateOrderSummary() {
                const itemsContainer = document.getElementById('orderItems');

                itemsContainer.innerHTML = this.cartData.items.map(item => `
                    <div class="order-item">
                        <div class="item-image">
                            <img src="${item.product_snapshot?.image || 'assets/images/placeholder-product.jpg'}"
                                 alt="${item.product_snapshot?.name || 'Producto'}">
                        </div>
                        <div class="item-details">
                            <div class="item-name">${item.product_snapshot?.name || 'Producto'}</div>
                            <div class="item-quantity">Cantidad: ${item.quantity}</div>
                        </div>
                        <div class="item-price">${this.formatPrice(item.total_price)}</div>
                    </div>
                `).join('');

                // Update totals with coupon
                this.updateTotals();

                // Check if there's an applied coupon
                if (window.CouponService) {
                    const appliedCoupon = window.CouponService.getAppliedCoupon();
                    if (appliedCoupon) {
                        this.displayAppliedCoupon(appliedCoupon);
                    }
                }
            }

            updateTotals() {
                const subtotal = this.cartData.totals.subtotal;
                let discount = 0;

                // Check for applied coupon
                if (window.CouponService) {
                    const appliedCoupon = window.CouponService.getAppliedCoupon();
                    if (appliedCoupon) {
                        discount = appliedCoupon.discount;
                    }
                }

                const subtotalAfterDiscount = subtotal - discount;

                // Get shipping cost from selected option
                const shipping = this.selectedShipping ? this.selectedShipping.cost : 0;

                const total = subtotalAfterDiscount + shipping;

                document.getElementById('orderSubtotal').textContent = this.formatPrice(subtotal);

                // Show/hide discount row
                const discountRow = document.getElementById('discountRow');
                if (discount > 0) {
                    discountRow.style.display = 'flex';
                    document.getElementById('orderDiscount').textContent = '-' + this.formatPrice(discount);
                } else {
                    discountRow.style.display = 'none';
                }

                document.getElementById('orderShipping').textContent = shipping > 0 ? this.formatPrice(shipping) : 'Calculando...';
                document.getElementById('orderTotal').textContent = this.formatPrice(total);
            }

            displayAppliedCoupon(couponData) {
                document.getElementById('couponInput').style.display = 'none';
                document.getElementById('couponApplied').style.display = 'block';
                document.getElementById('appliedCouponCode').textContent = couponData.code;
                document.getElementById('appliedCouponDesc').textContent =
                    window.CouponService.formatDiscount(couponData.coupon);
            }

            hideAppliedCoupon() {
                document.getElementById('couponInput').style.display = 'flex';
                document.getElementById('couponApplied').style.display = 'none';
                document.getElementById('couponCode').value = '';
            }

            showCouponError(message) {
                const errorDiv = document.getElementById('couponError');
                const errorMsg = document.getElementById('couponErrorMessage');
                errorMsg.textContent = message;
                errorDiv.style.display = 'block';

                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            validateForm() {
                const form = document.getElementById('orderForm');
                const placeOrderBtn = document.getElementById('placeOrderBtn');

                const isValid = form.checkValidity();
                placeOrderBtn.disabled = !isValid;

                return isValid;
            }

            fillFormWithAddress(address) {
                if (!address) return;

                // Split recipient_name into first and last name
                const nameParts = (address.recipient_name || '').split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                document.getElementById('firstName').value = firstName;
                document.getElementById('lastName').value = lastName;
                document.getElementById('address').value = address.address_line1 || '';
                document.getElementById('addressLine2').value = address.address_line2 || '';
                document.getElementById('city').value = address.city || '';
                document.getElementById('postalCode').value = address.postal_code || '';
                document.getElementById('state').value = address.state || '';
                document.getElementById('phone').value = address.phone || '';
            }

            clearAddressForm() {
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('address').value = '';
                document.getElementById('addressLine2').value = '';
                document.getElementById('city').value = '';
                document.getElementById('postalCode').value = '';
                document.getElementById('state').value = '';
            }

            async saveNewAddress(addressData) {
                if (!this.supabase || !this.currentUser) return;

                try {
                    const { error } = await this.supabase
                        .from('user_addresses')
                        .insert([{
                            user_id: this.currentUser.id,
                            recipient_name: `${addressData.firstName} ${addressData.lastName}`,
                            phone: addressData.phone,
                            address_line1: addressData.address,
                            address_line2: addressData.addressLine2 || '',
                            city: addressData.city,
                            postal_code: addressData.postalCode,
                            state: addressData.state,
                            country: 'M√©xico',
                            is_default: this.savedAddresses.length === 0 // First address is default
                        }]);

                    if (error) throw error;

                    console.log('‚úÖ Address saved successfully');
                } catch (error) {
                    console.error('Error saving address:', error);
                }
            }

            async placeOrder() {
                if (!this.validateForm()) {
                    alert('Por favor, completa todos los campos requeridos.');
                    return;
                }

                // Check if user wants to create an account
                const createAccountCheckbox = document.getElementById('createAccountCheckbox');
                const shouldCreateAccount = createAccountCheckbox && createAccountCheckbox.checked && !this.currentUser;

                if (shouldCreateAccount) {
                    // Show password modal to get password
                    this.showPasswordModal();
                    // The flow continues in handleAccountCreationWithPassword() and processOrderWithAccountCreation()
                    return;
                }

                // Process order normally (without account creation)
                await this.processOrder();
            }

            async processOrder() {
                const placeOrderBtn = document.getElementById('placeOrderBtn');
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                try {
                    // Collect form data
                    const formData = new FormData(document.getElementById('orderForm'));
                    const formFields = Object.fromEntries(formData);

                    // Prepare order data
                    const orderNumber = `RT-${new Date().getFullYear()}-${String(Date.now()).slice(-4)}`;

                    this.orderData = {
                        orderNumber: orderNumber,
                        customer: {
                            name: `${formFields.firstName} ${formFields.lastName}`,
                            email: formFields.email,
                            phone: formFields.phone
                        },
                        shipping: {
                            address: formFields.address,
                            addressLine2: formFields.addressLine2 || '',
                            city: formFields.city,
                            state: formFields.state,
                            postalCode: formFields.postalCode,
                            country: 'M√©xico'
                        },
                        items: this.cartData.items,
                        totals: this.cartData.totals,
                        orderNotes: formFields.orderNotes || '',
                        orderDate: new Date().toISOString()
                    };

                    // Save address if checkbox is checked (for authenticated users)
                    const saveAddress = document.getElementById('saveAddress');
                    if (saveAddress && saveAddress.checked && this.currentUser) {
                        await this.saveNewAddress(formFields);
                    }

                    // Save order to database
                    const orderId = await this.saveOrderToDatabase();

                    // Process inventory deduction
                    await this.processInventoryDeduction();

                    // INTEGRACI√ìN OPENPAY: Iniciar proceso de pago
                    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                    // Preparar datos del cliente para Openpay
                    const customerData = {
                        name: this.orderData.customer.name,
                        email: this.orderData.customer.email,
                        phone: this.orderData.customer.phone
                    };

                    try {
                        // Iniciar pago con Openpay
                        const paymentResult = await window.openpayIntegration.startPayment({
                            order_id: orderId,
                            amount: this.cartData.totals.final,
                            customer: customerData,
                            method: paymentMethod
                        });

                        if (paymentResult.success && paymentResult.redirect_url) {
                            // Limpiar carrito antes de redirigir
                            if (window.cartManager) {
                                await window.cartManager.clearCart();
                            }

                            // Redirigir a Openpay o a p√°gina de confirmaci√≥n
                            window.location.href = paymentResult.redirect_url;
                        } else {
                            throw new Error(paymentResult.message || 'Error iniciando el pago');
                        }
                    } catch (paymentError) {
                        console.error('‚ùå Error procesando pago:', paymentError);
                        alert('Error procesando el pago: ' + paymentError.message);
                        placeOrderBtn.disabled = false;
                        placeOrderBtn.innerHTML = '<i class="fas fa-credit-card"></i> Realizar Pedido';
                        return;
                    }

                } catch (error) {
                    console.error('‚ùå Error placing order:', error);
                    alert('Error procesando el pedido. Por favor, int√©ntalo de nuevo.');
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fas fa-credit-card"></i> Realizar Pedido';
                }
            }

            async processOrderWithAccountCreation() {
                const placeOrderBtn = document.getElementById('placeOrderBtn');
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta y procesando pedido...';

                try {
                    // Collect form data
                    const formData = new FormData(document.getElementById('orderForm'));
                    const formFields = Object.fromEntries(formData);

                    const customerData = {
                        name: `${formFields.firstName} ${formFields.lastName}`,
                        email: formFields.email,
                        phone: formFields.phone
                    };

                    // Create account first
                    await this.createAccountFromCheckout(
                        formFields.email,
                        this.pendingAccountPassword,
                        customerData
                    );

                    // Now process the order
                    await this.processOrder();

                } catch (error) {
                    console.error('‚ùå Error creating account and placing order:', error);

                    if (error.message && error.message.includes('already registered')) {
                        alert('Este email ya est√° registrado. Por favor inicia sesi√≥n o usa otro email.');
                    } else {
                        alert('Error creando la cuenta. El pedido no se pudo procesar. Por favor, int√©ntalo de nuevo.');
                    }

                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fas fa-credit-card"></i> Realizar Pedido';
                }
            }

            async saveOrderToDatabase() {
                console.log('üíæ Saving retail order to database...');

                if (!this.supabase) {
                    throw new Error('Supabase client not available');
                }

                try {
                    // Calculate discount from coupon
                    let discountAmount = 0;
                    if (window.CouponService) {
                        const appliedCoupon = window.CouponService.getAppliedCoupon();
                        if (appliedCoupon) {
                            discountAmount = appliedCoupon.discount;
                        }
                    }

                    // Calculate shipping cost
                    const shippingCost = this.selectedShipping ? this.selectedShipping.cost : 0;

                    // Prepare order record for database
                    const orderRecord = {
                        order_number: this.orderData.orderNumber,
                        user_id: this.currentUser?.id || null,
                        customer_name: this.orderData.customer.name,
                        customer_email: this.orderData.customer.email,
                        customer_phone: this.orderData.customer.phone,

                        // Shipping address
                        shipping_address: this.orderData.shipping.address,
                        shipping_city: this.orderData.shipping.city,
                        shipping_state: this.orderData.shipping.state,
                        shipping_postal_code: this.orderData.shipping.postalCode,
                        shipping_country: this.orderData.shipping.country,

                        // Shipping details
                        carrier: this.selectedShipping?.carrier || null,
                        carrier_service: this.selectedShipping?.service || null,
                        shipping_cost: shippingCost,

                        // Order items (as JSONB)
                        items: this.orderData.items,

                        // Totals
                        subtotal: this.orderData.totals.subtotal,
                        discount_amount: discountAmount,
                        tax_amount: 0, // IVA already included in prices
                        total: this.orderData.totals.subtotal - discountAmount + shippingCost,

                        // Payment & status
                        payment_method: 'pending', // Will be paid via payment gateway
                        order_type: 'retail',
                        status: 'pending',

                        // Notes
                        order_notes: this.orderData.orderNotes
                    };

                    console.log('üì¶ Retail order record to insert:', orderRecord);

                    // Insert order into database
                    const { data, error } = await this.supabase
                        .from('orders')
                        .insert([orderRecord])
                        .select()
                        .single();

                    if (error) {
                        console.error('‚ùå Error saving order to database:', error);
                        throw new Error(`Error guardando pedido: ${error.message}`);
                    }

                    console.log('‚úÖ Retail order saved to database with ID:', data.id);
                    return data.id;

                } catch (error) {
                    console.error('‚ùå Error in saveOrderToDatabase:', error);
                    throw error;
                }
            }

            async processInventoryDeduction() {
                console.log('üîÑ Processing inventory deduction...');

                if (!this.supabase) {
                    throw new Error('Supabase client not available');
                }

                // Process each cart item
                for (const item of this.cartData.items) {
                    try {
                        // Get current stock for the variant
                        const { data: variant, error: fetchError } = await this.supabase
                            .from('product_variants')
                            .select('stock, variant_name')
                            .eq('id', item.variant_id)
                            .single();

                        if (fetchError) {
                            console.error('‚ùå Error fetching variant stock:', fetchError);
                            throw new Error(`Error verificando stock del producto: ${item.product_snapshot?.name}`);
                        }

                        if (!variant) {
                            throw new Error(`Variante no encontrada para: ${item.product_snapshot?.name}`);
                        }

                        // Check if we have enough stock
                        if (variant.stock < item.quantity) {
                            throw new Error(`Stock insuficiente para ${item.product_snapshot?.name}. Stock disponible: ${variant.stock}, solicitado: ${item.quantity}`);
                        }

                        // Calculate new stock
                        const newStock = variant.stock - item.quantity;

                        console.log(`üì¶ Deducting ${item.quantity} from ${variant.variant_name || 'default'}: ${variant.stock} ‚Üí ${newStock}`);

                        // Update stock in database
                        const { error: updateError } = await this.supabase
                            .from('product_variants')
                            .update({ stock: newStock })
                            .eq('id', item.variant_id);

                        if (updateError) {
                            console.error('‚ùå Error updating variant stock:', updateError);
                            throw new Error(`Error actualizando stock de: ${item.product_snapshot?.name}`);
                        }

                        console.log(`‚úÖ Stock updated successfully for ${item.product_snapshot?.name}`);

                    } catch (itemError) {
                        console.error('‚ùå Error processing item:', item, itemError);
                        throw itemError;
                    }
                }

                console.log('‚úÖ Inventory deduction completed successfully');
            }

            // Login Modal Methods
            showLoginModal() {
                const modal = document.getElementById('loginModal');
                const loginError = document.getElementById('loginError');

                if (modal) modal.classList.add('active');
                if (loginError) loginError.style.display = 'none';

                // Clear form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            }

            closeLoginModal() {
                const modal = document.getElementById('loginModal');
                if (modal) modal.classList.remove('active');
            }

            async handleInlineLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const loginError = document.getElementById('loginError');
                const loginBtn = document.getElementById('loginSubmitBtn');

                if (!email || !password) {
                    loginError.textContent = 'Por favor ingresa email y contrase√±a';
                    loginError.style.display = 'block';
                    return;
                }

                // Disable button
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';

                try {
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        throw error;
                    }

                    console.log('‚úÖ Login successful');

                    // Set current user
                    this.currentUser = data.user;

                    // Load saved addresses
                    await this.loadSavedAddresses();

                    // Switch to authenticated mode
                    this.showAuthenticatedMode();

                    // Populate address selector
                    this.populateAddressSelector();

                    // Close modal
                    this.closeLoginModal();

                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    loginError.textContent = error.message === 'Invalid login credentials'
                        ? 'Email o contrase√±a incorrectos'
                        : 'Error al iniciar sesi√≥n. Intenta de nuevo.';
                    loginError.style.display = 'block';
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                }
            }

            async handleLogout() {
                if (!confirm('¬øCerrar sesi√≥n? Tus datos no se guardar√°n.')) {
                    return;
                }

                try {
                    await this.supabase.auth.signOut();
                    this.currentUser = null;
                    this.savedAddresses = [];

                    // Switch to guest mode
                    this.showGuestMode();

                    // Clear form
                    this.clearAddressForm();

                    console.log('‚úÖ Logged out successfully');
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                }
            }

            // Password Modal for Account Creation
            showPasswordModal() {
                const modal = document.getElementById('passwordModal');
                if (modal) modal.classList.add('active');

                // Clear form
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }

            closePasswordModal() {
                const modal = document.getElementById('passwordModal');
                if (modal) modal.classList.remove('active');
            }

            async handleAccountCreationWithPassword() {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    alert('Las contrase√±as no coinciden');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }

                // Store password for later use
                this.pendingAccountPassword = newPassword;

                // Close password modal
                this.closePasswordModal();

                // Continue with order placement
                await this.processOrderWithAccountCreation();
            }

            async createAccountFromCheckout(email, password, customerData) {
                try {
                    console.log('üîê Creating account from checkout...');

                    // Sign up the user
                    const { data, error } = await this.supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: customerData.name
                            },
                            emailRedirectTo: window.location.origin
                        }
                    });

                    if (error) {
                        console.error('‚ùå Error creating account:', error);
                        throw error;
                    }

                    if (!data.user) {
                        throw new Error('No se pudo crear la cuenta');
                    }

                    console.log('‚úÖ Account created successfully:', email);

                    // IMPORTANT: Wait for session to be fully established
                    // After signUp, the user should be automatically logged in
                    // but we need to verify the session is active
                    let sessionAttempts = 0;
                    let session = data.session;

                    while (!session && sessionAttempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const { data: sessionData } = await this.supabase.auth.getSession();
                        session = sessionData.session;
                        sessionAttempts++;
                    }

                    if (!session) {
                        console.warn('‚ö†Ô∏è Session not established after signup, trying to sign in...');
                        // Try to sign in explicitly
                        const { data: signInData, error: signInError } = await this.supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });

                        if (signInError) {
                            throw new Error('Cuenta creada pero no se pudo iniciar sesi√≥n autom√°ticamente');
                        }

                        session = signInData.session;
                    }

                    console.log('‚úÖ Session established:', session ? 'YES' : 'NO');

                    // Set current user from session
                    this.currentUser = session.user;

                    // Refresh the Supabase client to use the new session
                    await this.supabase.auth.refreshSession();

                    // Save the address to the new account (NOW with active session)
                    if (this.currentUser) {
                        const formData = new FormData(document.getElementById('orderForm'));
                        const formFields = Object.fromEntries(formData);
                        await this.saveNewAddress(formFields);
                    }

                    return this.currentUser;

                } catch (error) {
                    console.error('‚ùå Error in createAccountFromCheckout:', error);
                    throw error;
                }
            }

            formatPrice(price) {
                if (!price) return '$0.00';
                const numPrice = parseFloat(price);
                if (isNaN(numPrice)) return '$0.00';

                return new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN',
                    minimumFractionDigits: 2
                }).format(numPrice);
            }
        }

        // Initialize checkout when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.checkoutManager = new CheckoutManager();
        });

        // Global function for shipping calculation
        async function calculateShipping() {
            const zipCodeInput = document.getElementById('shippingZipCode');
            const zipCode = zipCodeInput.value.trim();
            const calculateBtn = document.getElementById('calculateShippingBtn');
            const container = 'shippingOptionsContainer';

            // Validate zip code
            if (!window.isValidMexicanZipCode(zipCode)) {
                alert('Por favor ingresa un c√≥digo postal v√°lido de 5 d√≠gitos');
                zipCodeInput.focus();
                return;
            }

            if (!window.checkoutManager || !window.checkoutManager.shippingCalculator) {
                console.error('‚ùå Shipping calculator no est√° inicializado');
                return;
            }

            try {
                // Show loading
                calculateBtn.disabled = true;
                calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
                window.checkoutManager.shippingCalculator.showLoading(container);

                // Calculate weight from cart
                const cartItems = window.checkoutManager.cartData.items;
                const totalWeight = window.checkoutManager.shippingCalculator.calculateTotalWeight(cartItems);

                // Get quote
                const rates = await window.checkoutManager.shippingCalculator.getQuote({
                    destinationZipCode: zipCode,
                    weight: totalWeight
                });

                // Render options
                window.checkoutManager.shippingCalculator.renderShippingOptions(rates, container);

                console.log('‚úÖ Cotizaci√≥n completada');

            } catch (error) {
                console.error('‚ùå Error al calcular env√≠o:', error);
                window.checkoutManager.shippingCalculator.showError(
                    container,
                    error.message || 'No se pudo calcular el env√≠o. Intenta de nuevo.'
                );
            } finally {
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> Calcular';
            }
        }

        // Global functions for coupon management
        async function applyCoupon() {
            const codeInput = document.getElementById('couponCode');
            const code = codeInput.value.trim();

            if (!code) {
                window.checkoutManager.showCouponError('Por favor, ingresa un c√≥digo de cup√≥n');
                return;
            }

            // Disable button while processing
            const btn = document.getElementById('applyCouponBtn');
            btn.disabled = true;
            btn.textContent = 'Aplicando...';

            try {
                const subtotal = window.checkoutManager.cartData.totals.subtotal;
                const itemsCount = window.checkoutManager.cartData.items.length;

                const result = await window.CouponService.applyCoupon(code, {
                    total: subtotal,
                    itemsCount: itemsCount
                });

                if (result.valid) {
                    window.checkoutManager.displayAppliedCoupon(result);
                    window.checkoutManager.updateTotals();
                    document.getElementById('couponError').style.display = 'none';
                } else {
                    window.checkoutManager.showCouponError(
                        window.CouponService.getErrorMessage(result.error) +
                        (result.message && result.error === 'MIN_PURCHASE_NOT_MET' ? ': ' + result.message : '')
                    );
                }
            } catch (error) {
                console.error('Error applying coupon:', error);
                window.checkoutManager.showCouponError('Error al aplicar el cup√≥n. Intenta nuevamente.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Aplicar';
            }
        }

        function removeCoupon() {
            if (confirm('¬øDeseas remover el cup√≥n aplicado?')) {
                window.CouponService.removeCoupon();
                window.checkoutManager.hideAppliedCoupon();
                window.checkoutManager.updateTotals();
            }
        }

        // Global function for address selection
        function loadSavedAddress() {
            if (!window.checkoutManager) return;

            const selector = document.getElementById('savedAddress');
            const addressId = selector.value;

            if (!addressId) {
                // "Nueva direcci√≥n" selected - clear form
                window.checkoutManager.clearAddressForm();
                return;
            }

            // Find the selected address
            const address = window.checkoutManager.savedAddresses.find(
                addr => addr.id === addressId
            );

            if (address) {
                window.checkoutManager.fillFormWithAddress(address);
            }
        }

        // Allow Enter key to apply coupon
        document.addEventListener('DOMContentLoaded', () => {
            const couponInput = document.getElementById('couponCode');
            if (couponInput) {
                couponInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCoupon();
                    }
                });
            }
        });
    </script>

    <!-- Site Settings Service (for contact info from Supabase) -->
    <script src="assets/js/site-settings-service.js"></script>

    <!-- Universal Footer - Load footer dynamically -->
    <script src="assets/js/footer-universal.js"></script>
</body>
</html>