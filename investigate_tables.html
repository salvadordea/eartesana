<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigar Estructura de Tablas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="assets/js/config.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .result { background: #2d2d2d; padding: 10px; margin: 10px 0; border-radius: 4px; overflow-x: auto; }
        .error { background: #5d1a1a; color: #ff6b6b; }
        button { background: #4a90e2; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h1>Investigación de Estructura de Tablas</h1>
    
    <div class="section">
        <h2>1. Estructura de tabla 'products'</h2>
        <button onclick="getProductsStructure()">Obtener Estructura Products</button>
        <div id="products-structure" class="result"></div>
    </div>
    
    <div class="section">
        <h2>2. Estructura de tabla 'product_variants'</h2>
        <button onclick="getVariantsStructure()">Obtener Estructura Product_Variants</button>
        <div id="variants-structure" class="result"></div>
    </div>
    
    <div class="section">
        <h2>3. Muestra de datos - Products</h2>
        <button onclick="getProductsSample()">Obtener Muestra Products</button>
        <div id="products-sample" class="result"></div>
    </div>
    
    <div class="section">
        <h2>4. Muestra de datos - Product_Variants</h2>
        <button onclick="getVariantsSample()">Obtener Muestra Variants</button>
        <div id="variants-sample" class="result"></div>
    </div>
    
    <div class="section">
        <h2>5. Consulta JOIN - Productos con Variantes</h2>
        <button onclick="getProductsWithVariants()">Consultar Products + Variants</button>
        <div id="products-variants-join" class="result"></div>
    </div>

    <script>
        let supabase = null;

        // Initialize Supabase
        function initSupabase() {
            if (typeof window.supabase !== 'undefined' && window.SUPABASE_CONFIG) {
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );
                console.log('✅ Supabase initialized');
                return true;
            }
            console.error('❌ Supabase config missing');
            return false;
        }

        // Get products table structure
        async function getProductsStructure() {
            const resultDiv = document.getElementById('products-structure');
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    resultDiv.innerHTML = `
                        <strong>Columnas en 'products':</strong><br>
                        ${columns.map(col => `• ${col}`).join('<br>')}
                        <br><br>
                        <strong>Ejemplo de registro:</strong><br>
                        <pre>${JSON.stringify(data[0], null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = 'No hay datos en la tabla products';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error getting products structure:', error);
            }
        }

        // Get variants table structure
        async function getVariantsStructure() {
            const resultDiv = document.getElementById('variants-structure');
            try {
                const { data, error } = await supabase
                    .from('product_variants')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    resultDiv.innerHTML = `
                        <strong>Columnas en 'product_variants':</strong><br>
                        ${columns.map(col => `• ${col}`).join('<br>')}
                        <br><br>
                        <strong>Ejemplo de registro:</strong><br>
                        <pre>${JSON.stringify(data[0], null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = 'No hay datos en la tabla product_variants';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error getting variants structure:', error);
            }
        }

        // Get products sample
        async function getProductsSample() {
            const resultDiv = document.getElementById('products-sample');
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .limit(3);
                
                if (error) throw error;
                
                resultDiv.innerHTML = `
                    <strong>Muestra de 3 productos:</strong><br>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error getting products sample:', error);
            }
        }

        // Get variants sample
        async function getVariantsSample() {
            const resultDiv = document.getElementById('variants-sample');
            try {
                const { data, error } = await supabase
                    .from('product_variants')
                    .select('*')
                    .limit(5);
                
                if (error) throw error;
                
                resultDiv.innerHTML = `
                    <strong>Muestra de 5 variantes:</strong><br>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error getting variants sample:', error);
            }
        }

        // Get products with variants
        async function getProductsWithVariants() {
            const resultDiv = document.getElementById('products-variants-join');
            try {
                // Try different approaches to join
                const approaches = [
                    // Approach 1: Simple join
                    {
                        name: 'JOIN Simple',
                        query: supabase.from('products').select(`
                            id, name, price, total_stock,
                            product_variants(id, stock, color, size)
                        `).limit(3)
                    },
                    // Approach 2: Manual approach - products first
                    {
                        name: 'Manual - Products first',
                        query: supabase.from('products').select('*').limit(3)
                    }
                ];

                let results = '';
                
                for (const approach of approaches) {
                    try {
                        const { data, error } = await approach.query;
                        results += `
                            <h4>${approach.name}:</h4>
                            ${error ? `<div class="error">Error: ${error.message}</div>` : 
                              `<pre>${JSON.stringify(data, null, 2)}</pre>`}
                            <hr>
                        `;
                    } catch (err) {
                        results += `
                            <h4>${approach.name}:</h4>
                            <div class="error">Error: ${err.message}</div>
                            <hr>
                        `;
                    }
                }
                
                resultDiv.innerHTML = results;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error general: ${error.message}</div>`;
                console.error('Error getting products with variants:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (initSupabase()) {
                console.log('Ready to investigate tables');
            } else {
                document.body.innerHTML += '<div class="error">Failed to initialize Supabase</div>';
            }
        });
    </script>
</body>
</html>
