<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Mayoristas - Estudio Artesana</title>
    <meta name="description" content="Acceso para mayoristas de Estudio Artesana. Inicia sesi√≥n para acceder a precios especiales.">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/mayoristas-login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/images/favicon.ico">
    <link rel="apple-touch-icon" href="../assets/images/apple-touch-icon.png">
</head>
<body class="login-page">
    <!-- Header Simple -->
    <header class="login-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        <img src="../assets/images/logo.webp" alt="Estudio Artesana Logo" class="logo-img">
                    </a>
                </div>
                <nav class="simple-nav">
                    <a href="../index.html">Inicio</a>
                    <a href="../pages/mayoristas/index.html">Programa Mayoristas</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="login-main">
        <div class="container">
            <div class="login-container">
                <!-- Left Panel - Login Form -->
                <div class="login-panel">
                    <div class="login-header-content">
                        <h1>üè¢ Acceso Mayoristas</h1>
                        <p>Inicia sesi√≥n para acceder a tu tienda exclusiva con precios especiales</p>
                    </div>

                    <form class="login-form" id="wholesaleLoginForm">
                        <div class="form-group">
                            <label for="email">
                                <i class="fas fa-envelope"></i>
                                Email
                            </label>
                            <input type="email" id="email" name="email" required 
                                   placeholder="tu-email@empresa.com" autocomplete="username">
                        </div>

                        <div class="form-group">
                            <label for="password">
                                <i class="fas fa-lock"></i>
                                Contrase√±a
                            </label>
                            <div class="password-field">
                                <input type="password" id="password" name="password" required 
                                       placeholder="Tu contrase√±a" autocomplete="current-password">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                                    <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-options">
                            <label class="remember-me">
                                <input type="checkbox" id="rememberMe" name="remember">
                                <span class="checkmark"></span>
                                Recordar sesi√≥n
                            </label>
                            <a href="#" class="forgot-password" onclick="showForgotPassword()">
                                ¬øOlvidaste tu contrase√±a?
                            </a>
                        </div>

                        <button type="submit" class="login-btn" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i>
                            Iniciar Sesi√≥n
                        </button>

                        <div class="login-divider">
                            <span>¬øNo tienes cuenta mayorista?</span>
                        </div>

                        <a href="../pages/mayoristas/index.html#solicitar-info" class="register-link">
                            <i class="fas fa-user-plus"></i>
                            Solicitar Cuenta Mayorista
                        </a>
                    </form>

                    <!-- Demo Credentials -->
                    <div class="demo-credentials">
                        <h4><i class="fas fa-info-circle"></i> Credenciales de Demostraci√≥n</h4>
                        <div class="demo-accounts">
                            <div class="demo-account">
                                <strong>Mayorista Activo:</strong>
                                <div class="credentials">
                                    <span>Email: maria@empresa.com</span>
                                    <span>Contrase√±a: demo123</span>
                                </div>
                                <button class="quick-fill-btn" onclick="fillDemoCredentials('maria@empresa.com', 'demo123')">
                                    Usar estas credenciales
                                </button>
                            </div>
                            <div class="demo-account">
                                <strong>Mayorista Suspendido:</strong>
                                <div class="credentials">
                                    <span>Email: roberto@comercial.mx</span>
                                    <span>Contrase√±a: demo123</span>
                                </div>
                                <button class="quick-fill-btn" onclick="fillDemoCredentials('roberto@comercial.mx', 'demo123')">
                                    Probar cuenta suspendida
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Benefits -->
                <div class="benefits-panel">
                    <div class="benefits-content">
                        <h2>üíº Beneficios Mayoristas</h2>
                        <div class="benefits-list">
                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>20% de Descuento</h3>
                                    <p>En todos los productos de nuestro cat√°logo</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-shipping-fast"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>Env√≠o Gratis</h3>
                                    <p>En todos tus pedidos mayoristas</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>Cr√©dito a 30 D√≠as</h3>
                                    <p>T√©rminos de pago flexibles</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-headset"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>Soporte Dedicado</h3>
                                    <p>Atenci√≥n personalizada para mayoristas</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>Pedidos M√≠nimos</h3>
                                    <p>Desde 10 piezas por producto</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div class="benefit-text">
                                    <h3>Acceso Exclusivo</h3>
                                    <p>Productos y ofertas especiales</p>
                                </div>
                            </div>
                        </div>

                        <div class="contact-info">
                            <h4>¬øNecesitas ayuda?</h4>
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span>mayoristas@estudioartesana.com</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span>+52 555 123 4567</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-whatsapp"></i>
                                <span>+52 123 456 7890</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="login-footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2024 Estudio Artesana - Portal Mayoristas. Todos los derechos reservados.</p>
                <div class="footer-links">
                    <a href="../pages/politicas/privacidad.html">Pol√≠tica de Privacidad</a>
                    <a href="../pages/politicas/terminos.html">T√©rminos y Condiciones</a>
                    <a href="../pages/politicas/mayoristas.html">T√©rminos Mayoristas</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script>
        // Initialize Supabase
        let supabase;
        if (window.SUPABASE_CONFIG) {
            supabase = window.supabase.createClient(
                window.SUPABASE_CONFIG.url,
                window.SUPABASE_CONFIG.anonKey
            );
            console.log('‚úÖ Supabase inicializado para mayoristas');
        }

        // Mock wholesaler database (fallback)
        const wholesalers = [
            {
                id: 1,
                name: 'Mar√≠a Gonz√°lez',
                email: 'maria@empresa.com',
                password: 'demo123',
                company: 'Artesan√≠as del Norte',
                phone: '+52 123 456 7890',
                status: 'active',
                discount: 20,
                created_at: '2024-01-15T10:00:00Z'
            },
            {
                id: 2,
                name: 'Roberto Mart√≠nez',
                email: 'roberto@comercial.mx',
                password: 'demo123',
                company: 'Comercial Mart√≠nez',
                phone: '+52 987 654 3210',
                status: 'suspended',
                discount: 15,
                created_at: '2024-02-10T14:30:00Z'
            }
        ];

        // Check if already logged in
        function checkExistingSession() {
            const wholesaleSession = localStorage.getItem('wholesaleSession');
            if (wholesaleSession) {
                try {
                    const sessionData = JSON.parse(wholesaleSession);
                    const now = Date.now();
                    
                    if (sessionData.isLoggedIn && now < sessionData.expires) {
                        // Already logged in, redirect to store
                        window.location.href = 'tienda.html';
                        return true;
                    } else {
                        // Session expired, clean up
                        localStorage.removeItem('wholesaleSession');
                    }
                } catch (error) {
                    localStorage.removeItem('wholesaleSession');
                }
            }
            return false;
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Fill demo credentials
        function fillDemoCredentials(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            
            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Credenciales cargadas ‚úì';
            button.style.backgroundColor = '#28a745';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
            }, 2000);
        }

        // Show forgot password
        function showForgotPassword() {
            alert(`üìß RECUPERAR CONTRASE√ëA

Para recuperar tu contrase√±a de mayorista, por favor contacta a nuestro equipo de soporte:

üìß Email: mayoristas@estudioartesana.com
üìû Tel√©fono: +52 555 123 4567
üí¨ WhatsApp: +52 123 456 7890

Nuestro equipo verificar√° tu identidad y te ayudar√° a restablecer tu contrase√±a en menos de 24 horas.

Horarios de atenci√≥n:
Lunes a Viernes: 9:00 AM - 6:00 PM
S√°bados: 10:00 AM - 2:00 PM`);
        }

        // Login form submission
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginBtn = document.getElementById('loginBtn');

            // Disable button and show loading
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';

            try {
                // Intentar autenticaci√≥n con Supabase
                if (supabase) {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (data.user && data.session) {
                        // Verificar rol del usuario en user_profiles
                        const { data: profileData, error: profileError } = await supabase
                            .from('user_profiles')
                            .select('role, full_name, company_name, phone, wholesale_discount_percent, is_active')
                            .eq('id', data.user.id)
                            .single();

                        if (profileError || !profileData) {
                            console.error('Error obteniendo perfil de usuario:', profileError);
                            throw new Error('No se pudo verificar el perfil de usuario');
                        }

                        // Verificar que el usuario sea Mayorista o Admin
                        if (profileData.role !== 'Mayorista' && profileData.role !== 'Admin') {
                            console.warn('‚ö†Ô∏è Acceso denegado: Usuario no es mayorista. Rol:', profileData.role);
                            await supabase.auth.signOut();
                            throw new Error('Acceso denegado: Esta secci√≥n es solo para clientes mayoristas.');
                        }

                        // Verificar que est√© activo
                        if (!profileData.is_active) {
                            await supabase.auth.signOut();
                            throw new Error('Tu cuenta mayorista est√° inactiva. Contacta a soporte para m√°s informaci√≥n.');
                        }

                        // Crear sesi√≥n
                        const sessionDuration = rememberMe ? 30 * 24 * 60 * 60 * 1000 : 8 * 60 * 60 * 1000;
                        const sessionData = {
                            id: data.user.id,
                            name: profileData.full_name || data.user.email,
                            email: data.user.email,
                            company: profileData.company_name || 'Sin empresa',
                            phone: profileData.phone || '',
                            discount: profileData.wholesale_discount_percent || 0,
                            role: profileData.role,
                            status: 'active',
                            isLoggedIn: true,
                            loginTime: Date.now(),
                            expires: Date.now() + sessionDuration,
                            source: 'supabase_auth'
                        };

                        localStorage.setItem('wholesaleSession', JSON.stringify(sessionData));

                        // Success feedback
                        loginBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Acceso exitoso!';
                        loginBtn.style.backgroundColor = '#28a745';

                        // Show welcome message
                        setTimeout(() => {
                            alert(`¬°Bienvenido/a, ${sessionData.name}! üéâ

Has iniciado sesi√≥n exitosamente en tu cuenta mayorista.

üè¢ Empresa: ${sessionData.company}
üíº Descuento: ${sessionData.discount}%
üìß Email: ${sessionData.email}

Ser√°s redirigido/a a tu tienda exclusiva con precios especiales.`);

                            // Redirect to wholesale store
                            window.location.href = 'tienda.html';
                        }, 500);
                        return;
                    }

                    if (error) {
                        console.error('Error de Supabase Auth:', error);
                        // Continuar con fallback mock
                    }
                }

                // Fallback: Mock authentication
                await new Promise(resolve => setTimeout(resolve, 1500));

                const wholesaler = wholesalers.find(w => w.email === email && w.password === password);

                if (!wholesaler) {
                    throw new Error('Credenciales incorrectas');
                }

                if (wholesaler.status === 'suspended') {
                    throw new Error(`CUENTA SUSPENDIDA

Tu cuenta mayorista ha sido suspendida temporalmente.

Para reactivar tu cuenta, por favor contacta a:
üìß mayoristas@estudioartesana.com
üìû +52 555 123 4567

Nuestro equipo te ayudar√° a resolver cualquier inconveniente.`);
                }

                if (wholesaler.status === 'inactive') {
                    throw new Error('Tu cuenta mayorista est√° inactiva. Contacta a soporte para m√°s informaci√≥n.');
                }

                // Create mock session
                const sessionDuration = rememberMe ? 30 * 24 * 60 * 60 * 1000 : 8 * 60 * 60 * 1000;
                const sessionData = {
                    id: wholesaler.id,
                    name: wholesaler.name,
                    email: wholesaler.email,
                    company: wholesaler.company,
                    phone: wholesaler.phone,
                    discount: wholesaler.discount,
                    role: 'Mayorista',
                    status: wholesaler.status,
                    isLoggedIn: true,
                    loginTime: Date.now(),
                    expires: Date.now() + sessionDuration,
                    source: 'mock'
                };

                localStorage.setItem('wholesaleSession', JSON.stringify(sessionData));

                // Success feedback
                loginBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Acceso exitoso!';
                loginBtn.style.backgroundColor = '#28a745';

                // Show welcome message
                setTimeout(() => {
                    alert(`¬°Bienvenido/a, ${wholesaler.name}! üéâ

Has iniciado sesi√≥n exitosamente en tu cuenta mayorista.

üè¢ Empresa: ${wholesaler.company}
üíº Descuento: ${wholesaler.discount}%
üìß Email: ${wholesaler.email}

Ser√°s redirigido/a a tu tienda exclusiva con precios especiales.`);

                    // Redirect to wholesale store
                    window.location.href = 'tienda.html';
                }, 500);
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                alert(`‚ùå ERROR DE INICIO DE SESI√ìN

${error.message}

Por favor verifica tus credenciales e intenta nuevamente.`);
                
                // Reset button
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                loginBtn.style.backgroundColor = '';
                
                // Clear password field
                document.getElementById('password').value = '';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Sistema de login mayoristas inicializado');
            
            // Check if already logged in
            if (checkExistingSession()) {
                return;
            }
            
            // Setup form submission
            document.getElementById('wholesaleLoginForm').addEventListener('submit', handleLogin);
            
            // Auto-focus email field
            document.getElementById('email').focus();
            
            // Handle enter key on password field
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('wholesaleLoginForm').dispatchEvent(new Event('submit'));
                }
            });
            
            // Load remember me preference
            const savedEmail = localStorage.getItem('wholesaleRememberEmail');
            if (savedEmail) {
                document.getElementById('email').value = savedEmail;
                document.getElementById('rememberMe').checked = true;
                document.getElementById('password').focus();
            }
            
            // Save/remove email based on remember me checkbox
            document.getElementById('rememberMe').addEventListener('change', function() {
                if (this.checked) {
                    const email = document.getElementById('email').value;
                    if (email) {
                        localStorage.setItem('wholesaleRememberEmail', email);
                    }
                } else {
                    localStorage.removeItem('wholesaleRememberEmail');
                }
            });
        });

        // Handle browser back button after login
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                checkExistingSession();
            }
        });
    </script>
</body>
</html>
