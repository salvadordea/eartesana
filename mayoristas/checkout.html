<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Mayoristas - Estudio Artesana</title>
    <meta name="description" content="Finalizar pedido mayorista en Estudio Artesana. Proceso seguro y r√°pido.">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/mayoristas-tienda.css">
    <link rel="stylesheet" href="../assets/css/mayoristas-checkout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body class="checkout-page">
    <!-- Header Simple -->
    <header class="checkout-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        <img src="../assets/images/logo.webp" alt="Estudio Artesana Logo" class="logo-img">
                    </a>
                </div>
                <div class="checkout-steps">
                    <div class="step active">
                        <span class="step-number">1</span>
                        <span class="step-text">Informaci√≥n</span>
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <span class="step-text">Confirmaci√≥n</span>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span class="step-text">Completado</span>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-tie"></i>
                    <span id="checkoutWholesalerName">Mayorista</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="checkout-main">
        <div class="container">
            <div class="checkout-layout">
                <!-- Left Panel - Order Form -->
                <div class="checkout-form-panel">
                    <div class="panel-header">
                        <h2>üõí Finalizar Pedido Mayorista</h2>
                        <p>Completa la informaci√≥n para procesar tu pedido</p>
                    </div>

                    <form class="checkout-form" id="checkoutForm">
                        <style>
                            /* Payment Instructions Styles */
                            .payment-instructions {
                                background: var(--dark-surface-light);
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                padding: 20px;
                                margin-top: 20px;
                            }

                            .payment-instructions h4 {
                                color: var(--silver-accent);
                                margin: 0 0 15px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            }

                            .payment-instructions ul {
                                margin: 0;
                                padding-left: 20px;
                                list-style-type: none;
                            }

                            .payment-instructions li {
                                color: var(--text-secondary);
                                margin-bottom: 10px;
                                position: relative;
                            }

                            .payment-instructions li:before {
                                content: '‚Ä¢';
                                position: absolute;
                                left: -15px;
                                color: var(--silver-accent);
                            }

                            .bank-info {
                                background: var(--dark-bg);
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                padding: 15px;
                                margin: 15px 0;
                                font-family: 'Courier New', monospace;
                            }

                            .bank-info strong {
                                color: var(--silver-accent);
                                margin-right: 5px;
                            }
                        </style>
                        <!-- Contact Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Informaci√≥n de Contacto</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactName">Nombre del Contacto *</label>
                                    <input type="text" id="contactName" required>
                                </div>
                                <div class="form-group">
                                    <label for="contactEmail">Email *</label>
                                    <input type="email" id="contactEmail" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactPhone">Tel√©fono *</label>
                                    <input type="tel" id="contactPhone" required>
                                </div>
                                <div class="form-group">
                                    <label for="company">Empresa *</label>
                                    <input type="text" id="company" required>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <div class="form-section">
                            <h3><i class="fas fa-truck"></i> Direcci√≥n de Env√≠o</h3>

                            <!-- Saved Addresses Selector -->
                            <div class="form-group">
                                <label for="savedAddresses">Direcciones Guardadas</label>
                                <select id="savedAddresses" style="width: 100%; background: var(--dark-surface-light); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; color: var(--text-primary);">
                                    <option value="">Usar direcci√≥n guardada o agregar nueva</option>
                                    <option value="new">+ Agregar nueva direcci√≥n</option>
                                </select>
                            </div>

                            <!-- Address Fields -->
                            <div id="shippingAddressFields">
                                <div class="form-group">
                                    <label for="shippingAddress">Direcci√≥n Completa *</label>
                                    <input type="text" id="shippingAddress" placeholder="Calle, n√∫mero, colonia" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="shippingCity">Ciudad *</label>
                                        <input type="text" id="shippingCity" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="shippingState">Estado *</label>
                                        <input type="text" id="shippingState" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="shippingZipcode">C√≥digo Postal *</label>
                                        <input type="text" id="shippingZipcode" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="country">Pa√≠s</label>
                                        <input type="text" id="country" value="M√©xico" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="shippingNotes">Notas de Env√≠o</label>
                                    <textarea id="shippingNotes" placeholder="Instrucciones especiales para el env√≠o (opcional)" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-file-invoice"></i> Informaci√≥n de Facturaci√≥n</h3>
                            <div class="form-checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sameAsShipping" checked>
                                    <span class="checkmark"></span>
                                    La direcci√≥n de facturaci√≥n es la misma que la de env√≠o
                                </label>
                            </div>
                            <div id="billingAddressSection" style="display: none;">
                                <div class="form-group">
                                    <label for="billingAddress">Direcci√≥n de Facturaci√≥n</label>
                                    <input type="text" id="billingAddress" placeholder="Calle, n√∫mero, colonia">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="billingCity">Ciudad</label>
                                        <input type="text" id="billingCity">
                                    </div>
                                    <div class="form-group">
                                        <label for="billingState">Estado</label>
                                        <input type="text" id="billingState">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="billingZipcode">C√≥digo Postal</label>
                                        <input type="text" id="billingZipcode">
                                    </div>
                                </div>
                            </div>

                            <!-- RFC de P√∫blico en General Toggle -->
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="publicoGeneral">
                                    <span class="checkmark"></span>
                                    Usar RFC de P√∫blico en General (XAXX010101000)
                                </label>
                            </div>

                            <div class="form-row" id="rfcFieldsSection">
                                <div class="form-group">
                                    <label for="rfc">RFC *</label>
                                    <input type="text" id="rfc" placeholder="RFC de la empresa" required>
                                </div>
                                <div class="form-group">
                                    <label for="businessName">Raz√≥n Social *</label>
                                    <input type="text" id="businessName" required>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h3><i class="fas fa-credit-card"></i> M√©todo de Pago</h3>
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="transferencia" checked>
                                    <span class="payment-icon"><i class="fas fa-university"></i></span>
                                    <div class="payment-text">
                                        <strong>Transferencia Bancaria</strong>
                                        <small>Pago por transferencia con t√©rminos de cr√©dito a 30 d√≠as</small>
                                    </div>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="efectivo_contra_entrega">
                                    <span class="payment-icon"><i class="fas fa-hand-holding-usd"></i></span>
                                    <div class="payment-text">
                                        <strong>Efectivo Contra Entrega</strong>
                                        <small>Pago en efectivo al recibir el pedido</small>
                                    </div>
                                </label>
                            </div>

                            <!-- Payment Instructions -->
                            <div id="paymentInstructions" class="payment-instructions" style="display: none;">
                                <!-- Instructions will be shown based on selected payment method -->
                            </div>
                        </div>

                        <!-- Order Notes -->
                        <div class="form-section">
                            <h3><i class="fas fa-sticky-note"></i> Notas del Pedido</h3>
                            <div class="form-group">
                                <textarea id="orderNotes" placeholder="Comentarios adicionales sobre tu pedido (opcional)" rows="4"></textarea>
                            </div>
                        </div>

                        <!-- Terms Notice -->
                        <div class="form-section">
                            <div style="background: var(--dark-surface-light); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; text-align: center; color: var(--text-secondary); font-size: 14px;">
                                Al hacer clic en "Procesar Pedido" acepto los <a href="../pages/politicas/mayoristas.html" target="_blank" style="color: var(--silver-accent); text-decoration: underline;">t√©rminos y condiciones mayoristas</a>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Right Panel - Order Summary -->
                <div class="order-summary-panel">
                    <div class="summary-header">
                        <h3>üìã Resumen del Pedido</h3>
                    </div>

                    <div class="cart-items" id="checkoutCartItems">
                        <div class="loading-cart">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Cargando carrito...</span>
                        </div>
                    </div>

                    <div class="order-calculations">
                        <div class="calculation-row">
                            <span>Subtotal:</span>
                            <span id="checkoutSubtotal">$0.00</span>
                        </div>
                        <div class="calculation-row discount-row">
                            <span>Descuento mayorista (20%):</span>
                            <span id="checkoutDiscount">-$0.00</span>
                        </div>
                        <div class="calculation-row shipping-row">
                            <span>Env√≠o:</span>
                            <span class="free-shipping">GRATIS</span>
                        </div>
                        <div class="calculation-row tax-row">
                            <span>IVA (16%):</span>
                            <span id="checkoutTax">$0.00</span>
                        </div>
                        <div class="calculation-row total-row">
                            <span>Total:</span>
                            <span id="checkoutTotal">$0.00</span>
                        </div>
                    </div>

                    <div class="order-benefits">
                        <div class="benefit-item">
                            <i class="fas fa-shipping-fast"></i>
                            <span>Env√≠o gratis incluido</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Garant√≠a mayorista</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-headset"></i>
                            <span>Soporte dedicado</span>
                        </div>
                    </div>

                    <div class="checkout-actions">
                        <button type="button" class="btn-secondary" onclick="goBackToStore()">
                            <i class="fas fa-arrow-left"></i>
                            Volver a la Tienda
                        </button>
                        <button type="button" class="btn-primary" onclick="processOrder()" id="processOrderBtn">
                            <i class="fas fa-credit-card"></i>
                            Procesar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="checkout-footer">
        <div class="container">
            <div class="footer-content">
                <p>üîí Conexi√≥n segura ‚Ä¢ üìû Soporte 24/7: +52 555 123 4567 ‚Ä¢ üìß mayoristas@estudioartesana.com</p>
            </div>
        </div>
    </footer>

    <!-- Order Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úÖ Pedido Procesado</h2>
            </div>
            <div class="modal-body">
                <div class="confirmation-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>¬°Tu pedido ha sido procesado exitosamente!</h3>
                    <div class="order-details">
                        <div class="detail-item">
                            <strong>N√∫mero de Pedido:</strong>
                            <span id="orderNumber">#WS-2024-0001</span>
                        </div>
                        <div class="detail-item">
                            <strong>Total:</strong>
                            <span id="orderTotal">$0.00</span>
                        </div>
                        <div class="detail-item">
                            <strong>M√©todo de Pago:</strong>
                            <span id="orderPaymentMethod">Cr√©dito a 30 d√≠as</span>
                        </div>
                        <div class="detail-item">
                            <strong>Tiempo de Entrega:</strong>
                            <span>5-7 d√≠as h√°biles</span>
                        </div>
                    </div>

                    <!-- Payment Reference and Bank Info (shown only for transferencia) -->
                    <div id="paymentReferenceSection" style="display: none; margin-top: 25px; background: var(--dark-surface-light); border: 2px solid var(--silver-accent); border-radius: 10px; padding: 25px;">
                        <h4 style="color: var(--silver-accent); margin: 0 0 20px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-university"></i> Informaci√≥n para tu Transferencia
                        </h4>

                        <!-- Payment Reference Code -->
                        <div style="background: var(--dark-bg); border: 2px dashed var(--silver-accent); border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.9rem;">
                                <i class="fas fa-barcode"></i> C√≥digo de Referencia para tu Pago:
                            </p>
                            <p id="paymentReferenceCode" style="margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--silver-accent); font-family: 'Courier New', monospace; letter-spacing: 2px;">
                                ESTUD-0001
                            </p>
                            <p style="margin: 10px 0 0 0; color: var(--text-secondary); font-size: 0.85rem; font-style: italic;">
                                Incluye este c√≥digo en la referencia de tu transferencia
                            </p>
                        </div>

                        <!-- Bank Information -->
                        <div id="bankInfoDetails" style="background: var(--dark-bg); border-radius: 8px; padding: 20px;">
                            <p style="margin: 0 0 15px 0; color: var(--text-secondary); font-weight: 600;">
                                <i class="fas fa-building"></i> Datos Bancarios:
                            </p>
                            <div style="font-family: 'Courier New', monospace; font-size: 0.95rem; line-height: 1.8;">
                                <p style="margin: 5px 0;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">Banco:</strong> <span id="bankName">-</span></p>
                                <p style="margin: 5px 0;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">Titular:</strong> <span id="accountHolder">-</span></p>
                                <p style="margin: 5px 0;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">Cuenta:</strong> <span id="accountNumber">-</span></p>
                                <p style="margin: 5px 0;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">CLABE:</strong> <span id="clabe">-</span></p>
                                <p id="swiftRow" style="margin: 5px 0; display: none;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">SWIFT:</strong> <span id="swift">-</span></p>
                                <p style="margin: 5px 0;"><strong style="color: var(--silver-accent); display: inline-block; width: 140px;">Moneda:</strong> <span id="currency">MXN</span></p>
                            </div>
                        </div>

                        <!-- Important Notice -->
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; border-radius: 5px;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                <strong style="color: #ffc107;"><i class="fas fa-exclamation-triangle"></i> Importante:</strong>
                                <span id="referenceInstructions">Incluye el c√≥digo de referencia en tu transferencia</span>
                            </p>
                        </div>
                    </div>
                    <div class="next-steps">
                        <h4>üìã Pr√≥ximos pasos:</h4>
                        <ul>
                            <li>Recibir√°s un email de confirmaci√≥n en los pr√≥ximos minutos</li>
                            <li>Te contactaremos para coordinar la entrega</li>
                            <li>Puedes seguir tu pedido en "Mis Pedidos"</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="continueShopping()">
                    <i class="fas fa-shopping-cart"></i>
                    Seguir Comprando
                </button>
                <button type="button" class="btn btn-primary" onclick="viewMyOrders()">
                    <i class="fas fa-list-alt"></i>
                    Ver Mis Pedidos
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script>
        // Checkout Configuration
        const WHOLESALE_DISCOUNT = 0.20;
        const TAX_RATE = 0.16;
        let checkoutCart = [];
        let currentUser = null;
        let orderTotal = 0;
        let supabase = null;

        // Initialize Supabase client
        function initializeSupabase() {
            if (typeof window.supabase !== 'undefined' && window.SUPABASE_CONFIG) {
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );
                window.supabase = supabase; // Make it globally available
                console.log('‚úÖ Supabase client initialized for checkout');
                return true;
            }
            console.error('‚ùå Supabase not available or config missing');
            return false;
        }

        // Check authentication
        function checkCheckoutAuth() {
            const wholesaleSession = localStorage.getItem('wholesaleSession');
            if (!wholesaleSession) {
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const sessionData = JSON.parse(wholesaleSession);
                const now = Date.now();
                
                if (!sessionData.isLoggedIn || now > sessionData.expires) {
                    localStorage.removeItem('wholesaleSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                currentUser = sessionData;
                updateUserInfo();
                return true;
            } catch (error) {
                localStorage.removeItem('wholesaleSession');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Load wholesaler profile from database
        async function loadWholesalerProfile() {
            if (!supabase || !currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.warn('Could not load wholesaler profile:', error);
                    return;
                }

                if (data) {
                    console.log('‚úÖ Wholesaler profile loaded, auto-filling form');

                    // Pre-fill contact information
                    document.getElementById('contactName').value = data.full_name || '';
                    document.getElementById('contactEmail').value = data.email || '';
                    document.getElementById('contactPhone').value = data.contact_phone || data.phone || '';
                    document.getElementById('company').value = data.company_name || '';

                    // Pre-fill shipping address
                    if (data.shipping_address) {
                        document.getElementById('shippingAddress').value = data.shipping_address || '';
                        document.getElementById('shippingCity').value = data.shipping_city || '';
                        document.getElementById('shippingState').value = data.shipping_state || '';
                        document.getElementById('shippingZipcode').value = data.shipping_zipcode || '';
                    }

                    // Pre-fill billing information
                    if (data.tax_id) {
                        document.getElementById('rfc').value = data.tax_id || '';
                        document.getElementById('businessName').value = data.company_name || '';
                        document.getElementById('billingAddress').value = data.billing_address || data.shipping_address || '';
                        document.getElementById('billingCity').value = data.billing_city || data.shipping_city || '';
                        document.getElementById('billingState').value = data.billing_state || data.shipping_state || '';
                        document.getElementById('billingZipcode').value = data.billing_zipcode || data.shipping_zipcode || '';
                    }
                }
            } catch (error) {
                console.error('Error loading wholesaler profile:', error);
            }
        }

        // Update user info
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('checkoutWholesalerName').textContent =
                    currentUser.company || currentUser.name || 'Mayorista';

                // Load full profile from database
                loadWholesalerProfile();
            }
        }

        // Load cart from localStorage
        function loadCheckoutCart() {
            const savedCart = localStorage.getItem('wholesaleCart');
            if (savedCart) {
                try {
                    checkoutCart = JSON.parse(savedCart);
                    renderCheckoutCart();
                    calculateOrderTotal();
                } catch (error) {
                    console.error('Error loading cart:', error);
                    showEmptyCart();
                }
            } else {
                showEmptyCart();
            }
        }

        // Show empty cart
        function showEmptyCart() {
            document.getElementById('checkoutCartItems').innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Tu carrito est√° vac√≠o</p>
                    <button onclick="goBackToStore()" class="btn-primary">
                        <i class="fas fa-shopping-cart"></i>
                        Ir a la Tienda
                    </button>
                </div>
            `;
        }

        // Render checkout cart
        function renderCheckoutCart() {
            const container = document.getElementById('checkoutCartItems');

            if (checkoutCart.length === 0) {
                showEmptyCart();
                return;
            }

            container.innerHTML = checkoutCart.map(item => {
                // Handle both old and new cart formats
                const itemPrice = item.price || item.wholesalePrice || 0;
                const itemName = item.name || 'Producto';
                const itemQuantity = item.quantity || 0;
                const itemImage = item.image || '../assets/images/categories/backpacks.jpg';

                return `
                    <div class="checkout-item" style="display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border-color);">
                        <div class="item-image" style="width: 60px; height: 60px; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                            <img src="${itemImage}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='../assets/images/categories/backpacks.jpg'">
                        </div>
                        <div class="item-info" style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">${itemName}</h4>
                            <div class="item-quantity" style="font-size: 12px; color: var(--text-secondary);">Cantidad: ${itemQuantity} pieza${itemQuantity !== 1 ? 's' : ''}</div>
                            <div class="item-pricing" style="margin-top: 5px;">
                                <span class="wholesale-price" style="color: var(--silver-accent); font-weight: 600;">$${itemPrice.toFixed(2)} c/u</span>
                            </div>
                        </div>
                        <div class="item-total" style="font-size: 16px; font-weight: 700; color: var(--silver-accent); text-align: right; flex-shrink: 0;">
                            $${(itemPrice * itemQuantity).toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calculate order total
        function calculateOrderTotal() {
            if (checkoutCart.length === 0) {
                document.getElementById('checkoutSubtotal').textContent = '$0.00';
                document.getElementById('checkoutDiscount').textContent = '-$0.00';
                document.getElementById('checkoutTax').textContent = '$0.00';
                document.getElementById('checkoutTotal').textContent = '$0.00';
                return;
            }

            // The cart already has wholesale prices (item.price is already discounted)
            const subtotal = checkoutCart.reduce((sum, item) => {
                const itemPrice = item.price || item.wholesalePrice || 0;
                return sum + (itemPrice * item.quantity);
            }, 0);

            // No additional discount needed - prices are already wholesale
            const discount = 0;
            const tax = subtotal * TAX_RATE;
            orderTotal = subtotal + tax;

            document.getElementById('checkoutSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('checkoutDiscount').textContent = `Ya aplicado`;
            document.getElementById('checkoutTax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('checkoutTotal').textContent = `$${orderTotal.toFixed(2)}`;
        }

        // Toggle billing address section
        function toggleBillingAddress() {
            const checkbox = document.getElementById('sameAsShipping');
            const billingSection = document.getElementById('billingAddressSection');
            
            if (checkbox.checked) {
                billingSection.style.display = 'none';
            } else {
                billingSection.style.display = 'block';
            }
        }

        // Process order
        async function processOrder() {
            if (checkoutCart.length === 0) {
                alert('Tu carrito est√° vac√≠o');
                return;
            }

            // Validate form
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const processBtn = document.getElementById('processOrderBtn');
            const originalText = processBtn.innerHTML;
            
            try {
                // Disable button and show loading
                processBtn.disabled = true;
                processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando Pedido...';

                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Collect order data
                const orderData = {
                    // Customer info
                    customer: {
                        id: currentUser.id,
                        name: document.getElementById('contactName').value,
                        email: document.getElementById('contactEmail').value,
                        phone: document.getElementById('contactPhone').value,
                        company: document.getElementById('company').value
                    },
                    // Shipping address
                    shipping: {
                        address: document.getElementById('shippingAddress').value,
                        city: document.getElementById('shippingCity').value,
                        state: document.getElementById('shippingState').value,
                        postalCode: document.getElementById('shippingZipcode').value,
                        country: document.getElementById('country').value,
                        notes: document.getElementById('shippingNotes').value
                    },
                    // Billing info
                    billing: {
                        sameAsShipping: document.getElementById('sameAsShipping').checked,
                        rfc: document.getElementById('rfc').value,
                        businessName: document.getElementById('businessName').value
                    },
                    // Order details
                    items: checkoutCart,
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                    orderNotes: document.getElementById('orderNotes').value,
                    // Totals
                    subtotal: checkoutCart.reduce((sum, item) => sum + (item.regularPrice * item.quantity), 0),
                    discount: checkoutCart.reduce((sum, item) => sum + (item.regularPrice * item.quantity), 0) * WHOLESALE_DISCOUNT,
                    tax: (checkoutCart.reduce((sum, item) => sum + (item.wholesalePrice * item.quantity), 0)) * TAX_RATE,
                    total: orderTotal,
                    // Metadata
                    orderDate: new Date().toISOString(),
                    orderNumber: `WS-${new Date().getFullYear()}-${String(Date.now()).slice(-4)}`
                };

                console.log('Order processed:', orderData);

                // Save order to database first
                const orderId = await saveOrderToDatabase(orderData);
                orderData.id = orderId;
                console.log(`‚úÖ Order saved with ID: ${orderId}`);

                // Process inventory deduction
                await processInventoryDeduction(orderData.items);

                // Send email notification to admin
                await sendOrderNotificationEmail(orderData);

                // Show success modal
                showOrderConfirmation(orderData);

                // Clear cart
                localStorage.removeItem('wholesaleCart');
                checkoutCart = [];

            } catch (error) {
                console.error('Order processing error:', error);
                alert('Error procesando el pedido. Por favor intenta nuevamente.');
                
                // Reset button
                processBtn.disabled = false;
                processBtn.innerHTML = originalText;
            }
        }

        // Save order to database
        async function saveOrderToDatabase(orderData) {
            console.log('üíæ Saving order to database...');

            if (!window.supabase) {
                throw new Error('Supabase client not available');
            }

            const supabase = window.supabase;

            try {
                // Prepare order record for database
                const orderRecord = {
                    order_number: orderData.orderNumber,
                    user_id: orderData.customer.id,
                    customer_name: orderData.customer.name,
                    customer_email: orderData.customer.email,
                    customer_phone: orderData.customer.phone,
                    company_name: orderData.customer.company,

                    // Shipping address
                    shipping_address: orderData.shipping.address,
                    shipping_city: orderData.shipping.city,
                    shipping_state: orderData.shipping.state,
                    shipping_postal_code: orderData.shipping.postalCode,
                    shipping_country: orderData.shipping.country,
                    shipping_notes: orderData.shipping.notes,

                    // Billing info
                    billing_rfc: orderData.billing.rfc,
                    billing_business_name: orderData.billing.businessName,

                    // Order items (as JSONB)
                    items: orderData.items,

                    // Totals
                    subtotal: orderData.subtotal,
                    discount_amount: orderData.discount,
                    tax_amount: orderData.tax,
                    total: orderData.total,

                    // Payment & status
                    payment_method: orderData.paymentMethod,
                    order_type: 'wholesale',
                    status: orderData.paymentMethod === 'credit' ? 'pending' : 'processing',

                    // Notes
                    order_notes: orderData.orderNotes
                };

                console.log('üì¶ Order record to insert:', orderRecord);

                // Insert order into database
                const { data, error } = await supabase
                    .from('orders')
                    .insert([orderRecord])
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error saving order to database:', error);
                    throw new Error(`Error guardando pedido: ${error.message}`);
                }

                console.log('‚úÖ Order saved to database with ID:', data.id);
                return data.id;

            } catch (error) {
                console.error('‚ùå Error in saveOrderToDatabase:', error);
                throw error;
            }
        }

        // Process inventory deduction for wholesale orders
        async function processInventoryDeduction(items) {
            console.log('üîÑ Processing mayorista inventory deduction...');

            if (!window.supabase) {
                throw new Error('Supabase client not available');
            }

            const supabase = window.supabase;

            // Process each cart item
            for (const item of items) {
                try {
                    // Extract actual variant ID (handle both numeric and string formats)
                    let actualVariantId = item.variantId || item.id;

                    // If id is in format "660-3", extract the second part
                    if (typeof actualVariantId === 'string' && actualVariantId.includes('-')) {
                        const parts = actualVariantId.split('-');
                        actualVariantId = parseInt(parts[parts.length - 1], 10);
                    }

                    // Convert to number if it's a string
                    actualVariantId = typeof actualVariantId === 'string' ? parseInt(actualVariantId, 10) : actualVariantId;

                    // Skip inventory deduction if variantId is 0 or invalid (product without variants)
                    if (!actualVariantId || actualVariantId === 0 || isNaN(actualVariantId)) {
                        console.log(`‚ö†Ô∏è Skipping inventory for ${item.name} - no valid variant ID (${actualVariantId})`);
                        continue;
                    }

                    console.log(`üîç Processing item: ${item.name}, variantId: ${actualVariantId}`);

                    // Get current stock for the variant
                    const { data: variant, error: fetchError } = await supabase
                        .from('product_variants')
                        .select('stock, variant_name')
                        .eq('id', actualVariantId)
                        .single();

                    if (fetchError) {
                        console.error('‚ùå Error fetching variant stock:', fetchError);
                        console.log(`‚ö†Ô∏è Could not find variant ${actualVariantId} for ${item.name}, skipping inventory deduction`);
                        continue; // Skip this item instead of throwing error
                    }

                    if (!variant) {
                        console.log(`‚ö†Ô∏è Variant not found for ${item.name}, skipping inventory deduction`);
                        continue; // Skip this item instead of throwing error
                    }

                    // Check if we have enough stock
                    if (variant.stock < item.quantity) {
                        throw new Error(`Stock insuficiente para ${item.name}. Stock disponible: ${variant.stock}, solicitado: ${item.quantity}`);
                    }

                    // Calculate new stock
                    const newStock = variant.stock - item.quantity;

                    console.log(`üì¶ [MAYORISTA] Deducting ${item.quantity} from ${variant.variant_name || item.name}: ${variant.stock} ‚Üí ${newStock}`);

                    // Update stock in database
                    const { error: updateError } = await supabase
                        .from('product_variants')
                        .update({ stock: newStock })
                        .eq('id', actualVariantId);

                    if (updateError) {
                        console.error('‚ùå Error updating variant stock:', updateError);
                        throw new Error(`Error actualizando stock de: ${item.name}`);
                    }

                    console.log(`‚úÖ Stock updated successfully for ${item.name}`);

                } catch (itemError) {
                    console.error('‚ùå Error processing mayorista item:', item, itemError);
                    throw itemError;
                }
            }

            console.log('‚úÖ Mayorista inventory deduction completed successfully');
        }

        // Send order notification email
        async function sendOrderNotificationEmail(orderData) {
            try {
                const emailData = {
                    to: 'admin@estudioartesana.com',
                    subject: `Nuevo Pedido Mayorista #${orderData.orderNumber}`,
                    orderNumber: orderData.orderNumber,
                    customer: orderData.customer,
                    items: orderData.items,
                    totals: {
                        subtotal: orderData.subtotal,
                        discount: orderData.discount,
                        tax: orderData.tax,
                        total: orderData.total
                    },
                    shipping: orderData.shipping,
                    billing: orderData.billing,
                    paymentMethod: orderData.paymentMethod,
                    orderNotes: orderData.orderNotes,
                    orderDate: orderData.orderDate
                };

                console.log('üìß Enviando notificaci√≥n de pedido:', emailData);

                const response = await fetch('/api/sendOrderEmail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Email enviado exitosamente:', result);
                
                // Mostrar notificaci√≥n de √©xito
                showNotification('üìß Notificaci√≥n de pedido enviada exitosamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error enviando email:', error);
                
                // Mostrar notificaci√≥n de error pero no bloquear el proceso
                showNotification('‚ö†Ô∏è El pedido se proces√≥ correctamente, pero hubo un problema enviando la notificaci√≥n por email', 'warning');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Agregar estilos si no existen
            if (!document.querySelector('#notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'notification-styles';
                styles.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #fff;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        animation: slideIn 0.3s ease;
                    }
                    .notification.success {
                        border-left: 4px solid #28a745;
                    }
                    .notification.warning {
                        border-left: 4px solid #ffc107;
                    }
                    .notification.error {
                        border-left: 4px solid #dc3545;
                    }
                    .notification-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        font-size: 14px;
                    }
                    .notification-content button {
                        background: none;
                        border: none;
                        font-size: 16px;
                        cursor: pointer;
                        color: #666;
                        padding: 0;
                        margin-left: 10px;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Show order confirmation
        async function showOrderConfirmation(orderData) {
            document.getElementById('orderNumber').textContent = orderData.orderNumber;
            document.getElementById('orderTotal').textContent = `$${orderData.total.toFixed(2)}`;

            const paymentMethods = {
                'transferencia': 'Transferencia bancaria (cr√©dito 30 d√≠as)',
                'efectivo_contra_entrega': 'Efectivo contra entrega'
            };
            document.getElementById('orderPaymentMethod').textContent = paymentMethods[orderData.paymentMethod];

            // Show payment reference and bank info if payment method is transferencia
            if (orderData.paymentMethod === 'transferencia') {
                await displayPaymentReference(orderData);
            } else {
                document.getElementById('paymentReferenceSection').style.display = 'none';
            }

            document.getElementById('confirmationModal').classList.add('show');

            // Update checkout steps
            updateCheckoutStep(3);
        }

        // Display payment reference code and bank info
        async function displayPaymentReference(orderData) {
            try {
                // Get the full order from database to retrieve payment_reference
                const { data: fullOrder, error: orderError } = await supabase
                    .from('orders')
                    .select('payment_reference')
                    .eq('id', orderData.id)
                    .single();

                if (orderError) {
                    console.error('Error fetching order:', orderError);
                } else if (fullOrder && fullOrder.payment_reference) {
                    // Display payment reference code
                    document.getElementById('paymentReferenceCode').textContent = fullOrder.payment_reference;
                }

                // Fetch bank information from payment_config
                const { data: bankConfig, error: bankError } = await supabase
                    .from('payment_config')
                    .select('config_value')
                    .eq('config_key', 'bank_info')
                    .single();

                if (bankError) {
                    console.error('Error fetching bank info:', bankError);
                } else if (bankConfig && bankConfig.config_value) {
                    const bankInfo = bankConfig.config_value;

                    // Populate bank details
                    document.getElementById('bankName').textContent = bankInfo.bank_name || '-';
                    document.getElementById('accountHolder').textContent = bankInfo.account_holder || '-';
                    document.getElementById('accountNumber').textContent = bankInfo.account_number || '-';
                    document.getElementById('clabe').textContent = bankInfo.clabe || '-';
                    document.getElementById('currency').textContent = bankInfo.currency || 'MXN';
                    document.getElementById('referenceInstructions').textContent = bankInfo.reference_instructions || 'Incluye el c√≥digo de referencia en tu transferencia';

                    // Show SWIFT if available
                    if (bankInfo.swift) {
                        document.getElementById('swift').textContent = bankInfo.swift;
                        document.getElementById('swiftRow').style.display = 'block';
                    } else {
                        document.getElementById('swiftRow').style.display = 'none';
                    }
                }

                // Show the payment reference section
                document.getElementById('paymentReferenceSection').style.display = 'block';

            } catch (error) {
                console.error('Error displaying payment reference:', error);
            }
        }

        // Update checkout step
        function updateCheckoutStep(step) {
            const steps = document.querySelectorAll('.checkout-steps .step');
            steps.forEach((stepEl, index) => {
                if (index < step) {
                    stepEl.classList.add('completed');
                }
                if (index === step - 1) {
                    stepEl.classList.add('active');
                }
            });
        }

        // Go back to store
        function goBackToStore() {
            window.location.href = 'tienda.html';
        }

        // Continue shopping
        function continueShopping() {
            document.getElementById('confirmationModal').classList.remove('show');
            window.location.href = 'tienda.html';
        }

        // View my orders
        function viewMyOrders() {
            document.getElementById('confirmationModal').classList.remove('show');
            window.location.href = 'pedidos.html';
        }

        // Initialize checkout
        // Update payment instructions
        function updatePaymentInstructions() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const instructionsDiv = document.getElementById('paymentInstructions');

            if (selectedMethod === 'transferencia') {
                instructionsDiv.innerHTML = `
                    <h4><i class="fas fa-info-circle"></i> Instrucciones para Transferencia</h4>
                    <ul>
                        <li>Realiza tu transferencia a los siguientes datos bancarios:</li>
                    </ul>
                    <div class="bank-info">
                        <p><strong>Banco:</strong> BBVA</p>
                        <p><strong>Cuenta:</strong> 012180015512345678</p>
                        <p><strong>CLABE:</strong> 012180015512345678</p>
                        <p><strong>Beneficiario:</strong> Estudio Artesana SA de CV</p>
                        <p><strong>RFC:</strong> EAR123456789</p>
                    </div>
                    <ul>
                        <li>T√©rminos de pago a 30 d√≠as</li>
                        <li>Env√≠a tu comprobante de pago al correo: pagos@estudioartesana.com</li>
                        <li>Tu pedido ser√° procesado al confirmar el pago</li>
                    </ul>
                `;
            } else if (selectedMethod === 'efectivo_contra_entrega') {
                instructionsDiv.innerHTML = `
                    <h4><i class="fas fa-info-circle"></i> Instrucciones para Pago Contra Entrega</h4>
                    <ul>
                        <li>Prepara el pago en efectivo por el monto total del pedido</li>
                        <li>El pago se realizar√° al momento de recibir tu pedido</li>
                        <li>Te contactaremos para coordinar la entrega</li>
                        <li>Por favor ten el monto exacto disponible</li>
                        <li>Recibir√°s un comprobante de pago al momento de la entrega</li>
                    </ul>
                `;
            }

            instructionsDiv.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõí Checkout mayoristas inicializado');

            // Initialize Supabase first
            initializeSupabase();

            if (!checkCheckoutAuth()) return;

            loadCheckoutCart();
            
            // Setup form interactions
            document.getElementById('sameAsShipping').addEventListener('change', toggleBillingAddress);
            
            // Setup payment method instructions
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', updatePaymentInstructions);
            });
            
            // Show initial payment instructions
            updatePaymentInstructions();
            
            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
            
            // Handle P√∫blico en General toggle
            document.getElementById('publicoGeneral').addEventListener('change', function() {
                const rfcInput = document.getElementById('rfc');
                const businessNameInput = document.getElementById('businessName');
                const rfcFieldsSection = document.getElementById('rfcFieldsSection');

                if (this.checked) {
                    // Use P√∫blico en General RFC
                    rfcInput.value = 'XAXX010101000';
                    businessNameInput.value = 'P√öBLICO EN GENERAL';
                    rfcInput.disabled = true;
                    businessNameInput.disabled = true;
                    rfcFieldsSection.style.opacity = '0.6';
                } else {
                    // Enable custom RFC
                    rfcInput.value = '';
                    businessNameInput.value = '';
                    rfcInput.disabled = false;
                    businessNameInput.disabled = false;
                    rfcFieldsSection.style.opacity = '1';
                }
            });

            // Auto-uppercase RFC
            document.getElementById('rfc').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            // Format phone number
            document.getElementById('contactPhone').addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 10) {
                        value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3').trim();
                    } else {
                        value = '+' + value.substring(0, 2) + ' ' + value.substring(2, 5) + ' ' + 
                               value.substring(5, 8) + ' ' + value.substring(8, 12);
                    }
                }
                this.value = value;
            });
        });
    </script>

    <!-- Universal Mayorista Navbar (must load before auth-guard) -->
    <script src="mayoristas-navbar.js"></script>

    <!-- Initialize Navbar first -->
    <script>
        if (window.initMayoristaNavbar && window.detectActivePage) {
            const activePage = window.detectActivePage();
            if (activePage) {
                window.initMayoristaNavbar(activePage);
                console.log('‚úÖ Navbar initialized for page:', activePage);
            }
        }
    </script>

    <!-- Mayoristas Authentication Guard -->
    <script src="mayoristas-auth-guard.js"></script>

    <!-- Initialize Auth Guard after navbar -->
    <script>
        if (window.MayoristasAuthGuard) {
            window.MayoristasAuthGuard.initialize();
        }
    </script>
</body>
</html>
